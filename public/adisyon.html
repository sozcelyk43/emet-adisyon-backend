<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMET LEZZET GÜNLERİ ADİSYON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    

<style>
    body {
        font-family: 'Inter', sans-serif;
        overscroll-behavior-y: contain; /* Mobil dikey kaydırmada sayfa yenilemeyi engelle */
    }
    .modal {
        display: none;
        animation: fadeIn 0.3s ease-out;
    }
    .modal.active {
        display: flex;
    }
    /* Başlangıçta tüm modallar ve sipariş sayfası gizli */
    #orderPageContainer, #quickSaleModal, #addProductToMenuModal, #editProductModal,
    #manageTablesModal, #manageWaitersModal, #confirmDeleteTableModal,
    #confirmDeleteWaiterModal, #confirmExitAppModal, #salesReportModal,
    #activityLogModal, #receiptModal, #confirmCloseTableModal, #confirmDiscountModal {
        display: none;
    }
    /* Aktif olan modal veya sayfa için */
    #orderPageContainer.active,
    #quickSaleModal.active,
    #addProductToMenuModal.active,
    #editProductModal.active,
    #manageTablesModal.active,
    #manageWaitersModal.active,
    #confirmDeleteTableModal.active,
    #confirmDeleteWaiterModal.active,
    #confirmExitAppModal.active,
    #salesReportModal.active,
    #activityLogModal.active,
    #receiptModal.active,
    #confirmCloseTableModal.active,
    #confirmDiscountModal.active {
        display: block; /* Veya flex/grid, içeriğe göre */
    }

    /* Modal arkaplan ve ortalama stilleri (genel modallar için) */
    #addProductToMenuModal.active,
    #editProductModal.active,
    #manageTablesModal.active,
    #manageWaitersModal.active,
    #confirmDeleteTableModal.active,
    #confirmDeleteWaiterModal.active,
    #confirmExitAppModal.active,
    #salesReportModal.active,
    #activityLogModal.active,
    #receiptModal.active,
    #confirmCloseTableModal.active,
    #confirmDiscountModal.active {
        position: fixed;
        inset: 0;
        background-color: rgba(0,0,0,0.75);
        align-items: center;
        justify-content: center;
        z-index: 50;
        padding: 1rem;
        display: flex; /* Ortalamak için flex kullan */
    }
    /* Hızlı satış modalı için özel (daha geniş olabilir) */
    #quickSaleModal.active {
         position: fixed;
         inset: 0;
         background-color: rgba(0,0,0,0.75);
         align-items: center;
         justify-content: center;
         z-index: 50;
         padding: 1rem;
         display: flex;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    #loadingOverlay {
        display: none; /* Başlangıçta gizli */
    }
    #loadingOverlay.active {
        display: flex; /* Aktif olduğunda göster */
        position: fixed;
        inset: 0;
        background-color: rgba(0,0,0,0.75); /* Arkaplanı karart */
        align-items: center;
        justify-content: center;
        z-index: 100; /* Diğer her şeyin üzerinde */
    }

    /* Ürün Kartı Miktarı */
    .product-card-quantity input {
        width: 40px;
        text-align: center;
        border: 1px solid #d1d5db; /* Tailwind gray-300 */
        padding-top: 0.1rem;
        padding-bottom: 0.1rem;
    }
     .product-card-quantity button {
         min-width: 24px;
         height: 24px;
         display: inline-flex;
         align-items: center;
         justify-content: center;
     }

    /* Kategori Alanı Renkleri */
    .category-section-bg-ET-TAVUK { background-color: #fee2e2; }
    .category-section-bg-ATIŞTIRMALIK { background-color: #ffedd5; }
    .category-section-bg-TATLI { background-color: #fce7f3; }
    .category-section-bg-İÇECEK { background-color: #eff6ff; }
    .category-section-bg-ÇORBA { background-color: #fef9c3; }
    .category-section-bg-DİĞER { background-color: #dcfce7; }
    .category-section-bg-default { background-color: #f3f4f6; } /* Varsayılan kategori rengi */

    /* Ürün Kartı Renkleri (Kategorinin daha koyu tonu) */
    .product-card-bg-ET-TAVUK { background-color: #fecaca; }
    .product-card-bg-ATIŞTIRMALIK { background-color: #fed7aa; }
    .product-card-bg-TATLI { background-color: #fbcfe8; }
    .product-card-bg-İÇECEK { background-color: #dbeafe; }
    .product-card-bg-ÇORBA { background-color: #fef08a; }
    .product-card-bg-DİĞER { background-color: #bbf7d0; }
    .product-card-bg-default { background-color: #e5e7eb; } /* Varsayılan ürün kartı rengi */

    /* Ürün Kartı Görünümü */
    .product-card {
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        padding: 0.75rem;
        transition: transform 0.2s ease-in-out;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 120px; /* Normal ürün kartları için */
    }
     .product-card.quick-sale-card { /* Hızlı satış ürün kartları için daha kompakt */
        min-height: 80px;
        padding: 0.5rem;
        justify-content: center; /* İçeriği ortala */
    }
    .product-card:hover {
        transform: translateY(-2px);
    }
    .product-card h5 { /* Ürün adı */
         font-weight: 600;
         color: #1f2937; /* Tailwind gray-800 */
         margin-bottom: 0.25rem;
         font-size: 0.875rem; /* 14px */
    }
     .product-card.quick-sale-card h5 { /* Hızlı satış ürün adı */
         font-size: 0.9rem; /* Biraz daha büyük */
         text-align: center;
         margin-bottom: 0.5rem;
         line-height: 1.2;
         min-height: 2.4em; /* Yaklaşık 2 satır sığdırmak için */
         display: -webkit-box; /* Çok satırlı metin kesme için */
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
     }
     .product-card p.product-price { /* Ürün fiyatı */
         color: #4b5563; /* Tailwind gray-600 */
         font-size: 0.8rem;
         margin-bottom: 0.5rem;
     }
     .product-card .description-input { /* Açıklama inputu */
         margin-top: 0.5rem;
         margin-bottom: 0.5rem;
         background-color: #fff; /* Beyaz arka plan */
     }
     .product-card .add-item-from-card-btn { /* "Ekle" butonu */
         margin-top: auto; /* Kartın en altına iter */
     }
     .product-card.quick-sale-card .add-item-from-card-btn { /* Hızlı satış "Ekle" butonu */
         padding-top: 0.75rem;
         padding-bottom: 0.75rem;
         font-size: 1rem;
         font-weight: bold;
     }

    /* Login Modalı Aktif Kullanıcı Durum Göstergeleri */
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 4px;
        vertical-align: middle;
    }
    .status-indicator.active {
        background-color: #34D399; /* Tailwind green-400 */
    }
    .status-indicator.inactive {
        background-color: #F87171; /* Tailwind red-400 */
    }
    .user-status-item {
        display: inline-flex; /* İkon ve ismi yan yana getirmek için */
        align-items: center; /* Dikeyde ortalamak için */
        padding: 2px 4px;
        font-size: 0.7rem; /* Daha küçük yazı tipi */
        line-height: 1;
    }

    .no-print { /* Yazdırma sırasında gizlenecek elementler için */
        display: revert !important; /* Normalde görünsün */
    }

    /* Yazdırma stilleri */
    @media print {
        body * {
            visibility: hidden; /* Önce her şeyi gizle */
        }
        .no-print {
            display: none !important; /* Yazdırma sırasında kesinlikle gizle */
        }

        /* Fiş yazdırma */
        #receiptModalContent, #receiptModalContent * {
            visibility: visible; /* Sadece fiş içeriğini görünür yap */
        }
        #receiptModalContent {
            position: absolute;
            left: 0;
            top: 0;
            width: 100mm; /* Termal yazıcı genişliği */
            font-size: 9pt;
            padding: 4mm;
            box-sizing: border-box;
            border: 1px solid #ccc; /* Görünürlük için kenarlık */
        }
        #receiptModalContent h2 { font-size: 11pt; font-weight: bold; margin-bottom: 3mm; text-align: center; }
        #receiptModalContent p, #receiptModalContent div#receiptItems > div { line-height: 1.3; margin-bottom: 1mm; }
        #receiptModalContent div#receiptItems > div { display: flex; justify-content: space-between; flex-wrap: wrap; }
        #receiptModalContent div#receiptItems span.item-details { flex-basis: 70%; }
        #receiptModalContent div#receiptItems span.item-price { flex-basis: 30%; text-align: right; }
        #receiptModalContent div#receiptItems span.item-description,
        #receiptModalContent div#receiptItems span.item-waiter {
            display: block; font-size: 7pt; padding-left: 5mm; color: #555; flex-basis: 100%;
        }
        #receiptModalContent .discount-info { font-weight: bold; color: #dc2626; /* red-600 */ }
        #receiptModalContent hr { margin-top: 2mm; margin-bottom: 2mm; border-top: 1px dashed #999; }
        #receiptModalContent .text-right p#receiptTotalLine { font-size: 10pt; font-weight: bold; }
        #receiptModalContent p.thank-you-note { margin-top: 4mm; text-align: center; font-size: 8pt; }

         /* Satış Raporu yazdırma (A4 dikey) */
        #salesReportModalContent, #salesReportModalContent * {
             visibility: visible; /* Sadece satış raporu içeriğini görünür yap */
        }
         #salesReportModalContent {
             position: absolute;
             left: 0;
             top: 0;
             width: 100%; /* A4 genişliği */
             font-size: 10pt;
             padding: 10mm;
             box-sizing: border-box;
         }
         #salesReportModalContent table {
             width: 100%;
             border-collapse: collapse;
         }
         #salesReportModalContent th, #salesReportModalContent td {
             border: 1px solid #ccc;
             padding: 2mm;
             text-align: left;
         }
         #salesReportModalContent th {
             background-color: #eee;
         }
         /* Aktivite Logları yazdırma (Satış raporuna benzer) */
        #activityLogModalContent, #activityLogModalContent * {
             visibility: visible;
        }
         #activityLogModalContent {
             position: absolute; left: 0; top: 0; width: 100%; font-size: 10pt;
             padding: 10mm; box-sizing: border-box;
         }
         #activityLogModalContent table { width: 100%; border-collapse: collapse; }
         #activityLogModalContent th, #activityLogModalContent td {
             border: 1px solid #ccc; padding: 2mm; text-align: left;
         }
         #activityLogModalContent th { background-color: #eee; }
    }
</style>

</head>
<body class="bg-gray-100 text-gray-800">

<div id="loadingOverlay" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
        <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loadingMessage" class="text-lg font-medium text-gray-700">Bağlanılıyor...</p>
    </div>
</div>

<div id="loginModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50 active">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-2xl font-semibold mb-6 text-center text-blue-600">Kullanıcı Girişi</h2>
        <p class="text-sm text-gray-500 text-center mb-4">Garson veya Kasa olarak giriş yapın.</p>

        <input type="text" id="usernameInput" placeholder="Kullanıcı Adı" class="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <input type="password" id="passwordInput" placeholder="Şifre" class="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">

        <div class="mb-6 text-xs text-gray-600">
            <p class="font-semibold mb-1 text-center text-gray-700">Aktif Kullanıcı Durumları:</p>
            <div id="cashierStatusContainer" class="mb-2">
                <p class="text-sm font-medium text-center text-blue-600">Kasa Hesapları</p>
                <div id="cashierStatusList" class="flex flex-wrap justify-center gap-x-3 gap-y-1">
                    </div>
            </div>
            <div id="waiterStatusContainer">
                <p class="text-sm font-medium text-center text-green-600">Garson Hesapları</p>
                <div id="waiterStatusList" class="flex flex-wrap justify-center gap-x-3 gap-y-1">
                    </div>
            </div>
        </div>
        <button id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded-md transition duration-150">Giriş Yap</button>
        <p id="loginError" class="text-red-500 text-sm mt-2 text-center"></p>
    </div>
</div>

<div id="appContainer" class="container mx-auto p-4 md:p-8 hidden">
    <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
        <div>
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700">EMET LEZZET GÜNLERİ ADİSYON</h1>
            <p class="text-gray-600 mt-1">Aktif Kullanıcı: <span id="activeUserName" class="font-semibold"></span> (<span id="activeUserRole" class="capitalize"></span>)</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <button id="manageWaitersButton" class="bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Garson Yönetimi</button>
            <button id="manageTablesButton" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Masalar Yönetimi</button>
            <button id="editProductMenuButton" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Ürün Düzenleme</button>
            <button id="addProductToMenuButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Menüye Ürün Ekle</button>
            <button id="salesReportButton" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Satış Raporlama</button>
            <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Uygulamadan Çık</button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <main class="md:col-span-2">
            <section id="tablesSection" class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Masalar</h2>
                </div>
                <div id="quickSaleButtonContainerTop" class="mb-6 hidden">
                    <button id="quickSaleEntryButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-6 rounded-xl shadow-lg text-2xl transition duration-150 transform hover:scale-105">
                        HIZLI SATIŞ
                    </button>
                </div>
                <div id="tablesGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                </div>
            </section>
        </main>
        <aside class="md:col-span-1">
            <section id="productsReferenceSection" class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Güncel Menü</h2>
                <div class="bg-white p-6 rounded-lg shadow max-h-[70vh] overflow-y-auto">
                    <div id="productsListRef">
                    </div>
                </div>
            </section>
        </aside>
    </div>
</div>

<div id="orderPageContainer" class="container mx-auto p-4 md:p-8">
    <header class="mb-6 flex flex-wrap justify-between items-center">
        <div class="w-full md:w-auto mb-2 md:mb-0">
            <h2 class="text-3xl font-semibold text-blue-700">Sipariş: <span id="orderPageTableName"></span></h2>
            <p id="orderPageWaiterInfo" class="text-sm text-gray-600 mt-1">Bu Masaya Henüz Sipariş Alınmadı</p>
        </div>
        <button id="backToTablesButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Masalara Dön</button>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <section class="lg:col-span-2 bg-white p-6 rounded-lg shadow">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Ürün Seçimi</h3>
            <div id="orderPageProductGrid" class="space-y-6 max-h-[75vh] overflow-y-auto pr-2">
            </div>

            <div id="manualProductSection" class="mt-6 pt-6 border-t border-gray-200 hidden">
                <h3 class="text-lg font-semibold mb-3 text-orange-600">Manuel Ürün Ekle (Sadece Kasa - Bu siparişe özel)</h3>
                <div class="space-y-3">
                    <input type="text" id="manualProductName" placeholder="Ürün Adı" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <div>
                        <label for="manualProductCategory" class="block text-sm font-medium text-gray-600 mb-1">Kategori:</label>
                        <select id="manualProductCategory" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                            <option value="">Kategori Seçin</option>
                        </select>
                    </div>
                    <input type="number" id="manualProductPrice" placeholder="Fiyat (₺)" step="0.01" min="0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <input type="number" id="manualProductQuantity" placeholder="Adet" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <input type="text" id="manualProductDescription" placeholder="Açıklama (isteğe bağlı)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <button id="addManualProductButton" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold p-2 rounded-md transition duration-150">Manuel Ürünü Siparişe Ekle</button>
                </div>
            </div>
        </section>

        <section class="lg:col-span-1 bg-white p-6 rounded-lg shadow">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Mevcut Sipariş</h3>
            <div id="orderPageCurrentOrderItems" class="space-y-3 max-h-[75vh] overflow-y-auto pr-2">
            </div>
            <div id="orderPageCurrentOrderTotal" class="text-right font-bold text-2xl mt-6 text-gray-800">
                Toplam: 0 ₺
            </div>
            <div id="discountInfo" class="text-right text-sm text-red-600 mt-1 hidden"></div>
            <div class="mt-6 space-y-3">
                <button id="applyDiscountButton" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold p-3 rounded-md transition duration-150 hidden">Personel İndirimi (%30)</button>
                <button id="showReceiptButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md transition duration-150">Fiş Göster/Yazdır</button>
                <button id="finalizeAndCloseTableButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold p-3 rounded-md transition duration-150 hidden">Masayı Kapat ve Hesabı Tamamla</button>
            </div>
        </section>
    </div>
</div>

<div id="quickSaleModal" class="modal">
    <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl w-full max-w-7xl max-h-[95vh] flex flex-col">
        <header class="mb-4 flex justify-between items-center">
            <h2 class="text-2xl font-semibold text-green-700">Hızlı Satış</h2>
            <button id="closeQuickSaleModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-grow overflow-hidden">
            <section class="md:col-span-2 bg-gray-50 p-3 rounded-lg shadow-inner overflow-y-auto max-h-[calc(95vh-150px)]">
                <h3 class="text-lg font-semibold mb-3 text-gray-700">Ürün Seçimi</h3>
                <div id="quickSaleProductGrid" class="space-y-4">
                </div>
            </section>
            <section class="md:col-span-1 bg-gray-50 p-3 rounded-lg shadow-inner flex flex-col max-h-[calc(95vh-150px)]">
                <h3 class="text-lg font-semibold mb-3 text-gray-700">Hızlı Satış Sepeti</h3>
                <div id="quickSaleCurrentItems" class="space-y-2 flex-grow overflow-y-auto">
                    <p class="text-gray-500 text-center py-4">Sepet boş.</p>
                </div>
                <div id="quickSaleTotal" class="text-right font-bold text-xl mt-4 pt-2 border-t">
                    Toplam: 0 ₺
                </div>
                <div id="quickSaleDiscountInfo" class="text-right text-sm text-red-600 mt-1 hidden"></div>
                <div class="mt-4 space-y-2">
                    <button id="applyQuickSaleDiscountButton" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold p-2 rounded-md transition duration-150">Personel İndirimi (%30)</button>
                    <div class="my-2"><label for="quickSaleCustomerName" class="block text-sm font-medium text-gray-700 mb-1">Müşteri Adı (Fiş için):</label> <input type="text" id="quickSaleCustomerName" placeholder="Müşteri Adı (isteğe bağlı)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500"></div>
                    <button id="completeQuickSaleButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold p-3 rounded-md transition duration-150">Satışı Tamamla ve Fiş Kes</button>
                </div>
            </section>
        </div>
    </div>
</div>


<div id="receiptModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
    <div id="receiptModalContent" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
        <div class="flex-grow overflow-y-auto">
            <h2 class="text-2xl font-bold text-center mb-2 text-gray-800">EMET LEZZET GÜNLERİ</h2>
            <p class="text-center text-sm text-gray-600 mb-1">Fiş/Adisyon</p>
            <p class="text-center text-sm text-gray-600 mb-4">Tarih: <span id="receiptDate"></span></p>
            <div class="mb-2">
                <p class="text-sm"><span class="font-semibold">Masa:</span> <span id="receiptTableName"></span></p>
                <p class="text-sm"><span class="font-semibold">Garson/Kasa:</span> <span id="receiptWaiterName">Bilinmiyor</span></p>
            </div>
            <hr class="my-2 border-gray-300">
            <div id="receiptItems" class="text-sm space-y-1 mb-2">
            </div>
            <div id="receiptDiscountInfo" class="text-sm my-2 hidden">
                <hr class="my-1 border-gray-300">
                <div class="flex justify-between">
                    <span>Ara Toplam:</span>
                    <span id="receiptSubtotal">0 ₺</span>
                </div>
                <div class="flex justify-between text-red-600">
                    <span>Personel İndirimi (%30):</span>
                    <span>-<span id="receiptDiscountAmount">0 ₺</span></span>
                </div>
            </div>
            <hr class="my-2 border-dashed border-gray-400">
            <div class="text-right">
                <p id="receiptTotalLine" class="text-lg font-bold text-gray-800">GENEL TOPLAM: <span id="receiptGrandTotal"></span> ₺</p>
            </div>
            <p class="thank-you-note text-center text-xs text-gray-500 mt-6">Teşekkür Ederiz!</p>
        </div>
        <div class="mt-auto pt-4 flex space-x-2">
            <button id="printReceiptButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md transition duration-150">Yazdır</button>
            <button id="closeReceiptModalOnlyButton" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold p-3 rounded-md transition duration-150">Kapat</button>
        </div>
    </div>
</div>

<div id="confirmCloseTableModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Masayı Kapat Onayı</h2>
        <p class="text-gray-600 mb-6">Masayı kapatmak ve hesabı tamamlamak istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
        <div class="flex justify-center gap-4">
            <button id="confirmCloseTableYesButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-md transition duration-150">Evet, Kapat</button>
            <button id="confirmCloseTableNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md transition duration-150">Hayır, Vazgeç</button>
        </div>
    </div>
</div>

<div id="confirmDiscountModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
        <h2 class="text-xl font-semibold mb-4 text-yellow-600">Personel İndirimi</h2>
        <p class="text-gray-600 mb-6">%30 personel indirimi uygulansın mı?</p>
        <div class="flex justify-center gap-4">
            <button id="confirmDiscountYesButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-md transition duration-150">Evet, Uygula</button>
            <button id="confirmDiscountNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md transition duration-150">Hayır, Vazgeç</button>
        </div>
    </div>
</div>

<div id="addProductToMenuModal" class="modal">
    <div class="modal-content">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-indigo-600">Menüye Yeni Ürün Ekle</h2>
                <button id="closeAddProductToMenuModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <input type="text" id="newProductName" placeholder="Ürün Adı (örn: Zerde KG)" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
                <input type="number" id="newProductPrice" placeholder="Fiyat (₺)" step="0.01" min="0" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
                <div>
                    <label for="newProductCategory" class="block text-sm font-medium text-gray-600 mb-1">Kategori:</label>
                    <select id="newProductCategory" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
                        <option value="">Mevcut Kategori Seçin</option>
                        {/* Kategoriler JavaScript ile doldurulacak */}
                    </select>
                </div>
                <input type="text" id="newProductCategoryInput" placeholder="Veya Yeni Kategori Adı Girin" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 mt-2 hidden">
                <button id="saveNewProductButton" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold p-3 rounded-md transition duration-150">Menüye Kaydet</button>
            </div>
        </div>
    </div>
</div>

<div id="editProductModal" class="modal">
    <div class="modal-content">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-purple-600">Ürün Düzenle</h2>
                <button id="closeEditProductModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="editProductSelectionDiv" class="space-y-4">
                <label for="selectProductToEdit" class="block text-sm font-medium text-gray-700">Düzenlenecek Ürünü Seçin:</label>
                <select id="selectProductToEdit" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                    <option value="">-- Ürün Seçin --</option>
                    {/* Ürünler JavaScript ile doldurulacak */}
                </select>
            </div>
            <div id="editProductFormDiv" class="space-y-4 mt-4 hidden">
                <input type="hidden" id="editingProductId">
                <div>
                    <label for="editProductName" class="block text-sm font-medium text-gray-700">Ürün Adı:</label>
                    <input type="text" id="editProductName" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="editProductPrice" class="block text-sm font-medium text-gray-700">Fiyat (₺):</label>
                    <input type="number" id="editProductPrice" step="0.01" min="0" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="editProductCategory" class="block text-sm font-medium text-gray-700">Kategori:</label>
                    <select id="editProductCategory" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                        <option value="">Mevcut Kategori Seçin</option>
                        {/* Kategoriler JavaScript ile doldurulacak */}
                    </select>
                </div>
                <input type="text" id="editProductCategoryInput" placeholder="Veya Yeni Kategori Adı Girin" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 mt-2 hidden">
                <button id="saveEditedProductButton" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold p-3 rounded-md transition duration-150">Değişiklikleri Kaydet</button>
            </div>
        </div>
    </div>
</div>

<div id="manageTablesModal" class="modal">
    <div class="modal-content">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-orange-600">Masalar Yönetimi</h2>
                <button id="closeManageTablesModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                    <h3 class="text-lg font-medium text-gray-700">Yeni Masa Ekle</h3>
                    <input type="text" id="newTableNameInput" placeholder="Yeni Masa Adı (örn: Bahçe 1)" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <button id="addNewTableButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md transition duration-150">Yeni Masa Ekle</button>
                </div>
                <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                    <h3 class="text-lg font-medium text-gray-700">Masa Adı Düzenle</h3>
                    <select id="selectTableToEditName" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                        <option value="">Düzenlenecek Masayı Seçin</option>
                    </select>
                    <input type="text" id="editTableNameInput" placeholder="Yeni Masa Adı" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <button id="updateTableNameButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md transition duration-150">Adı Güncelle</button>
                </div>
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-700">Masa Sil</h3>
                    <select id="selectTableToDelete" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                        <option value="">Silinecek Masayı Seçin</option>
                    </select>
                    <button id="deleteTableButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold p-3 rounded-md transition duration-150">Masayı Sil</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="confirmDeleteTableModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
    <div class="modal-content">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-semibold mb-4 text-red-600">Masayı Sil Onayı</h2>
            <p class="text-gray-600 mb-6">"<span id="tableNameToDeleteSpan"></span>" adlı masayı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz ve masadaki aktif siparişler (eğer varsa) kaybolacaktır.</p>
            <div class="flex justify-center gap-4">
                <button id="confirmDeleteTableYesButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-md transition duration-150">Evet, Sil</button>
                <button id="confirmDeleteTableNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md transition duration-150">Hayır, Vazgeç</button>
            </div>
        </div>
    </div>
</div>

<div id="manageWaitersModal" class="modal">
    <div class="modal-content">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-pink-600">Garson Yönetimi</h2>
                <button id="closeManageWaitersModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                    <h3 class="text-lg font-medium text-gray-700">Yeni Garson Ekle</h3>
                    <input type="text" id="newWaiterUsernameInput" placeholder="Garson Kullanıcı Adı" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500">
                    <input type="password" id="newWaiterPasswordInput" placeholder="Garson Şifresi" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500">
                    <button id="addNewWaiterButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md transition duration-150">Yeni Garson Ekle</button>
                </div>
                <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                    <h3 class="text-lg font-medium text-gray-700">Garson Şifresi Düzenle</h3>
                    <select id="selectWaiterToEditPassword" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500">
                        <option value="">Düzenlenecek Garsonu Seçin</option>
                    </select>
                    <input type="password" id="editWaiterPasswordInput" placeholder="Yeni Şifre" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500">
                    <button id="updateWaiterPasswordButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md transition duration-150">Şifreyi Güncelle</button>
                </div>
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-700">Garson Sil</h3>
                    <select id="selectWaiterToDelete" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500">
                        <option value="">Silinecek Garsonu Seçin</option>
                    </select>
                    <button id="deleteWaiterButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold p-3 rounded-md transition duration-150">Garsonu Sil</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="confirmDeleteWaiterModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
    <div class="modal-content">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-semibold mb-4 text-red-600">Garsonu Sil Onayı</h2>
            <p class="text-gray-600 mb-6">"<span id="waiterNameToDeleteSpan"></span>" adlı garsonu silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
            <div class="flex justify-center gap-4">
                <button id="confirmDeleteWaiterYesButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-md transition duration-150">Evet, Sil</button>
                <button id="confirmDeleteWaiterNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md transition duration-150">Hayır, Vazgeç</button>
            </div>
        </div>
    </div>
</div>

<div id="confirmExitAppModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
    <div class="modal-content">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-semibold mb-4 text-red-600">Uygulamadan Çık</h2>
            <p class="text-gray-600 mb-6">Uygulamadan çıkmak istediğinize emin misiniz?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmExitAppYesButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-md transition duration-150">Evet, Çık</button>
                <button id="confirmExitAppNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md transition duration-150">Hayır, Kal</button>
            </div>
        </div>
    </div>
</div>


<div id="salesReportModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
    <div id="salesReportModalContent" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold text-teal-700">Satış Raporu</h2>
            <button id="closeSalesReportModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="flex-grow overflow-y-auto mb-4">
            <div id="salesReportTableContainer">
                <p class="text-center text-gray-500">Rapor yükleniyor veya hiç satış yok...</p>
            </div>
            <div id="salesReportSummary" class="mt-4 pt-4 border-t text-right">
                <p class="font-semibold">Toplam Satış Adedi: <span id="totalItemsSold">0</span></p>
                <p class="font-bold text-xl">Genel Toplam: <span id="grandTotalSales">0 ₺</span></p>
            </div>
        </div>
        <div class="mt-auto pt-4 flex space-x-2">
            <button id="refreshSalesReportButton" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md transition duration-150">Yenile</button>
            <button id="printSalesReportButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md transition duration-150">Raporu Yazdır</button>
        </div>
    </div>
</div>


<script>
    // *** YEREL TEST İÇİN URL ***
    // Render'a yüklerken burayı 'wss://<UYGULAMA_ADINIZ>.onrender.com' olarak değiştirin.
    const WEBSOCKET_URL = 'wss://emet-adisyon.onrender.com';
    let socket;

    // adisyon.html içindeki <script> bloğunda, appState tanımı:

const appState = {
    user: null,
    products: [ // Sunucudaki en son menü ile senkronize edildi
        // ÇORBA
        { id: 1001, name: "KELLE PAÇA ÇORBA", price: 60.00, category: "ÇORBA" },
        { id: 1002, name: "TARHANA ÇORBA", price: 50.00, category: "ÇORBA" },
        // ET - TAVUK
        { id: 1003, name: "YAPRAK D. EKMEK ARASI", price: 200.00, category: "ET - TAVUK" },
        { id: 1005, name: "ET DÖNER EKMEK ARASI", price: 150.00, category: "ET - TAVUK" },
        { id: 1006, name: "ET DÖNER PORSİYON", price: 175.00, category: "ET - TAVUK" },
        { id: 1007, name: "TAVUK DÖNER EKMEK ARASI", price: 130.00, category: "ET - TAVUK" },
        { id: 1008, name: "TAVUK DÖNER PORSİYON", price: 150.00, category: "ET - TAVUK" },
        { id: 1009, name: "KÖFTE EKMEK", price: 130.00, category: "ET - TAVUK" },
        { id: 1010, name: "KÖFTE PORSİYON", price: 150.00, category: "ET - TAVUK" },
        { id: 1011, name: "KUZU ŞİŞ", price: 150.00, category: "ET - TAVUK" },
        { id: 1012, name: "ADANA ŞİŞ", price: 150.00, category: "ET - TAVUK" },
        { id: 1013, name: "PİRZOLA - 4 ADET", price: 250.00, category: "ET - TAVUK" },
        { id: 1014, name: "TAVUK FAJİTA", price: 200.00, category: "ET - TAVUK" },
        { id: 1015, name: "TAVUK (PİLİÇ) ÇEVİRME", price: 250.00, category: "ET - TAVUK" },
        { id: 1016, name: "ET DÖNER - KG", price: 1300.00, category: "ET - TAVUK" },
        { id: 1017, name: "ET DÖNER - 500 GR", price: 650.00, category: "ET - TAVUK" },
        { id: 1018, name: "TAVUK DÖNER - KG", price: 800.00, category: "ET - TAVUK" },
        { id: 1019, name: "TAVUK DÖNER - 500 GR", price: 400.00, category: "ET - TAVUK" },
        { id: 1002, name: "YAPRAK D. PORS.", price: 250.00, category: "ET - TAVUK" },
        // ATIŞTIRMALIK
        { id: 1020, name: "AYVALIK TOSTU", price: 120.00, category: "ATIŞTIRMALIK" },
        { id: 1021, name: "HAMBURGER", price: 150.00, category: "ATIŞTIRMALIK" },
        { id: 1022, name: "BALIK BURGER", price: 150.00, category: "ATIŞTIRMALIK" },
        { id: 1023, name: "PİDE ÇEŞİTLERİ", price: 120.00, category: "ATIŞTIRMALIK" },
        { id: 1024, name: "PİZZA KARIŞIK (ORTA BOY)", price: 150.00, category: "ATIŞTIRMALIK" },
        { id: 1025, name: "PİZZA KARIŞIK (BÜYÜK BOY)", price: 200.00, category: "ATIŞTIRMALIK" },
        { id: 1026, name: "LAHMACUN", price: 75.00, category: "ATIŞTIRMALIK" },
        { id: 1027, name: "ÇİĞ KÖFTE KG (MARUL-LİMON)", price: 300.00, category: "ATIŞTIRMALIK" },
        { id: 1028, name: "YAĞLI GÖZLEME", price: 50.00, category: "ATIŞTIRMALIK" },
        { id: 1029, name: "İÇLİ GÖZLEME", price: 60.00, category: "ATIŞTIRMALIK" },
        // İÇECEK
        { id: 1030, name: "OSMANLI ŞERBETİ - 1 LT", price: 75.00, category: "İÇECEK" },
        { id: 1031, name: "LİMONATA - 1 LT", price: 75.00, category: "İÇECEK" },
        { id: 1032, name: "AYRAN", price: 10.00, category: "İÇECEK" },
        { id: 1033, name: "SU", price: 10.00, category: "İÇECEK" },
        { id: 1034, name: "ÇAY", price: 10.00, category: "İÇECEK" },
        { id: 1035, name: "SOĞUK ÇAY ÇEŞİTLERİ", price: 25.00, category: "İÇECEK" },
        { id: 1036, name: "TAMEK MEYVE SUYU", price: 25.00, category: "İÇECEK" },
        { id: 1037, name: "MEYVELİ MADEN SUYU", price: 25.00, category: "İÇECEK" },
        { id: 1038, name: "NİĞDE GAZOZU", price: 25.00, category: "İÇECEK" },
        { id: 1039, name: "ŞALGAM", price: 25.00, category: "İÇECEK" },
        { id: 1040, name: "SADE MADEN SUYU", price: 15.00, category: "İÇECEK" },
        { id: 1041, name: "TROPİKAL - ÇİLEK KOKUSU", price: 75.00, category: "İÇECEK" },
        { id: 1042, name: "TROPİKAL - KARPUZELLA", price: 75.00, category: "İÇECEK" },
        { id: 1043, name: "TROPİKAL - NAR-I ŞAHANE", price: 75.00, category: "İÇECEK" },
        { id: 1044, name: "TROPİKAL - MAVİ TURUNÇ", price: 75.00, category: "İÇECEK" },
        { id: 1045, name: "TROPİKAL - ELMA RÜYASI", price: 75.00, category: "İÇECEK" },
        // TATLI
        { id: 1046, name: "EV BAKLAVASI - KG", price: 400.00, category: "TATLI" },
        { id: 1047, name: "EV BAKLAVASI - 500 GR", price: 200.00, category: "TATLI" },
        { id: 1048, name: "EV BAKLAVASI - PORSİYON", price: 75.00, category: "TATLI" },
        { id: 1049, name: "AŞURE - 500 GRAM", price: 100.00, category: "TATLI" },
        { id: 1050, name: "HÖŞMERİM - 500 GR", price: 100.00, category: "TATLI" },
        { id: 1051, name: "WAFFLE", price: 150.00, category: "TATLI" },
        { id: 1052, name: "DİĞER PASTA ÇEŞİTLERİ", price: 50.00, category: "TATLI" }
    ],
    tables: [],
    currentTableId: null,
    salesReport: [],
    activityLog: [],
    currentQuickSaleOrder: [],
    currentOrderOriginalTotal: 0,
    currentOrderDiscountAmount: 0,
    waiters: [],
    allUsers: [], // Aktif kullanıcı durumları için
    activeUsernames: [] // Aktif kullanıcı durumları için
};


    // --- DOM Elementleri ---
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingMessage = document.getElementById('loadingMessage');
    const loginModal = document.getElementById('loginModal');
    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginButton = document.getElementById('loginButton');
    const loginError = document.getElementById('loginError');
    const appContainer = document.getElementById('appContainer');
    const activeUserNameSpan = document.getElementById('activeUserName');
    const activeUserRoleSpan = document.getElementById('activeUserRole');
    const logoutButton = document.getElementById('logoutButton');
    const salesReportButton = document.getElementById('salesReportButton');
    const quickSaleEntryButton = document.getElementById('quickSaleEntryButton');
    const quickSaleButtonContainerTop = document.getElementById('quickSaleButtonContainerTop');
    const addProductToMenuButton = document.getElementById('addProductToMenuButton');
    const editProductMenuButton = document.getElementById('editProductMenuButton');
    const manageTablesButton = document.getElementById('manageTablesButton');
    const manageWaitersButton = document.getElementById('manageWaitersButton');
    const tablesGrid = document.getElementById('tablesGrid');
    const productsListRef = document.getElementById('productsListRef');
    const quickSaleCustomerNameInput = document.getElementById('quickSaleCustomerName'); // Yeni eklendi


    const orderPageContainer = document.getElementById('orderPageContainer');
    const orderPageTableName = document.getElementById('orderPageTableName');
    const orderPageWaiterInfo = document.getElementById('orderPageWaiterInfo');
    const backToTablesButton = document.getElementById('backToTablesButton');
    const orderPageProductGrid = document.getElementById('orderPageProductGrid');
    const orderPageCurrentOrderItems = document.getElementById('orderPageCurrentOrderItems');
    const orderPageCurrentOrderTotal = document.getElementById('orderPageCurrentOrderTotal');
    const discountInfoDiv = document.getElementById('discountInfo');
    const applyDiscountButton = document.getElementById('applyDiscountButton');
    const showReceiptButton = document.getElementById('showReceiptButton');
    const finalizeAndCloseTableButton = document.getElementById('finalizeAndCloseTableButton');

    const manualProductSection = document.getElementById('manualProductSection');
    const manualProductName = document.getElementById('manualProductName');
    const manualProductCategory = document.getElementById('manualProductCategory');
    const manualProductPrice = document.getElementById('manualProductPrice');
    const manualProductQuantity = document.getElementById('manualProductQuantity');
    const manualProductDescription = document.getElementById('manualProductDescription');
    const addManualProductButton = document.getElementById('addManualProductButton');
    const cashierStatusList = document.getElementById('cashierStatusList');
    const waiterStatusList = document.getElementById('waiterStatusList');

    // Hızlı Satış Modalı Elementleri
    const quickSaleModal = document.getElementById('quickSaleModal');
    const closeQuickSaleModalButton = document.getElementById('closeQuickSaleModalButton');
    const quickSaleProductGrid = document.getElementById('quickSaleProductGrid');
    const quickSaleCurrentItems = document.getElementById('quickSaleCurrentItems');
    const quickSaleTotal = document.getElementById('quickSaleTotal');
    const quickSaleDiscountInfo = document.getElementById('quickSaleDiscountInfo');
    const applyQuickSaleDiscountButton = document.getElementById('applyQuickSaleDiscountButton');
    const completeQuickSaleButton = document.getElementById('completeQuickSaleButton');


    const receiptModal = document.getElementById('receiptModal');
    const receiptDate = document.getElementById('receiptDate');
    const receiptTableName = document.getElementById('receiptTableName');
    const receiptWaiterName = document.getElementById('receiptWaiterName');
    const receiptItems = document.getElementById('receiptItems');
    const receiptDiscountInfo = document.getElementById('receiptDiscountInfo');
    const receiptSubtotal = document.getElementById('receiptSubtotal');
    const receiptDiscountAmount = document.getElementById('receiptDiscountAmount');
    const receiptGrandTotal = document.getElementById('receiptGrandTotal');
    const printReceiptButton = document.getElementById('printReceiptButton');
    const closeReceiptModalOnlyButton = document.getElementById('closeReceiptModalOnlyButton');

    // Masa Kapatma Onay Modalı Elementleri
    const confirmCloseTableModal = document.getElementById('confirmCloseTableModal');
    const confirmCloseTableYesButton = document.getElementById('confirmCloseTableYesButton');
    const confirmCloseTableNoButton = document.getElementById('confirmCloseTableNoButton');

    // Personel İndirimi Onay Modalı Elementleri
    const confirmDiscountModal = document.getElementById('confirmDiscountModal');
    const confirmDiscountYesButton = document.getElementById('confirmDiscountYesButton');
    const confirmDiscountNoButton = document.getElementById('confirmDiscountNoButton');

    // Menüye Ürün Ekleme Modalı Elementleri
    const addProductToMenuModal = document.getElementById('addProductToMenuModal');
    const closeAddProductToMenuModalButton = document.getElementById('closeAddProductToMenuModalButton');
    const newProductNameInput = document.getElementById('newProductName');
    const newProductPriceInput = document.getElementById('newProductPrice');
    const newProductCategorySelect = document.getElementById('newProductCategory');
    const newProductCategoryInput = document.getElementById('newProductCategoryInput');
    const saveNewProductButton = document.getElementById('saveNewProductButton');

    // Ürün Düzenleme Modalı Elementleri
    const editProductModal = document.getElementById('editProductModal');
    const closeEditProductModalButton = document.getElementById('closeEditProductModalButton');
    const selectProductToEdit = document.getElementById('selectProductToEdit');
    const editProductFormDiv = document.getElementById('editProductFormDiv');
    const editingProductIdInput = document.getElementById('editingProductId');
    const editProductNameInput = document.getElementById('editProductName');
    const editProductPriceInput = document.getElementById('editProductPrice');
    const editProductCategorySelect = document.getElementById('editProductCategory');
    const editProductCategoryInput = document.getElementById('editProductCategoryInput');
    const saveEditedProductButton = document.getElementById('saveEditedProductButton');

    // Masa Yönetimi Modalı Elementleri
    const manageTablesModal = document.getElementById('manageTablesModal');
    const closeManageTablesModalButton = document.getElementById('closeManageTablesModalButton');
    const newTableNameInput = document.getElementById('newTableNameInput');
    const addNewTableButton = document.getElementById('addNewTableButton');
    const selectTableToEditName = document.getElementById('selectTableToEditName');
    const editTableNameInput = document.getElementById('editTableNameInput');
    const updateTableNameButton = document.getElementById('updateTableNameButton');
    const selectTableToDelete = document.getElementById('selectTableToDelete');
    const deleteTableButton = document.getElementById('deleteTableButton');
    const confirmDeleteTableModal = document.getElementById('confirmDeleteTableModal');
    const tableNameToDeleteSpan = document.getElementById('tableNameToDeleteSpan');
    const confirmDeleteTableYesButton = document.getElementById('confirmDeleteTableYesButton');
    const confirmDeleteTableNoButton = document.getElementById('confirmDeleteTableNoButton');

    // Garson Yönetimi Modalı Elementleri
    const manageWaitersModal = document.getElementById('manageWaitersModal');
    const closeManageWaitersModalButton = document.getElementById('closeManageWaitersModalButton');
    const newWaiterUsernameInput = document.getElementById('newWaiterUsernameInput');
    const newWaiterPasswordInput = document.getElementById('newWaiterPasswordInput');
    const addNewWaiterButton = document.getElementById('addNewWaiterButton');
    const selectWaiterToEditPassword = document.getElementById('selectWaiterToEditPassword');
    const editWaiterPasswordInput = document.getElementById('editWaiterPasswordInput');
    const updateWaiterPasswordButton = document.getElementById('updateWaiterPasswordButton');
    const selectWaiterToDelete = document.getElementById('selectWaiterToDelete');
    const deleteWaiterButton = document.getElementById('deleteWaiterButton');
    const confirmDeleteWaiterModal = document.getElementById('confirmDeleteWaiterModal');
    const waiterNameToDeleteSpan = document.getElementById('waiterNameToDeleteSpan');
    const confirmDeleteWaiterYesButton = document.getElementById('confirmDeleteWaiterYesButton');
    const confirmDeleteWaiterNoButton = document.getElementById('confirmDeleteWaiterNoButton');

    // Uygulamadan Çıkış Onay Modalı
    const confirmExitAppModal = document.getElementById('confirmExitAppModal');
    const confirmExitAppYesButton = document.getElementById('confirmExitAppYesButton');
    const confirmExitAppNoButton = document.getElementById('confirmExitAppNoButton');


    const salesReportModal = document.getElementById('salesReportModal');
    const salesReportModalContent = document.getElementById('salesReportModalContent');
    const closeSalesReportModalButton = document.getElementById('closeSalesReportModalButton');
    const salesReportTableContainer = document.getElementById('salesReportTableContainer');
    const totalItemsSoldSpan = document.getElementById('totalItemsSold');
    const grandTotalSalesSpan = document.getElementById('grandTotalSales');
    const refreshSalesReportButton = document.getElementById('refreshSalesReportButton');
    const printSalesReportButton = document.getElementById('printSalesReportButton');


    // --- Yardımcı Fonksiyonlar ---
    function formatPrice(price) {
        if (typeof price !== 'number' || isNaN(price)) {
            return '0 ₺';
        }
        const formatted = price.toFixed(2).replace('.', ',');
        if (formatted.endsWith(',00')) {
            return formatted.substring(0, formatted.length - 3) + ' ₺';
        }
        return formatted + ' ₺';
    }


    // Timestamp'i okunabilir tarih/saat formatına çevirir
function formatTimestamp(timestampInput) {
    if (!timestampInput) {
        return '-';
    }

    let initialDate;

    if (typeof timestampInput === 'number') {
        initialDate = new Date(timestampInput);
    } else if (timestampInput instanceof Date) {
        initialDate = timestampInput;
    } else if (typeof timestampInput === 'string') {
        const parts = timestampInput.match(/^(\d{2})\.(\d{2})\.(\d{4}) (\d{2}):(\d{2}):(\d{2})$/);
        if (parts) {
            const year = parseInt(parts[3], 10);
            const monthIndex = parseInt(parts[2], 10) - 1;
            const day = parseInt(parts[1], 10);
            const hour = parseInt(parts[4], 10);
            const minute = parseInt(parts[5], 10);
            const second = parseInt(parts[6], 10);

            // Assume "DD.MM.YYYY HH:MM:SS" string components are UTC
            const utcTimestamp = Date.UTC(year, monthIndex, day, hour, minute, second);
            initialDate = new Date(utcTimestamp);
        } else {
            // For other string formats like ISO 8601
            initialDate = new Date(timestampInput);
        }
    } else {
        console.warn("formatTimestamp: Bilinmeyen zaman damgası türü:", timestampInput);
        return '-';
    }

    if (!initialDate || isNaN(initialDate.getTime())) {
        console.warn("formatTimestamp: Geçersiz tarih oluşturuldu. Giriş:", timestampInput);
        return '-';
    }

    try {
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'Europe/Istanbul',
            hour12: false
        };
        let formattedDate = new Intl.DateTimeFormat('tr-TR', options).format(initialDate);
        return formattedDate.replace(',', '');
    } catch (e) {
        console.error("Intl.DateTimeFormat ile tarih formatlama hatası:", e);
        // Fallback: Try to manually construct TRT from UTC date
        // initialDate is UTC. Add 3 hours for TRT.
        const trtEquivalentMilliseconds = initialDate.getTime() + (3 * 60 * 60 * 1000);
        const trtDate = new Date(trtEquivalentMilliseconds);

        // Format trtDate using its UTC methods to get the TRT components
        const day = String(trtDate.getUTCDate()).padStart(2, '0');
        const month = String(trtDate.getUTCMonth() + 1).padStart(2, '0');
        const year = trtDate.getUTCFullYear();
        const hours = String(trtDate.getUTCHours()).padStart(2, '0');
        const minutes = String(trtDate.getUTCMinutes()).padStart(2, '0');
        return `${day}.${month}.${year} ${hours}:${minutes}`;
    }
}


    
    function getCurrentFormattedDate() {
        const now = new Date();
        return `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    }

    function showLoading(message = "İşleniyor...") {
        loadingMessage.textContent = message;
        loadingOverlay.classList.add('active');
    }

    function hideLoading() {
        loadingOverlay.classList.remove('active');
    }

    // Kategori adı için CSS sınıfı üreten fonksiyon
    function sanitizeCategoryForCSS(categoryName) {
        if (!categoryName) return 'default';
        const turkishMap = { 'İ': 'I', 'ı': 'i', 'Ö': 'O', 'ö': 'o', 'Ü': 'U', 'ü': 'u', 'Ş': 'S', 'ş': 's', 'Ğ': 'G', 'ğ': 'g', 'Ç': 'C', 'ç': 'c' };
        return categoryName
            .replace(/[İıÖöÜüŞşĞğÇç]/g, match => turkishMap[match] || match)
            .replace(/&/g, 'AND')
            .replace(/\s+/g, '-')
            .replace(/[^a-zA-Z0-9-]/g, '')
            .toUpperCase();
    }


    // --- WebSocket Fonksiyonları ---
    function connectWebSocket() {
        showLoading("Sunucuya bağlanılıyor...");
        socket = new WebSocket(WEBSOCKET_URL);

            socket.onopen = () => {
        console.log("WebSocket bağlantısı kuruldu.");
        hideLoading();
        
        // YENİ EKLENEN/AKTİF EDİLEN SATIR:
        // Sunucudan tüm kullanıcıları ve aktif durumlarını iste
        sendMessageToServer('get_all_users_and_active_status', {}); 

        const storedUser = localStorage.getItem('adisyonUser');
        if (storedUser) {
            try {
                appState.user = JSON.parse(storedUser);
                console.log("Oturum bulundu:", appState.user.username);
                // UI güncellemeleri reauthenticate veya login_success yanıtından sonra yapılmalı.
                // Sunucu reauthenticate mesajına products_update ve tables_update ile cevap verir.
                sendMessageToServer('reauthenticate', { user: appState.user });
            } catch (e) {
                console.error("localStorage'dan kullanıcı verisi okunamadı:", e);
                localStorage.removeItem('adisyonUser');
                showLoginScreen(); // Hata durumunda login ekranını göster
                // renderUserLoginStatus(); // Bu çağrı, sunucudan gelecek initial_user_status mesajıyla tetiklenir.
            }
        } else {
            showLoginScreen(); // Kullanıcı yoksa login ekranını göster
            // renderUserLoginStatus(); // Bu çağrı, sunucudan gelecek initial_user_status mesajıyla tetiklenir.
        }
    };

        socket.onmessage = (event) => {
            console.log("RAW Sunucudan mesaj alındı:", event.data);
            let message;
            try {
                message = JSON.parse(event.data);
            } catch (error) {
                console.error("JSON.parse BAŞARISIZ!", "Hata:", error, "Alınan Veri:", event.data);
                return;
            }
            handleServerMessage(message);
        };

        socket.onerror = (error) => {
            console.error("WebSocket hatası:", error);
            showLoginError("Sunucu bağlantı hatası. Lütfen daha sonra tekrar deneyin.");
            hideLoading();
        };

        socket.onclose = () => {
            console.log("WebSocket bağlantısı kapandı.");
            showLoginError("Sunucu bağlantısı kesildi. Yeniden bağlanmak için sayfayı yenileyin.");
            appContainer.classList.add('hidden');
            orderPageContainer.classList.remove('active');
            loginModal.classList.add('active');
            hideLoading();
        };
    }

    function sendMessageToServer(type, payload) {
        if (socket && socket.readyState === WebSocket.OPEN) {
            const message = JSON.stringify({ type, payload });
            socket.send(message);
            console.log("Sunucuya gönderildi:", message);
        } else {
            console.error("WebSocket bağlantısı açık değil.");
            if(appState.user && (!socket || socket.readyState === WebSocket.CLOSED)){
                 console.log("Bağlantı kapalı, yeniden bağlanılıyor...");
                 setTimeout(() => connectWebSocket(), 1000);
            } else if (!appState.user) {
                 loginModal.classList.add('active');
                 appContainer.classList.add('hidden');
                 orderPageContainer.classList.remove('active');
                 showLoginError("Lütfen önce giriş yapın.");
            }
             else {
                showLoginError("Sunucuya mesaj gönderilemedi. Bağlantı sorunu.");
            }
        }
    }

function handleServerMessage(message) {
    hideLoading();
    // console.log("CLIENT: İşlenecek Mesaj Tipi:", message.type, "Payload:", message.payload);

    switch (message.type) {
        case 'login_success':
            const userDataFromServer = message.payload.user;
            if (message.payload && userDataFromServer && typeof userDataFromServer === 'object') {
                appState.user = userDataFromServer;
                appState.tables = (message.payload.tables && Array.isArray(message.payload.tables)) ? message.payload.tables : [];
                appState.products = (message.payload.products && Array.isArray(message.payload.products)) ? message.payload.products : [];
                
                localStorage.setItem('adisyonUser', JSON.stringify(appState.user));
                activeUserNameSpan.textContent = appState.user.username;
                activeUserRoleSpan.textContent = appState.user.role;
                
                loginModal.classList.remove('active');
                appContainer.classList.remove('hidden');
                orderPageContainer.classList.remove('active');
                loginError.textContent = '';
                
                renderInitialDataIfNeeded();
                renderTables();
                updateUIForRole();
                console.log("Giriş başarılı ve UI güncellendi:", appState.user.username);
            } else {
                showLoginError("Sunucudan eksik veya hatalı giriş yanıtı alındı (login_success).");
                performLogout(false); showLoginScreen();
            }
            break;

        case 'reauth_success': // SUNUCUDAN BU MESAJ GELECEK
            if (message.payload && message.payload.user) {
                appState.user = message.payload.user;
                localStorage.setItem('adisyonUser', JSON.stringify(appState.user));

                activeUserNameSpan.textContent = appState.user.username;
                activeUserRoleSpan.textContent = appState.user.role;

                loginModal.classList.remove('active');
                appContainer.classList.remove('hidden');
                orderPageContainer.classList.remove('active');
                loginError.textContent = '';
                updateUIForRole();
                console.log("Oturum başarıyla sürdürüldü ve UI güncellendi:", appState.user.username);
                // tables_update ve products_update mesajları zaten ayrıca gelecek ve ilgili render fonksiyonlarını tetikleyecek.
                // renderInitialDataIfNeeded(); // Bu çağrılar products_update ile tetiklenir
                // renderTables(); // Bu çağrı tables_update ile tetiklenir
            } else {
                 showLoginError("Oturum sürdürülürken eksik bilgi alındı.");
                 performLogout(false);
                 showLoginScreen();
            }
            break;

        case 'login_fail':
            showLoginError(message.payload.error || "Kullanıcı adı veya şifre hatalı.");
            localStorage.removeItem('adisyonUser');
            break;

        case 'error':
            alert(`Sunucu Hatası: ${message.payload.message || 'Bilinmeyen bir sunucu hatası oluştu.'}`);
            console.error("Sunucudan hata mesajı alındı:", message.payload);
            break;

        case 'tables_update':
            if (message.payload && Array.isArray(message.payload.tables)) {
                appState.tables = message.payload.tables;
                renderTables(); // Bu fonksiyonun tanımlı olduğundan emin olun
                console.log("Masalar sunucudan güncellendi.");
                if (orderPageContainer.classList.contains('active') && appState.currentTableId) {
                    const updatedTable = appState.tables.find(t => t.id === appState.currentTableId);
                    if (updatedTable) {
                        renderOrderPageForTable(updatedTable);
                    } else {
                        showTablesView();
                    }
                }
                if (manageTablesModal.classList.contains('active')) {
                    populateTableSelectsForManagement(); // Bu fonksiyonun tanımlı olduğundan emin olun
                }
            }
            break;

        case 'products_list': // Sunucu artık bunu göndermemeli, ama yedek olarak kalabilir
        case 'products_update':
            if (message.payload && Array.isArray(message.payload.products)) {
                appState.products = message.payload.products;
                console.log(`Ana ürün listesi sunucudan güncellendi (tip: ${message.type}).`);
                initialDataRendered = false;
                renderInitialDataIfNeeded(); // Bu fonksiyonun tanımlı olduğundan emin olun
                if (orderPageContainer.classList.contains('active') && appState.currentTableId) {
                    const currentTable = appState.tables.find(t => t.id === appState.currentTableId);
                    if (currentTable) renderOrderPageForTable(currentTable);
                }
                if (quickSaleModal.classList.contains('active')) renderProductGrid(quickSaleProductGrid, true);
                if (editProductModal.classList.contains('active')) populateSelectProductToEdit(); // Bu fonksiyonun tanımlı olduğundan emin olun
            }
            break;

        case 'initial_user_status': // Sunucudan ilk kullanıcı durumları geldiğinde
        case 'all_users_and_active_status_data': // BU CASE EKLENDİ/GÜNCELLENDİ
            if (message.payload) {
                appState.allUsers = message.payload.allUsers || [];
                appState.activeUsernames = message.payload.activeUsernames || [];
                renderUserLoginStatus(); // Bu fonksiyonun tanımlı olduğundan emin olun
            }
            break;

        case 'active_users_update':
            if (message.payload) {
                appState.allUsers = message.payload.allUsers || [];
                appState.activeUsernames = message.payload.activeUsernames || [];
                renderUserLoginStatus();
            }
            break;
        
        case 'force_logout':
            alert(message.payload.message || 'Bu hesap başka bir yerden giriş yaptığı için oturumunuz sonlandırıldı.');
            performLogout(false);
            showLoginScreen();
            break;

        // ... (Diğer tüm mevcut case'leriniz)
        case 'main_menu_product_added':
            alert(message.payload.message || "Yeni ürün menüye eklendi!");
            break;
         case 'main_menu_product_updated':
            alert(message.payload.message || "Ürün menüde güncellendi!");
            break;
        case 'table_operation_success':
            alert(message.payload.message || "Masa işlemi başarılı.");
            break;
        case 'table_operation_fail':
            alert(message.payload.error || "Masa işlemi başarısız oldu.");
            break;
        case 'waiters_list':
            if (message.payload && Array.isArray(message.payload.waiters)) {
                appState.waiters = message.payload.waiters;
                populateWaiterSelectsForManagement();
            }
            break;
        case 'waiter_operation_success':
            alert(message.payload.message || "Garson işlemi başarılı.");
            sendMessageToServer('get_waiters_list', {});
            break;
        case 'waiter_operation_fail':
            alert(message.payload.error || "Garson işlemi başarısız oldu.");
            break;
        case 'sales_report_data':
            appState.salesReport = message.payload.sales || [];
            renderSalesReport();
            break;
        case 'activity_log_data':
            appState.activityLog = message.payload.logs || [];
            renderActivityLog();
            break;
        case 'order_update_fail':
            alert(`Sipariş güncellenemedi: ${message.payload.error}`);
            break;
        case 'manual_order_update_fail':
            alert(`Manuel ürün eklenemedi: ${message.payload.error}`);
            break;
        case 'quick_sale_success':
            console.log("Hızlı satış sunucuda tamamlandı.");
            // Fiş gösterildikten sonra sepet temizlenir (closeReceiptModalOnly içinde)
            break;
        case 'quick_sale_fail':
            alert(`Hızlı satış tamamlanamadı: ${message.payload.error}`);
            break;

        default:
            console.warn("handleServerMessage: Bilinmeyen mesaj tipi:", message.type, "Payload:", message.payload);
            break;
    }
}
    function showLoginError(message) {
        loginError.textContent = message;
        passwordInput.value = '';
    }


// Bu fonksiyon Android WebView'ın onBackPressed() metodundan çağrılmak üzere tasarlanmıştır.
window.handleAndroidBackButton = function() {
    const isActive = (element) => element && (element.classList.contains('active') || (element.style.display !== 'none' && getComputedStyle(element).display !== 'none'));

    // 1. Öncelikle açık bir "onay" veya "çıkış" modalı var mı kontrol et ve kapat
    if (isActive(confirmExitAppModal)) {
        confirmExitAppModal.classList.remove('active');
        console.log("Geri tuşu: Çıkış onayı kapatıldı.");
        return; // Olay işlendi, uygulama kapanmasın
    }
    if (isActive(confirmCloseTableModal)) {
        confirmCloseTableModal.classList.remove('active');
        console.log("Geri tuşu: Masa kapatma onayı kapatıldı.");
        return; // Olay işlendi
    }
    if (isActive(confirmDiscountModal)) {
        confirmDiscountModal.classList.remove('active');
        console.log("Geri tuşu: İndirim onayı kapatıldı.");
        return; // Olay işlendi
    }
    if (isActive(confirmDeleteTableModal)) {
        confirmDeleteTableModal.classList.remove('active');
        console.log("Geri tuşu: Masa silme onayı kapatıldı.");
        return; // Olay işlendi
    }
    if (isActive(confirmDeleteWaiterModal)) {
        confirmDeleteWaiterModal.classList.remove('active');
        console.log("Geri tuşu: Garson silme onayı kapatıldı.");
        return; // Olay işlendi
    }

    // 2. Aktif olan ana işlem sayfaları veya modalları kontrol et
    // Bu sayfalar/modallar açıksa, ana ekrana (masalar görünümüne) dön
    if (isActive(orderPageContainer)) {
        console.log("Geri tuşu: Sipariş sayfasından ana ekrana dönülüyor.");
        showTablesView();
        return; // Olay işlendi
    }
    if (isActive(quickSaleModal)) {
        console.log("Geri tuşu: Hızlı satış modalından ana ekrana dönülüyor.");
        // closeQuickSaleModalButton normalde showTablesView çağırıyor.
        // Direkt showTablesView() çağırmak da aynı işi görür.
        showTablesView();
        return; // Olay işlendi
    }
    if (isActive(addProductToMenuModal)) {
        console.log("Geri tuşu: Ürün ekleme modalından ana ekrana dönülüyor.");
        addProductToMenuModal.classList.remove('active'); // Önce modalı kapat
        showTablesView(); // Sonra ana sayfayı göster
        return; // Olay işlendi
    }
    if (isActive(editProductModal)) {
        console.log("Geri tuşu: Ürün düzenleme modalından ana ekrana dönülüyor.");
        editProductModal.classList.remove('active');
        showTablesView();
        return; // Olay işlendi
    }
    if (isActive(manageTablesModal)) {
        console.log("Geri tuşu: Masa yönetimi modalından ana ekrana dönülüyor.");
        manageTablesModal.classList.remove('active');
        showTablesView();
        return; // Olay işlendi
    }
    if (isActive(manageWaitersModal)) {
        console.log("Geri tuşu: Garson yönetimi modalından ana ekrana dönülüyor.");
        manageWaitersModal.classList.remove('active');
        showTablesView();
        return; // Olay işlendi
    }
    if (isActive(salesReportModal)) {
        console.log("Geri tuşu: Satış raporu modalından ana ekrana dönülüyor.");
        salesReportModal.classList.remove('active');
        showTablesView();
        return; // Olay işlendi
    }
    if (isActive(receiptModal)) {
        console.log("Geri tuşu: Fiş modalından çıkılıyor.");
        closeReceiptModalOnly(); // Bu fonksiyon kendi mantığına göre davranır (ya masalara döner ya da sipariş sayfasında kalır)
                                 // Eğer her durumda ana ekrana dönmesi isteniyorsa showTablesView() çağrılabilir.
                                 // Mevcut closeReceiptModalOnly, hızlı satış sonrası veya masa boşsa ana ekrana döner.
        return; // Olay işlendi
    }

    // 3. Ana ekranda (masalar görünümü) ise çıkış onayı göster
    // loginModal'ın aktif olmadığını da kontrol etmeliyiz.
    if (isActive(appContainer) && !isActive(loginModal)) {
        console.log("Geri tuşu: Ana ekranda, çıkış onayı gösteriliyor.");
        confirmExitAppModal.classList.add('active');
        return; // Olay işlendi (popup açıldı)
    }

    // 4. Login ekranında ise uygulamayı kapatmasına izin ver (Android tarafı halletmeli)
    // Veya burada da bir çıkış onayı gösterilebilir. Şimdilik varsayılan davranışa (kapanma) bırakıyoruz.
    if (isActive(loginModal)) {
        console.log("Geri tuşu: Login ekranında, uygulama kapanabilir.");
        // Android tarafına uygulamanın kapanabileceğini bildirmek için:
        if (window.Android && typeof window.Android.closeApp === 'function') {
            window.Android.closeApp();
        } else {
            // Tarayıcıda veya Android arayüzü yoksa, history.back() ile bir önceki sayfaya gitmeye çalışabilir.
            // Tek sayfa uygulamada bu genellikle bir işe yaramaz veya istenmeyen davranışa yol açar.
            // Bu durumda, kullanıcıya bir uyarı verilebilir veya hiçbir şey yapılmayabilir.
            console.warn("Login ekranında geri tuşuna basıldı, ancak 'window.Android.closeApp' bulunamadı.");
        }
        return; // Olay (kapatma isteğiyle) işlendi
    }

    // 5. Hiçbir koşul eşleşmezse (beklenmedik durum), güvenli çıkış yapmayı dene
    console.log("Geri tuşu: Tanımlanmayan durum, uygulama kapatılmaya çalışılıyor.");
    if (window.Android && typeof window.Android.closeApp === 'function') {
        window.Android.closeApp();
    } else {
        console.warn("Tanımlanmayan durumda geri tuşuna basıldı, ancak 'window.Android.closeApp' bulunamadı.");
    }
};







    // --- Rol Bazlı UI Güncelleme ---
    function updateUIForRole() {
        if (!appState.user) return;
        console.log("UI güncelleniyor. Kullanıcı rolü:", appState.user.role);

        if (appState.user.role === 'cashier') {
            manualProductSection.classList.remove('hidden');
            salesReportButton.textContent = "Satış Raporlama";
            salesReportButton.classList.remove('hidden');
            quickSaleButtonContainerTop.classList.remove('hidden');
            addProductToMenuButton.classList.remove('hidden');
            editProductMenuButton.classList.remove('hidden');
            manageTablesButton.classList.remove('hidden');
            manageWaitersButton.classList.remove('hidden');
            finalizeAndCloseTableButton.classList.remove('hidden');
            showReceiptButton.classList.remove('hidden');
            applyDiscountButton.classList.remove('hidden');
            applyQuickSaleDiscountButton.classList.remove('hidden');
        } else {
            manualProductSection.classList.add('hidden');
            salesReportButton.classList.add('hidden');
            quickSaleButtonContainerTop.classList.add('hidden');
            addProductToMenuButton.classList.add('hidden');
            editProductMenuButton.classList.add('hidden');
            manageTablesButton.classList.add('hidden');
            manageWaitersButton.classList.add('hidden');
            finalizeAndCloseTableButton.classList.add('hidden');
            showReceiptButton.classList.add('hidden');
            applyDiscountButton.classList.add('hidden');
            applyQuickSaleDiscountButton.classList.add('hidden');
        }
        logoutButton.textContent = "Uygulamadan Çık";
    }

    // Gerekliyse başlangıç render fonksiyonlarını çağırır
    let initialDataRendered = false;
    function renderInitialDataIfNeeded() {
        if (!initialDataRendered || appState.products.length > 0) {
            renderProductGrid(orderPageProductGrid, false);
            renderProductGrid(quickSaleProductGrid, true);
            renderProductsForReference();
            populateManualCategorySelect();
            populateNewProductCategorySelect();
            populateEditProductCategorySelect();
            initialDataRendered = true;
            console.log("İlk data render edildi (ürün grid, referans, kategori select).");
        }
    }


    // --- Render Fonksiyonları ---
    function renderInitialData() {
        renderInitialDataIfNeeded();
    }

    function renderTables() {
        console.log("[renderTables] Fonksiyon çağrıldı. Masa sayısı:", appState.tables ? appState.tables.length : 0);
        tablesGrid.innerHTML = '';
        if (!appState.tables || appState.tables.length === 0) {
             tablesGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Masa bilgisi bekleniyor...</p>';
             return;
        }
        appState.tables.forEach(table => {
            const tableCard = document.createElement('div');
            const isDolu = table.status === 'dolu' && table.order && table.order.length > 0;

            let baseColorClass = 'bg-gray-400 hover:bg-gray-500'; // Varsayılan
            if (table.type === 'kamelya') {
                baseColorClass = 'bg-yellow-600 hover:bg-yellow-700';
            } else if (table.type === 'bahce') {
                baseColorClass = 'bg-green-400 hover:bg-green-500';
            }

            tableCard.className = `p-4 rounded-lg shadow-md cursor-pointer transition-all duration-200 ease-in-out transform hover:scale-105 ${isDolu ? 'bg-red-400 hover:bg-red-500' : baseColorClass}`;

            let waiterInfoHtml = '';
            if (isDolu && table.waiterUsername) {
                waiterInfoHtml = `<p class="text-xs text-white text-center mt-1">Garson: ${table.waiterUsername}</p>`;
            }
            tableCard.innerHTML = `
                <h3 class="text-xl font-semibold text-white text-center">${table.name}</h3>
                <p class="text-sm text-white text-center capitalize">${isDolu ? 'Dolu' : 'Boş'}</p>
                ${isDolu ? `<p class="text-xs text-white text-center mt-1">Toplam: ${formatPrice(table.total)}</p>` : ''}
                ${waiterInfoHtml}
            `;
            tableCard.addEventListener('click', () => selectTableForOrder(table.id));
            tablesGrid.appendChild(tableCard);
        });
    }

function renderUserLoginStatus() {
    if (!cashierStatusList || !waiterStatusList || !appState.allUsers) return;

    cashierStatusList.innerHTML = '';
    waiterStatusList.innerHTML = '';

    const allUsers = Array.isArray(appState.allUsers) ? appState.allUsers : [];
    const activeUsernames = Array.isArray(appState.activeUsernames) ? appState.activeUsernames : [];

    const cashiers = allUsers.filter(user => user.role === 'cashier');
    const waiters = allUsers.filter(user => user.role === 'waiter');

    const createStatusItem = (user) => {
        const isActive = activeUsernames.includes(user.username);
        const itemDiv = document.createElement('div');
        itemDiv.className = 'user-status-item';
        itemDiv.innerHTML = `
            <span class="status-indicator ${isActive ? 'active' : 'inactive'}"></span>
            <span>${user.username}</span>
        `;
        return itemDiv;
    };

    if (cashiers.length === 0) {
        cashierStatusList.innerHTML = '<p class="text-xs text-gray-500">Tanımlı kasa hesabı yok.</p>';
    } else {
        cashiers.forEach(user => cashierStatusList.appendChild(createStatusItem(user)));
    }

    if (waiters.length === 0) {
        waiterStatusList.innerHTML = '<p class="text-xs text-gray-500">Tanımlı garson hesabı yok.</p>';
    } else {
        waiters.forEach(user => waiterStatusList.appendChild(createStatusItem(user)));
    }
}





    // Ürün Seçim Gridini Oluşturur (Hem normal sipariş hem hızlı satış için)
function renderProductGrid(targetGridElement, forQuickSale = false) {
    targetGridElement.innerHTML = '';
    if (!appState.products || appState.products.length === 0) {
        targetGridElement.innerHTML = '<p class="text-gray-500 text-center py-4">Ürün listesi boş veya yüklenemedi.</p>';
        return;
    }

    const categories = {};
    // Kategori renkleri (Bunların CSS'de tanımlı olduğundan emin olun)
    const categorySectionColors = {
        "ET - TAVUK": "category-section-bg-ET-TAVUK",
        "ATIŞTIRMALIK": "category-section-bg-ATIŞTIRMALIK",
        "TATLI": "category-section-bg-TATLI",
        "İÇECEK": "category-section-bg-İÇECEK",
        "ÇORBA": "category-section-bg-ÇORBA",
        "DİĞER": "category-section-bg-DİĞER" // DİĞER için de bir renk tanımlayabilirsiniz
    };
    const productCardColors = {
        "ET - TAVUK": "product-card-bg-ET-TAVUK",
        "ATIŞTIRMALIK": "product-card-bg-ATIŞTIRMALIK",
        "TATLI": "product-card-bg-TATLI",
        "İÇECEK": "product-card-bg-İÇECEK",
        "ÇORBA": "product-card-bg-ÇORBA",
        "DİĞER": "product-card-bg-DİĞER"
    };
    const defaultSectionColor = "category-section-bg-default"; // Varsayılan renk
    const defaultCardColor = "product-card-bg-default";     // Varsayılan renk

    appState.products.forEach(product => {
        const categoryKey = product.category || 'DİĞER'; // Kategorisiz ürünler DİĞER'e
        if (!categories[categoryKey]) categories[categoryKey] = [];
        categories[categoryKey].push(product);
    });

    const categoryOrder = ["ÇORBA", "ET - TAVUK", "ATIŞTIRMALIK", "İÇECEK", "TATLI", "DİĞER"];
    const sortedCategoryNames = Object.keys(categories).sort((a, b) => {
        const indexA = categoryOrder.indexOf(a); const indexB = categoryOrder.indexOf(b);
        if (indexA !== -1 && indexB !== -1) return indexA - indexB;
        if (indexA !== -1) return -1; if (indexB !== -1) return 1;
        return a.localeCompare(b, 'tr');
    });

    sortedCategoryNames.forEach(category => {
        const categorySection = document.createElement('div');
        // sanitizeCategoryForCSS fonksiyonunuzun doğru çalıştığından emin olun.
        // Veya doğrudan kategori adını kullanın eğer CSS sınıflarınız Türkçe karakterleri destekliyorsa.
        // Bu örnekte, sanitize edilmiş halini kullanıyoruz.
        const sanitizedCategory = sanitizeCategoryForCSS(category);
        const sectionBgColorClass = categorySectionColors[sanitizedCategory] || defaultSectionColor;
        categorySection.className = `mb-6 p-4 rounded-lg ${sectionBgColorClass}`;

        const categoryTitle = document.createElement('h4');
        categoryTitle.className = 'text-lg font-semibold mb-3 text-gray-700 border-b border-gray-400 pb-1';
        categoryTitle.textContent = category;
        categorySection.appendChild(categoryTitle);

        const productGridDiv = document.createElement('div');
        productGridDiv.className = forQuickSale ? 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2' : 'grid grid-cols-2 md:grid-cols-3 gap-3';

        categories[category].sort((a, b) => a.name.localeCompare(b.name, 'tr')).forEach(product => {
            const card = document.createElement('div');
            const cardBgColorClass = productCardColors[sanitizedCategory] || defaultCardColor;
            card.className = `product-card ${cardBgColorClass} ${forQuickSale ? 'p-2 min-h-[100px]' : 'p-3 min-h-[120px]'}`;
            card.dataset.productId = product.id;
            card.dataset.productName = product.name;
            card.dataset.productPrice = product.price; // Orijinal birim/kg fiyatı
            card.dataset.productCategory = product.category || 'DİĞER';
            if (product.isByWeight) {
                card.dataset.isByWeight = "true";
                card.dataset.unitPrice = product.unitPrice; // Gram başına fiyat
            }

            if (product.isByWeight) {
                card.innerHTML = `
                    <div>
                        <h5 class="${forQuickSale ? 'text-xs' : 'text-sm'}">${product.name}</h5>
                        <p class="product-price ${forQuickSale ? 'text-[0.65rem]' : 'text-xs'} text-gray-600">${formatPrice(product.price)}/KG (Gram: ${formatPrice(product.unitPrice || 0)})</p>
                    </div>
                    <div class="mt-1">
                        <input type="number" placeholder="Gram" class="weight-input border border-gray-300 rounded ${forQuickSale ? 'text-xs p-1' : 'text-sm p-2'} w-full mb-1" min="1">
                        ${!forQuickSale ? `<input type="text" placeholder="Açıklama..." class="description-input border border-gray-300 rounded text-xs p-1 w-full mb-1">` : ''}
                    </div>
                    <button data-product-id="${product.id}" class="${forQuickSale ? 'add-weighted-item-btn-quick-sale' : 'add-weighted-item-btn'} bg-green-500 hover:bg-green-600 text-white ${forQuickSale ? 'text-xs py-1' : 'text-xs font-semibold py-1 px-2'} rounded w-full mt-1">
                        Gramajlı Ekle
                    </button>
                `;
            } else {
                card.innerHTML = `
                    <div>
                        <h5 class="${forQuickSale ? 'text-sm' : ''}">${product.name}</h5>
                        ${!forQuickSale ? `<p class="product-price">${formatPrice(product.price)}</p>` : `<p class="product-price text-xs text-center font-semibold">${formatPrice(product.price)}</p>`}
                    </div>
                    ${!forQuickSale ? `
                    <div class="mt-2">
                        <input type="text" placeholder="Açıklama..." class="description-input border border-gray-300 rounded text-xs p-1 w-full mb-2">
                        <div class="product-card-quantity flex items-center justify-center space-x-1">
                            <button class="quantity-decrease bg-red-200 hover:bg-red-300 text-red-700 font-bold rounded">-</button>
                            <input type="number" value="1" min="1" class="quantity-input border border-gray-300 rounded text-xs p-1">
                            <button class="quantity-increase bg-green-200 hover:bg-green-300 text-green-700 font-bold rounded">+</button>
                        </div>
                    </div>
                    ` : ''}
                    <button data-product-id="${product.id}" class="add-item-from-card-btn ${forQuickSale ? 'bg-blue-600 hover:bg-blue-700 py-2' : 'bg-blue-500 hover:bg-blue-600 text-xs py-1 px-2'} text-white font-semibold rounded w-full mt-auto">
                        ${forQuickSale ? 'Ekle' : 'Siparişe Ekle'}
                    </button>
                `;
            }
            productGridDiv.appendChild(card);
        });
        categorySection.appendChild(productGridDiv);
        targetGridElement.appendChild(categorySection);
    });
    addProductCardEventListeners(targetGridElement, forQuickSale);
}


    // Ürün kartlarındaki butonlara event listener ekler
function addProductCardEventListeners(targetGridElement, forQuickSale) {
    // Standart ürün ekleme butonu (hem normal hem hızlı satış için)
    targetGridElement.querySelectorAll('.add-item-from-card-btn').forEach(addBtn => {
        addBtn.addEventListener('click', () => {
            const card = addBtn.closest('.product-card');
            const productId = card.dataset.productId;
            // Ağırlıklı ürünler bu butondan eklenmemeli, onlar için ayrı buton var.
            if (card.dataset.isByWeight === "true" && forQuickSale) {
                 // Hızlı satışta standart "Ekle" butonu ağırlıklı ürünler için farklı davranmalı
                 // veya bu buton ağırlıklı ürünler için hiç gösterilmemeli, sadece gramajlı ekle olmalı.
                 // Şimdilik bir uyarı verelim, UI'da bu butonun ağırlıklı ürünler için olmaması daha iyi olur.
                alert("Ağırlıklı ürünler için lütfen 'Gramajlı Ekle' butonunu kullanın.");
                return;
            }

            if (forQuickSale) {
                addProductToQuickSale(productId, 1, '', false); // isCustomItem = false
            } else {
                const quantityInput = card.querySelector('.quantity-input');
                const descriptionInput = card.querySelector('.description-input');
                const quantity = parseInt(quantityInput.value) || 1;
                const description = descriptionInput ? descriptionInput.value.trim() : '';
                addProductToOrder(productId, quantity, description, false);
                if (quantityInput) quantityInput.value = 1;
                if (descriptionInput) descriptionInput.value = '';
            }
        });
    });

    // Ağırlıklı ürün ekleme butonu (Normal Sipariş Sayfası)
    targetGridElement.querySelectorAll('.add-weighted-item-btn').forEach(addBtn => {
        addBtn.addEventListener('click', () => {
            const card = addBtn.closest('.product-card');
            const productId = card.dataset.productId;
            const unitPrice = parseFloat(card.dataset.unitPrice);
            const originalProductName = card.dataset.productName;
            const category = card.dataset.productCategory;

            const weightInput = card.querySelector('.weight-input');
            const descriptionInput = card.querySelector('.description-input'); // Normal siparişte açıklama var
            const weightInGrams = parseInt(weightInput.value);
            const description = descriptionInput ? descriptionInput.value.trim() : '';

            if (isNaN(weightInGrams) || weightInGrams <= 0) {
                alert("Lütfen geçerli bir gramaj girin.");
                weightInput.focus();
                return;
            }
            if (isNaN(unitPrice) || unitPrice <= 0) {
                alert("Ürün birim fiyatı hatalı. Lütfen yöneticiye bildirin.");
                return;
            }

            const calculatedPrice = unitPrice * weightInGrams;
            const itemNameWithWeight = `${originalProductName} (${weightInGrams} gr)`;

            addProductToOrder(
                productId, weightInGrams, description, true,
                itemNameWithWeight, calculatedPrice, category, productId
            );
            weightInput.value = '';
            if (descriptionInput) descriptionInput.value = '';
        });
    });

    // Ağırlıklı ürün ekleme butonu (Hızlı Satış)
    targetGridElement.querySelectorAll('.add-weighted-item-btn-quick-sale').forEach(addBtn => {
        addBtn.addEventListener('click', () => {
            const card = addBtn.closest('.product-card');
            const productId = card.dataset.productId;
            const unitPrice = parseFloat(card.dataset.unitPrice);
            const originalProductName = card.dataset.productName;
            const category = card.dataset.productCategory;

            const weightInput = card.querySelector('.weight-input');
            // Hızlı satışta ürün kartında ayrı bir açıklama inputu yok, bu yüzden boş gönderiyoruz.
            const description = '';
            const weightInGrams = parseInt(weightInput.value);

            if (isNaN(weightInGrams) || weightInGrams <= 0) {
                alert("Lütfen geçerli bir gramaj girin.");
                weightInput.focus();
                return;
            }
            if (isNaN(unitPrice) || unitPrice <= 0) {
                alert("Ürün birim fiyatı hatalı. Lütfen yöneticiye bildirin.");
                return;
            }

            const calculatedPrice = unitPrice * weightInGrams;
            const itemNameWithWeight = `${originalProductName} (${weightInGrams} gr)`;

            addProductToQuickSale(
                productId, // Orijinal ürün ID'si (KG ürününün ID'si)
                weightInGrams, // quantity olarak gramaj
                description, // Hızlı satışta açıklama yok
                true, // isCustomItem = true
                itemNameWithWeight, // Özel isim
                calculatedPrice, // Hesaplanmış fiyat
                category, // Kategori
                productId // originalProductId
            );
            weightInput.value = ''; // Gramaj inputunu temizle
        });
    });


    // Adet artırma/azaltma butonları (sadece standart ürünler için ve normal sipariş sayfasında)
    if (!forQuickSale) {
        targetGridElement.querySelectorAll('.quantity-decrease').forEach(btn => {
            btn.addEventListener('click', () => {
                const input = btn.nextElementSibling;
                let val = parseInt(input.value);
                if (val > 1) input.value = val - 1;
            });
        });
        targetGridElement.querySelectorAll('.quantity-increase').forEach(btn => {
            btn.addEventListener('click', () => {
                const input = btn.previousElementSibling;
                input.value = parseInt(input.value) + 1;
            });
        });
    }
}
    // Ürün kartından normal sipariş ekleme fonksiyonu
    function addProductFromCard(productId, quantity, description) {
         const product = appState.products.find(p => p.id === parseInt(productId));
         if (!product || quantity <= 0 || !appState.currentTableId) {
            alert("Ürün eklenirken bir hata oluştu.");
            return;
        }
        showLoading("Sipariş ekleniyor...");
        sendMessageToServer('add_order_item', {
            tableId: appState.currentTableId,
            productId: parseInt(productId),
            quantity: quantity,
            description: description
        });
        resetCurrentOrderDiscount();
    }

function addProductToOrder(productId, quantity, description, isCustomItem = false, customName = null, customPrice = null, customCategory = null, originalProdId = null) {
    if (!appState.currentTableId) {
        alert("Lütfen önce bir masa seçin."); return;
    }
    const product = appState.products.find(p => String(p.id) === String(productId));
    if (!isCustomItem && !product) {
        alert("Ürün bulunamadı veya geçersiz ürün ID'si."); return;
    }
    if (quantity <= 0) {
        alert("Miktar 0'dan büyük olmalıdır."); return;
    }

    const payload = {
        tableId: appState.currentTableId,
        quantity: quantity, // Standart için adet, ağırlıklı için gramaj
        description: description,
        isCustomItem: isCustomItem,
        isByWeightEntry: isCustomItem && product && product.isByWeight // Ağırlıklı ürün girişi mi?
    };

    if (isCustomItem) { // Ağırlıklı veya manuel fiyatlı ürün
        payload.name = customName;         // örn: "ET DÖNER - KG (250 gr)"
        payload.priceAtOrder = customPrice;  // Hesaplanmış TOPLAM fiyat
        payload.category = customCategory || (product ? product.category : 'DİĞER');
        payload.originalProductId = originalProdId || (product ? product.id : null); // Orijinal KG ürününün ID'si
        payload.productId = payload.originalProductId; // Sunucuda productId olarak orijinalini kullanabiliriz
    } else if (product) { // Standart ürün
        payload.productId = parseInt(product.id);
        payload.name = product.name;
        payload.priceAtOrder = product.price; // Standart ürünün BİRİM fiyatı
        payload.category = product.category;
    } else {
        alert("Siparişe eklenecek ürün bilgisi bulunamadı."); return;
    }
    
    showLoading("Sipariş ekleniyor...");
    sendMessageToServer('add_order_item', payload);
    resetCurrentOrderDiscount();
}




    
    // Hızlı satış sepetine ürün ekleme
function addProductToQuickSale(productId, quantity, description, isCustomItem = false, customName = null, customPrice = null, customCategory = null, originalProdId = null) {
    const product = appState.products.find(p => String(p.id) === String(productId));
    if (!isCustomItem && !product) {
        alert("Ürün hızlı satış sepetine eklenirken bir hata oluştu (ürün bulunamadı)."); return;
    }
    if (quantity <= 0) {
        alert("Miktar 0'dan büyük olmalıdır."); return;
    }

    let nameForQuickSale, priceForQuickSale, categoryForQuickSale, actualProductId;

    if (isCustomItem) { // Ağırlıklı ürün
        nameForQuickSale = customName;
        priceForQuickSale = customPrice; // Bu zaten hesaplanmış toplam fiyat
        categoryForQuickSale = customCategory || (product ? product.category : 'DİĞER');
        actualProductId = originalProdId || (product ? product.id : null);
    } else if (product) { // Standart ürün
        nameForQuickSale = product.name;
        priceForQuickSale = product.price * quantity; // Standart ürün için toplam fiyatı hesapla
        categoryForQuickSale = product.category;
        actualProductId = parseInt(product.id);
    } else {
        alert("Hızlı satışa eklenecek ürün bilgisi bulunamadı."); return;
    }

    // Hızlı satışta her eklemeyi yeni bir satır olarak düşünelim, birleştirme yapmayalım
    appState.currentQuickSaleOrder.push({
        productId: actualProductId, // Standart için kendi ID'si, ağırlıklı için KG ürününün ID'si
        name: nameForQuickSale,
        priceAtOrder: priceForQuickSale, // Bu satırın TOPLAM fiyatı
        quantity: quantity, // Standart için adet, ağırlıklı için gramaj
        description: description,
        category: categoryForQuickSale,
        waiterUsername: appState.user.username,
        timestamp: Date.now(),
        isCustomItem: isCustomItem,
        isByWeightEntry: isCustomItem && product && product.isByWeight,
        originalProductId: originalProdId
    });
    
    resetCurrentOrderDiscount();
    renderQuickSaleOrder(); // Sepeti güncelle
}

    // Manuel ürün ekleme için kategori seçeneklerini doldurur
    function populateManualCategorySelect() {
        manualProductCategory.innerHTML = '<option value="">Kategori Seçin</option>';
        const categories = ["ET - TAVUK", "ATIŞTIRMALIK", "İÇECEK", "TATLI", "ÇORBA"];
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            manualProductCategory.appendChild(option);
        });
    }

    // Yeni ürün ekleme modalı için kategori select'i doldurur
    function populateNewProductCategorySelect() {
        newProductCategorySelect.innerHTML = '<option value="">Mevcut Kategori Seçin</option>';
        const categories = ["ET - TAVUK", "ATIŞTIRMALIK", "İÇECEK", "TATLI", "ÇORBA"];
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            newProductCategorySelect.appendChild(option);
        });
        newProductCategorySelect.innerHTML += '<option value="YENI">** YENİ KATEGORİ **</option>';

        newProductCategorySelect.addEventListener('change', () => {
            if (newProductCategorySelect.value === 'YENI') {
                newProductCategoryInput.classList.remove('hidden');
                newProductCategoryInput.focus();
            } else {
                newProductCategoryInput.classList.add('hidden');
                newProductCategoryInput.value = '';
            }
        });
    }

    // Ürün düzenleme modalı için kategori select'i doldurur
    function populateEditProductCategorySelect() {
        editProductCategorySelect.innerHTML = '<option value="">Mevcut Kategori Seçin</option>';
        const categories = ["ET - TAVUK", "ATIŞTIRMALIK", "İÇECEK", "TATLI", "ÇORBA"];
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            editProductCategorySelect.appendChild(option);
        });
        editProductCategorySelect.innerHTML += '<option value="YENI_EDIT">** YENİ KATEGORİ **</option>';

        editProductCategorySelect.addEventListener('change', () => {
            if (editProductCategorySelect.value === 'YENI_EDIT') {
                editProductCategoryInput.classList.remove('hidden');
                editProductCategoryInput.focus();
            } else {
                editProductCategoryInput.classList.add('hidden');
                editProductCategoryInput.value = '';
            }
        });
    }


    function renderProductsForReference() {
        productsListRef.innerHTML = '';
        const categories = {};
        appState.products.forEach(product => {
             const categoryKey = product.category;
            if (!categories[categoryKey]) categories[categoryKey] = [];
            categories[categoryKey].push(product);
        });

        const categoryOrder = ["ÇORBA", "ET - TAVUK", "ATIŞTIRMALIK", "İÇECEK", "TATLI"];
        const sortedCategories = Object.keys(categories).sort((a, b) => {
            const indexA = categoryOrder.indexOf(a);
            const indexB = categoryOrder.indexOf(b);
            if (indexA === -1 && indexB === -1) return a.localeCompare(b, 'tr');
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
            return indexA - indexB;
        });

        sortedCategories.forEach(category => {
            if (!categoryOrder.includes(category)) return;

            const categoryTitle = document.createElement('h3');
            categoryTitle.className = 'text-lg font-semibold mt-4 mb-2 text-blue-700';
            categoryTitle.textContent = category;
            productsListRef.appendChild(categoryTitle);
            const ul = document.createElement('ul');
            ul.className = 'space-y-1';
            categories[category].sort((a,b) => a.name.localeCompare(b, 'tr')).forEach(product => {
                const li = document.createElement('li');
                li.className = 'text-sm text-gray-800 flex justify-between';
                li.innerHTML = `<span>${product.name}</span> <span class="font-medium">${formatPrice(product.price)}</span>`;
                ul.appendChild(li);
            });
            productsListRef.appendChild(ul);
        });
    }

    // Sipariş sayfasındaki mevcut siparişleri render eder
function renderOrderPageForTable(table) {
    orderPageCurrentOrderItems.innerHTML = '';
    appState.currentOrderOriginalTotal = 0;

    if (table.status === 'dolu' && table.waiterUsername) {
        orderPageWaiterInfo.textContent = `Bu Siparişi Alan Garson: ${table.waiterUsername}`;
    } else if (table.status === 'dolu' && !table.waiterUsername && appState.user && appState.user.role === 'cashier') {
         orderPageWaiterInfo.textContent = `Sipariş Alındı (Garson Belirsiz)`;
    } else {
        orderPageWaiterInfo.textContent = 'Bu Masaya Henüz Sipariş Alınmadı';
    }

    if (!table || !table.order || table.order.length === 0) {
        orderPageCurrentOrderItems.innerHTML = '<p class="text-gray-500 py-4 text-center">Sipariş boş.</p>';
    } else {
        let currentOrderGrandTotal = 0;
        table.order.forEach((item) => {
            const itemNameString = item.name; // Sunucudan gelen isim (örn: ET DÖNER - KG (500 gr))
            const itemPriceAtOrder = parseFloat(item.priceAtOrder) || 0; // Sunucudan gelen fiyat (ağırlıklı için toplam, standart için birim)
            const itemQuantity = parseFloat(item.quantity) || 0; // Sunucudan gelen miktar (ağırlıklı için gramaj, standart için adet)
            const itemDescription = item.description || '';

            let lineItemDisplayTotal;
            let quantityDisplayString;

            if (item.isCustomItem || item.isByWeightEntry) { // Ağırlıklı veya manuel fiyatlı ürün
                lineItemDisplayTotal = itemPriceAtOrder; // priceAtOrder zaten bu satırın toplam fiyatı
                quantityDisplayString = `(${itemQuantity} gr)`;
            } else { // Standart, adetli ürün
                lineItemDisplayTotal = itemPriceAtOrder * itemQuantity;
                quantityDisplayString = `(${itemQuantity} x ${formatPrice(itemPriceAtOrder)})`;
            }
            
            currentOrderGrandTotal += lineItemDisplayTotal;

            const orderItemDiv = document.createElement('div');
            orderItemDiv.className = 'flex justify-between items-start p-3 bg-gray-50 rounded-md shadow';
            let descriptionHTML = itemDescription ? `<p class="text-xs text-gray-500 italic ml-2 mt-1">(${itemDescription})</p>` : '';
            let waiterNameHTML = item.waiterUsername ? `<p class="text-xs text-blue-600 ml-2 mt-1">Ekleyen: ${item.waiterUsername} (${formatTimestamp(item.timestamp)})</p>` : '';

            orderItemDiv.innerHTML = `
                <div class="flex-grow">
                    <span class="font-medium">${itemNameString}</span>
                    <span class="text-sm text-gray-600"> ${quantityDisplayString}</span>
                    ${descriptionHTML}
                    ${waiterNameHTML}
                </div>
                <div class="flex items-center ml-2">
                    <span class="font-semibold mr-3">${formatPrice(lineItemDisplayTotal)}</span>
                    <button data-product-id="${item.originalProductId || item.productId || 'manual'}" 
                            data-item-name="${itemNameString}" 
                            data-item-description="${itemDescription}" 
                            class="remove-item-btn-orderpage text-red-500 hover:text-red-700 text-lg font-bold p-1 rounded-full hover:bg-red-100 transition-colors">&times;</button>
                </div>
            `;
            orderPageCurrentOrderItems.appendChild(orderItemDiv);
        });
        appState.currentOrderOriginalTotal = currentOrderGrandTotal;
    }

    if (appState.currentOrderDiscountAmount > 0 && appState.currentOrderOriginalTotal > 0) {
        const discounted = appState.currentOrderOriginalTotal - appState.currentOrderDiscountAmount;
        orderPageCurrentOrderTotal.textContent = `Toplam: ${formatPrice(discounted)} (İndirimli)`;
        discountInfoDiv.textContent = `İndirim Uygulandı: -${formatPrice(appState.currentOrderDiscountAmount)}`;
        discountInfoDiv.classList.remove('hidden');
    } else {
        orderPageCurrentOrderTotal.textContent = `Toplam: ${formatPrice(appState.currentOrderOriginalTotal)}`;
        discountInfoDiv.classList.add('hidden');
    }

    const isCashier = appState.user && appState.user.role === 'cashier';
    showReceiptButton.classList.toggle('hidden', !isCashier && (!table || !table.order || table.order.length === 0));
    finalizeAndCloseTableButton.classList.toggle('hidden', !isCashier);
    applyDiscountButton.classList.toggle('hidden', !isCashier);

    orderPageCurrentOrderItems.querySelectorAll('.remove-item-btn-orderpage').forEach(button => {
        button.addEventListener('click', (e) => {
            const btnElement = e.target.closest('button');
            const productIdToRemove = btnElement.dataset.productId;
            const descriptionToRemove = btnElement.dataset.itemDescription;
            const nameToRemove = btnElement.dataset.itemName; // Bu isim "ET DÖNER - KG (500 gr)" gibi olacak
            removeItemFromOrderPage(productIdToRemove, descriptionToRemove, nameToRemove);
        });
    });
}


    // Satış Raporu Modalı'nı render eder
    function renderSalesReport() {
        salesReportTableContainer.innerHTML = '';
        let totalItems = 0;
        let grandTotal = 0;

        if (!appState.salesReport || appState.salesReport.length === 0) {
            salesReportTableContainer.innerHTML = '<p class="text-center text-gray-500 py-6">Henüz tamamlanmış satış yok.</p>';
            totalItemsSoldSpan.textContent = '0';
            grandTotalSalesSpan.textContent = formatPrice(0);
            return;
        }

        const table = document.createElement('table');
        table.className = 'w-full text-sm border-collapse border border-gray-300';
        table.innerHTML = `
            <thead class="bg-gray-100">
                <tr>
                    <th class="border p-2">Kapanış Zamanı</th>
                    <th class="border p-2">Masa/Satış Tipi</th>
                    <th class="border p-2">Ürün</th>
                    <th class="border p-2 text-center">Adet</th>
                    <th class="border p-2 text-right">Birim Fiyat</th>
                    <th class="border p-2 text-right">Toplam</th>
                    <th class="border p-2">Garson/Kasa</th>
                    <th class="border p-2">Açıklama</th>
                    <th class="border p-2">Ekleme Zamanı</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        `;
        const tbody = table.querySelector('tbody');

        appState.salesReport.sort((a, b) => (b.closingTimestamp || 0) - (a.closingTimestamp || 0));

        appState.salesReport.forEach(item => {
    const currentItemTotalPrice = parseFloat(item.total_item_price) || 0;
    totalItems += parseInt(item.quantity, 10) || 0;
    grandTotal += currentItemTotalPrice;
    let itemName = item.item_name || 'Bilinmeyen';

    const tr = document.createElement('tr');
    tr.className = 'border-b hover:bg-gray-50';
    tr.innerHTML = `
        <td class="border p-2 whitespace-nowrap">${formatTimestamp(item.sale_timestamp)}</td>
        <td class="border p-2">${item.table_name || 'Hızlı Satış'}</td>
        <td class="border p-2">${itemName}</td>
        <td class="border p-2 text-center">${item.quantity}</td>
        <td class="border p-2 text-right">${formatPrice(parseFloat(item.item_price) || 0)}</td>
        <td class="border p-2 text-right">${formatPrice(currentItemTotalPrice)}</td>
        <td class="border p-2">${item.waiter_username || '-'}</td>
        <td class="border p-2">${item.description || '-'}</td>
        <td class="border p-2 whitespace-nowrap">${formatTimestamp(item.sale_timestamp)}</td>
    `;
    tbody.appendChild(tr);
});

        salesReportTableContainer.appendChild(table);
        totalItemsSoldSpan.textContent = totalItems;
        grandTotalSalesSpan.textContent = formatPrice(grandTotal);
    }


    // --- İşlevler ---
    function handleLogin() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        if (!username || !password) {
            showLoginError("Kullanıcı adı ve şifre boş bırakılamaz.");
            return;
        }
        loginError.textContent = '';
        showLoading("Giriş yapılıyor...");
        sendMessageToServer('login', { username, password });
    }

    function handleLogout() {
        confirmExitAppModal.classList.add('active');
    }

    function performLogout() {
        localStorage.removeItem('adisyonUser');
        sendMessageToServer('logout', {});
        appState.user = null;
        appState.tables = [];
        loginModal.classList.add('active');
        appContainer.classList.add('hidden');
        orderPageContainer.classList.remove('active');
        quickSaleModal.classList.remove('active');
        usernameInput.value = '';
        passwordInput.value = '';
        console.log("Çıkış yapıldı ve oturum temizlendi.");
        initialDataRendered = false;
        // WebView uygulamasını kapatmak için (eğer bir WebView içinde çalışıyorsa)
        if (window.ReactNativeWebView) { // React Native WebView için
            window.ReactNativeWebView.postMessage('closeApp');
        } else if (window.Android && typeof window.Android.closeApp === 'function') { // Özel Android Interface için
            window.Android.closeApp();
        } else {
            // Tarayıcıda çalışıyorsa veya kapatma desteklenmiyorsa, kullanıcıyı bilgilendir
            // alert("Uygulamadan çıkıldı. Pencereyi kapatabilirsiniz.");
            // Veya login ekranına yönlendir
            console.log("Uygulama kapatma simüle edildi (tarayıcı ortamı).");
        }
    }


    function showTablesView() {
        orderPageContainer.classList.remove('active');
        quickSaleModal.classList.remove('active');
        addProductToMenuModal.classList.remove('active');
        editProductModal.classList.remove('active');
        manageTablesModal.classList.remove('active');
        manageWaitersModal.classList.remove('active');
        receiptModal.classList.remove('active');
        confirmCloseTableModal.classList.remove('active');
        confirmDiscountModal.classList.remove('active');
        confirmDeleteTableModal.classList.remove('active');
        confirmDeleteWaiterModal.classList.remove('active');
        confirmExitAppModal.classList.remove('active');

        appContainer.classList.remove('hidden');
        appContainer.classList.add('block');

        appState.currentTableId = null;
        resetCurrentOrderDiscount();
        console.log("Masalar ekranına dönüldü.");
    }

    function selectTableForOrder(tableId) {
        appState.currentTableId = tableId;
        const table = appState.tables.find(t => t.id === tableId);
        if (table) {
            orderPageTableName.textContent = table.name;
            resetCurrentOrderDiscount();
            renderOrderPageForTable(table);
            updateUIForRole();
            appContainer.classList.add('hidden');
            orderPageContainer.classList.add('active');
        } else {
            console.error("Seçilen masa bulunamadı:", tableId);
            showTablesView();
        }
    }

    // Manuel ürün ekleme fonksiyonu
    function addManualProduct() {
        const name = manualProductName.value.trim();
        const category = manualProductCategory.value;
        const price = parseFloat(manualProductPrice.value);
        const quantity = parseInt(manualProductQuantity.value);
        const description = manualProductDescription.value.trim();

        if (!name || !category || isNaN(price) || price < 0 || isNaN(quantity) || quantity <= 0 || !appState.currentTableId) {
             alert("Lütfen geçerli bir ürün adı, kategori, fiyat ve adet girin.");
            return;
        }

        if (appState.user && appState.user.role !== 'cashier') {
            alert("Manuel ürün ekleme yetkiniz yok.");
            return;
        }

        showLoading("Manuel ürün ekleniyor...");
        sendMessageToServer('add_manual_order_item', {
            tableId: appState.currentTableId,
            name: name,
            category: category,
            price: price,
            quantity: quantity,
            description: description
        });
        resetCurrentOrderDiscount();

        manualProductName.value = '';
        manualProductCategory.value = '';
        manualProductPrice.value = '';
        manualProductQuantity.value = '1';
        manualProductDescription.value = '';
    }


    // Ürün silme fonksiyonu güncellendi
    function removeItemFromOrderPage(productIdToRemove, descriptionToRemove, nameToRemove) {
         if (!appState.currentTableId) return;
        showLoading("Ürün siliniyor...");
        sendMessageToServer('remove_order_item', {
            tableId: appState.currentTableId,
            productId: productIdToRemove === 'manual' ? null : parseInt(productIdToRemove),
            name: productIdToRemove === 'manual' ? nameToRemove : null,
            description: descriptionToRemove
        });
        resetCurrentOrderDiscount();
    }

    // Fiş modalını açar (Sadece Kasa için)
    function handleShowReceipt() {
        const table = appState.tables.find(t => t.id === appState.currentTableId);
        if (!table || !table.order || table.order.length === 0) {
            alert("Masada fiş kesilecek sipariş bulunmuyor.");
            return;
        }
        const finalTotal = appState.currentOrderDiscountAmount > 0 ? (appState.currentOrderOriginalTotal - appState.currentOrderDiscountAmount) : appState.currentOrderOriginalTotal;
        prepareAndShowReceipt(table.order, table.name, table.waiterUsername, appState.currentOrderOriginalTotal, appState.currentOrderDiscountAmount > 0 ? finalTotal : null);
    }

    // Masayı kapatma fonksiyonu (Sadece Kasa için)
    function handleFinalizeAndCloseTable() {
        if (appState.currentTableId && appState.user && appState.user.role === 'cashier') {
            confirmCloseTableModal.classList.add('active');
        } else {
            alert("Masayı kapatma yetkiniz yok.");
        }
    }

    // Personel İndirimi Uygulama Fonksiyonu (Normal Siparişler için)
    function handleApplyDiscount() {
        if (appState.user && appState.user.role === 'cashier' && appState.currentTableId) {
            const table = appState.tables.find(t => t.id === appState.currentTableId);
            if (table && table.order.length > 0) {
                appState.currentOrderOriginalTotal = table.total;
                confirmDiscountModal.classList.add('active');
            } else {
                alert("İndirim uygulanacak sipariş bulunmuyor.");
            }
        } else {
            alert("İndirim uygulama yetkiniz yok.");
        }
    }


function renderQuickSaleOrder() {
    if (!quickSaleCurrentItems || !quickSaleTotal) {
        console.error("Hızlı satış DOM elementleri bulunamadı!");
        return;
    }
    quickSaleCurrentItems.innerHTML = '';
    let originalTotal = 0;

    if (!appState.currentQuickSaleOrder || appState.currentQuickSaleOrder.length === 0) {
        quickSaleCurrentItems.innerHTML = '<p class="text-gray-500 text-center py-4">Sepet boş.</p>';
    } else {
        appState.currentQuickSaleOrder.forEach((item, index) => {
            const itemPrice = parseFloat(item.priceAtOrder) || 0;
            const itemQuantity = item.isCustomItem ? (parseFloat(item.quantity) || 0) : (parseInt(item.quantity, 10) || 0); // Ağırlıklı için float, adetli için int
            const itemTotal = itemPrice * (item.isCustomItem ? 1 : itemQuantity); // Ağırlıklı ürünlerin fiyatı zaten hesaplanmış geliyor (priceAtOrder)

            originalTotal += item.isCustomItem ? itemPrice : itemTotal; // Ağırlıklı ürünün fiyatı zaten toplamdır

            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex justify-between items-start p-2 bg-white rounded-md text-sm shadow';
            let descriptionHTML = item.description ? `<p class="text-xs text-gray-500 italic ml-2">(${item.description})</p>` : '';
            
            // Ağırlıklı ürünse adı zaten gramajı içerir, adet göstermeye gerek yok.
            const quantityDisplay = item.isCustomItem ? '' : ` (${itemQuantity} x ${formatPrice(item.priceAtOrder)})`;

            itemDiv.innerHTML = `
                <div class="flex-grow">
                    <span class="font-medium">${item.name}</span>
                    <span class="text-xs text-gray-600">${quantityDisplay}</span>
                    ${descriptionHTML}
                </div>
                <div class="flex items-center">
                    <span class="font-semibold mr-2">${formatPrice(item.isCustomItem ? itemPrice : itemTotal)}</span>
                    <button data-index="${index}" class="remove-item-quick-sale-btn text-red-500 hover:text-red-700 font-bold p-1 rounded-full hover:bg-red-100 transition-colors">&times;</button>
                </div>
            `;
            quickSaleCurrentItems.appendChild(itemDiv);
        });
    }
    appState.currentOrderOriginalTotal = originalTotal;

    if (appState.currentOrderDiscountAmount > 0 && originalTotal > 0) {
        const discountedTotal = originalTotal - appState.currentOrderDiscountAmount;
        quickSaleTotal.textContent = `Toplam: ${formatPrice(discountedTotal)} (İndirimli)`;
        if (quickSaleDiscountInfo) {
            quickSaleDiscountInfo.textContent = `İndirim Uygulandı: -${formatPrice(appState.currentOrderDiscountAmount)}`;
            quickSaleDiscountInfo.classList.remove('hidden');
        }
    } else {
        quickSaleTotal.textContent = `Toplam: ${formatPrice(originalTotal)}`;
        if (quickSaleDiscountInfo) quickSaleDiscountInfo.classList.add('hidden');
    }

    quickSaleCurrentItems.querySelectorAll('.remove-item-quick-sale-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const itemIndex = parseInt(e.target.closest('button').dataset.index);
            appState.currentQuickSaleOrder.splice(itemIndex, 1);
            resetCurrentOrderDiscount();
            renderQuickSaleOrder();
        });
    });
}



    

    // Personel İndirimi Uygulama Fonksiyonu (Hızlı Satış için)
    function handleApplyQuickSaleDiscount() {
        if (appState.user && appState.user.role === 'cashier') {
            if (appState.currentQuickSaleOrder.length > 0) {
                // Hızlı satış sepetinin orijinal toplamı renderQuickSaleOrder'da appState.currentOrderOriginalTotal'a atanmıştı.
                confirmDiscountModal.classList.add('active');
            } else {
                alert("Hızlı satış sepetinde indirim uygulanacak ürün bulunmuyor.");
            }
        } else {
            alert("İndirim uygulama yetkiniz yok.");
        }
    }

    // İndirimi sıfırlama fonksiyonu
    function resetCurrentOrderDiscount() {
        appState.currentOrderDiscountAmount = 0;
        discountInfoDiv.classList.add('hidden');
        discountInfoDiv.textContent = '';
        quickSaleDiscountInfo.classList.add('hidden');
        quickSaleDiscountInfo.textContent = '';

        if (orderPageContainer.classList.contains('active') && appState.currentTableId) {
            const table = appState.tables.find(t => t.id === appState.currentTableId);
            if (table) {
                orderPageCurrentOrderTotal.textContent = `Toplam: ${formatPrice(table.total)}`;
            }
        }
        if (quickSaleModal.classList.contains('active')) {
            renderQuickSaleOrder();
        }
    }


    // Hızlı Satış Modalını Açma
function openQuickSaleModal() {
    if (appState.user && appState.user.role === 'cashier') {
        appState.currentQuickSaleOrder = []; // Sepeti her açılışta sıfırla
        resetCurrentOrderDiscount();       // İndirimi sıfırla
        renderQuickSaleOrder();            // Sepeti ve toplamı render et (BOŞ OLARAK)
        renderProductGrid(quickSaleProductGrid, true); // Ürünleri render et
        
        quickSaleModal.classList.add('active');
        appContainer.classList.add('hidden');
        orderPageContainer.classList.remove('active');
    } else {
        alert("Bu özelliği kullanma yetkiniz yok.");
    }
}

    // Hızlı Satışı Tamamlama
   function completeQuickSale() {
    if (appState.currentQuickSaleOrder.length === 0) {
        alert("Hızlı satış sepeti boş."); return;
    }
    const customerName = quickSaleCustomerNameInput.value.trim(); // Müşteri adını input'tan al

    showLoading("Hızlı satış tamamlanıyor...");
    const finalTotal = appState.currentOrderDiscountAmount > 0 ? (appState.currentOrderOriginalTotal - appState.currentOrderDiscountAmount) : appState.currentOrderOriginalTotal;
    
    sendMessageToServer('complete_quick_sale', {
        items: appState.currentQuickSaleOrder,
        cashierUsername: appState.user.username,
        customerName: customerName, // Müşteri adını payload'a ekle
        originalTotal: appState.currentOrderOriginalTotal,
        discountAmount: appState.currentOrderDiscountAmount,
        finalTotal: finalTotal
    });
    prepareAndShowReceipt(appState.currentQuickSaleOrder, "Hızlı Satış", appState.user.username, appState.currentOrderOriginalTotal, finalTotal, customerName);
    quickSaleCustomerNameInput.value = ''; // Müşteri adı alanını temizle
}


    // Ortak fiş hazırlama fonksiyonu (indirimli toplamı alacak şekilde güncellendi)
  function prepareAndShowReceipt(orderItems, tableName, waiterName, originalTotal, finalTotalWithDiscount, customerName = null) {
    receiptDate.textContent = getCurrentFormattedDate();
    receiptTableName.textContent = tableName;
    receiptWaiterName.textContent = waiterName || (appState.user ? appState.user.username : "Bilinmiyor");
    receiptItems.innerHTML = '';

    // Müşteri adı için bir yer (fişin başında veya sonunda olabilir)
    const customerNameDiv = document.createElement('div');
    customerNameDiv.id = 'receiptCustomerName';
    customerNameDiv.className = 'text-sm mb-1';
    if (customerName) {
        customerNameDiv.innerHTML = `<span class="font-semibold">Müşteri:</span> ${customerName}`;
    }
    // Fiş içeriğine müşteri adını ekle (örneğin, masa bilgisinden sonra)
    const receiptHeaderInfo = receiptModalContent.querySelector('.mb-2'); // Masa ve garson bilgisinin olduğu div
    if (receiptHeaderInfo) {
        // Önce varsa eski müşteri adı div'ini kaldır
        const existingCustomerNameDiv = receiptModalContent.querySelector('#receiptCustomerName');
        if (existingCustomerNameDiv) existingCustomerNameDiv.remove();
        
        if(customerName) receiptHeaderInfo.appendChild(customerNameDiv);
    }


    orderItems.forEach(item => {
        let itemName = item.name; // Sunucudan gelen isim (örn: ET DÖNER - KG (500 gr))
        let itemPriceAtOrder = parseFloat(item.priceAtOrder) || 0; // Ağırlıklı için toplam, standart için birim
        let itemQuantity = parseFloat(item.quantity) || 0; // Ağırlıklı için gramaj, standart için adet

        let displayLineTotal;
        let quantityDisplay;

        if (item.isCustomItem || item.isByWeightEntry) {
            displayLineTotal = itemPriceAtOrder; // Bu zaten o satırın toplam fiyatı
            quantityDisplay = `(${itemQuantity} gr)`;
        } else {
            displayLineTotal = itemPriceAtOrder * itemQuantity;
            quantityDisplay = `(${itemQuantity} x ${formatPrice(itemPriceAtOrder)})`;
        }

        let descriptionHTML = item.description ? `<span class="item-description">(${item.description})</span>` : '';
        let itemWaiterHTML = item.waiterUsername && tableName !== "Hızlı Satış" ? `<span class="item-waiter">Ekleyen: ${item.waiterUsername} (${formatTimestamp(item.timestamp)})</span>` : '';
        
        const itemDiv = document.createElement('div');
        itemDiv.innerHTML = `
            <span class="item-details">${itemName} ${quantityDisplay} ${descriptionHTML} ${itemWaiterHTML}</span>
            <span class="item-price">${formatPrice(displayLineTotal)}</span>`;
        receiptItems.appendChild(itemDiv);
    });

    if (finalTotalWithDiscount < originalTotal && originalTotal > 0) {
        receiptSubtotal.textContent = formatPrice(originalTotal);
        receiptDiscountAmount.textContent = formatPrice(originalTotal - finalTotalWithDiscount);
        receiptGrandTotal.textContent = formatPrice(finalTotalWithDiscount);
        receiptDiscountInfo.classList.remove('hidden');
    } else {
        receiptGrandTotal.textContent = formatPrice(originalTotal);
        receiptDiscountInfo.classList.add('hidden');
    }
    receiptModal.classList.add('active');
}

    function handlePrintReceipt() {
        window.print();
    }

    // Satış raporu modalını açar ve veri ister
    function openSalesReport() {
        if (appState.user && appState.user.role === 'cashier') {
            showLoading("Satış raporu yükleniyor...");
            sendMessageToServer('get_sales_report', {});
            salesReportModal.classList.add('active');
        } else {
            alert("Bu özelliği kullanma yetkiniz yok.");
        }
    }

    // Satış raporunu yazdırır
    function printSalesReport() {
        window.print();
    }

    // Sadece fiş modalını kapatır
    function closeReceiptModalOnly() {
        receiptModal.classList.remove('active');
        const currentTable = appState.tables.find(t => t.id === appState.currentTableId);
        if (receiptTableName.textContent === "Hızlı Satış" || (currentTable && currentTable.status === 'boş')) {
            resetCurrentOrderDiscount();
            showTablesView();
        }
    }

    // Menüye ürün ekleme modalını açar
    function openAddProductToMenuModal() {
        if (appState.user && appState.user.role === 'cashier') {
            addProductToMenuModal.classList.add('active');
            populateNewProductCategorySelect();
            newProductNameInput.value = '';
            newProductPriceInput.value = '';
            newProductCategorySelect.value = '';
            newProductCategoryInput.value = '';
            newProductCategoryInput.classList.add('hidden');
        } else {
            alert("Bu özelliği kullanma yetkiniz yok.");
        }
    }

    // Menüye yeni ürün kaydeder
    function handleSaveNewProduct() {
        const name = newProductNameInput.value.trim();
        const price = parseFloat(newProductPriceInput.value);
        let category = newProductCategorySelect.value;
        const newCategoryName = newProductCategoryInput.value.trim().toUpperCase();

        if (category === 'YENI') {
            if (!newCategoryName) {
                alert("Lütfen yeni kategori adını girin.");
                return;
            }
            category = newCategoryName;
        }

        if (!name || isNaN(price) || price < 0 || !category) {
            alert("Lütfen geçerli ürün adı, fiyat ve kategori girin/seçin.");
            return;
        }

        showLoading("Yeni ürün menüye ekleniyor...");
        sendMessageToServer('add_product_to_main_menu', {
            name: name,
            price: price,
            category: category
        });
        addProductToMenuModal.classList.remove('active');
    }

    // Ürün Düzenleme Modalını Açma
    function openEditProductModal() {
        if (appState.user && appState.user.role === 'cashier') {
            populateSelectProductToEdit();
            editProductFormDiv.classList.add('hidden');
            editProductModal.classList.add('active');
        } else {
            alert("Bu özelliği kullanma yetkiniz yok.");
        }
    }

    // Düzenlenecek ürünler için select'i doldurur
    function populateSelectProductToEdit() {
        selectProductToEdit.innerHTML = '<option value="">-- Ürün Seçin --</option>';
        appState.products.sort((a,b) => a.name.localeCompare(b, 'tr')).forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} (${product.category}) - ${formatPrice(product.price)}`;
            selectProductToEdit.appendChild(option);
        });
    }

    // Seçilen ürünü düzenleme formuna yükler
    selectProductToEdit.addEventListener('change', () => {
        const productId = parseInt(selectProductToEdit.value);
        if (productId) {
            const product = appState.products.find(p => p.id === productId);
            if (product) {
                editingProductIdInput.value = product.id;
                editProductNameInput.value = product.name;
                editProductPriceInput.value = product.price.toFixed(2);

                populateEditProductCategorySelect();
                editProductCategorySelect.value = product.category;
                if (!editProductCategorySelect.value) {
                    editProductCategorySelect.value = "YENI_EDIT";
                    editProductCategoryInput.value = product.category;
                    editProductCategoryInput.classList.remove('hidden');
                } else {
                     editProductCategoryInput.classList.add('hidden');
                     editProductCategoryInput.value = '';
                }
                editProductFormDiv.classList.remove('hidden');
            }
        } else {
            editProductFormDiv.classList.add('hidden');
        }
    });

    // Düzenlenmiş ürünü kaydeder
    function handleSaveEditedProduct() {
        const productId = parseInt(editingProductIdInput.value);
        const name = editProductNameInput.value.trim();
        const price = parseFloat(editProductPriceInput.value);
        let category = editProductCategorySelect.value;
        const newCategoryName = editProductCategoryInput.value.trim().toUpperCase();

        if (category === 'YENI_EDIT') {
            if (!newCategoryName) {
                alert("Lütfen yeni kategori adını girin.");
                return;
            }
            category = newCategoryName;
        }

        if (!productId || !name || isNaN(price) || price < 0 || !category) {
            alert("Lütfen tüm alanları doğru bir şekilde doldurun.");
            return;
        }
        showLoading("Ürün güncelleniyor...");
        sendMessageToServer('update_main_menu_product', {
            id: productId,
            name: name,
            price: price,
            category: category
        });
        editProductModal.classList.remove('active');
    }

    // Masa Yönetimi Modalını Açma/Kapama ve Doldurma
    function openManageTablesModal() {
        if (appState.user && appState.user.role === 'cashier') {
            populateTableSelectsForManagement();
            manageTablesModal.classList.add('active');
        } else {
            alert("Bu özelliği kullanma yetkiniz yok.");
        }
    }
    function closeManageTablesModal() {
        manageTablesModal.classList.remove('active');
    }
    function populateTableSelectsForManagement() {
        selectTableToEditName.innerHTML = '<option value="">Düzenlenecek Masayı Seçin</option>';
        selectTableToDelete.innerHTML = '<option value="">Silinecek Masayı Seçin</option>';
        appState.tables.forEach(table => {
            const optionEdit = document.createElement('option');
            optionEdit.value = table.id;
            optionEdit.textContent = table.name;
            selectTableToEditName.appendChild(optionEdit);

            const optionDelete = document.createElement('option');
            optionDelete.value = table.id;
            optionDelete.textContent = table.name;
            selectTableToDelete.appendChild(optionDelete);
        });
        editTableNameInput.value = '';
    }

    // Yeni Masa Ekleme
    function handleAddNewTable() {
        const newName = newTableNameInput.value.trim();
        if (!newName) {
            alert("Lütfen yeni masa adı girin.");
            return;
        }
        showLoading("Yeni masa ekleniyor...");
        sendMessageToServer('add_table', { name: newName });
        newTableNameInput.value = '';
    }

    // Masa Adı Güncelleme
    function handleUpdateTableName() {
        const tableId = selectTableToEditName.value;
        const newName = editTableNameInput.value.trim();
        if (!tableId) {
            alert("Lütfen düzenlenecek masayı seçin.");
            return;
        }
        if (!newName) {
            alert("Lütfen yeni masa adını girin.");
            return;
        }
        showLoading("Masa adı güncelleniyor...");
        sendMessageToServer('edit_table_name', { tableId: tableId, newName: newName });
    }

    // Masa Silme (Onay ile)
    function handleDeleteTable() {
        const tableId = selectTableToDelete.value;
        if (!tableId) {
            alert("Lütfen silinecek masayı seçin.");
            return;
        }
        const table = appState.tables.find(t => t.id === tableId);
        if (table) {
            tableNameToDeleteSpan.textContent = table.name;
            confirmDeleteTableModal.classList.add('active');
        }
    }

    // Garson Yönetimi Modalını Açma/Kapama
    function openManageWaitersModal() {
        if (appState.user && appState.user.role === 'cashier') {
            sendMessageToServer('get_waiters_list', {});
            manageWaitersModal.classList.add('active');
        } else {
            alert("Bu özelliği kullanma yetkiniz yok.");
        }
    }
    function closeManageWaitersModal() {
        manageWaitersModal.classList.remove('active');
    }

    // Garson Yönetimi Modalındaki Select'leri Doldurma
    function populateWaiterSelectsForManagement() {
        selectWaiterToEditPassword.innerHTML = '<option value="">Düzenlenecek Garsonu Seçin</option>';
        selectWaiterToDelete.innerHTML = '<option value="">Silinecek Garsonu Seçin</option>';
        appState.waiters.forEach(waiter => {
            const optionEdit = document.createElement('option');
            optionEdit.value = waiter.id;
            optionEdit.textContent = waiter.username;
            selectWaiterToEditPassword.appendChild(optionEdit);

            const optionDelete = document.createElement('option');
            optionDelete.value = waiter.id;
            optionDelete.textContent = waiter.username;
            selectWaiterToDelete.appendChild(optionDelete);
        });
        editWaiterPasswordInput.value = '';
        newWaiterUsernameInput.value = '';
        newWaiterPasswordInput.value = '';
    }

    // Yeni Garson Ekleme
    function handleAddNewWaiter() {
        const username = newWaiterUsernameInput.value.trim();
        const password = newWaiterPasswordInput.value.trim();
        if (!username || !password) {
            alert("Lütfen garson kullanıcı adı ve şifresini girin.");
            return;
        }
        showLoading("Yeni garson ekleniyor...");
        sendMessageToServer('add_waiter', { username, password });
    }

    // Garson Şifresi Güncelleme
    function handleUpdateWaiterPassword() {
        const waiterId = selectWaiterToEditPassword.value;
        const newPassword = editWaiterPasswordInput.value.trim();
        if (!waiterId) {
            alert("Lütfen şifresi düzenlenecek garsonu seçin.");
            return;
        }
        if (!newPassword) {
            alert("Lütfen yeni şifreyi girin.");
            return;
        }
        showLoading("Garson şifresi güncelleniyor...");
        sendMessageToServer('edit_waiter_password', { userId: parseInt(waiterId), newPassword: newPassword });
    }

    // Garson Silme (Onay ile)
    let waiterIdToDelete = null;
    function handleDeleteWaiter() {
        const selectedWaiterId = selectWaiterToDelete.value;
        if (!selectedWaiterId) {
            alert("Lütfen silinecek garsonu seçin.");
            return;
        }
        const waiter = appState.waiters.find(w => w.id === parseInt(selectedWaiterId));
        if (waiter) {
            waiterIdToDelete = waiter.id;
            waiterNameToDeleteSpan.textContent = waiter.username;
            confirmDeleteWaiterModal.classList.add('active');
        }
    }


    // --- Event Listeners ---
    loginButton.addEventListener('click', handleLogin);
    passwordInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') handleLogin();
    });
    logoutButton.addEventListener('click', () => confirmExitAppModal.classList.add('active')); // Çıkış onayını göster
    confirmExitAppYesButton.addEventListener('click', () => {
        performLogout();
        confirmExitAppModal.classList.remove('active');
    });
    confirmExitAppNoButton.addEventListener('click', () => {
        confirmExitAppModal.classList.remove('active');
    });

    salesReportButton.addEventListener('click', openSalesReport);
    quickSaleEntryButton.addEventListener('click', openQuickSaleModal);
    addProductToMenuButton.addEventListener('click', openAddProductToMenuModal);
    editProductMenuButton.addEventListener('click', openEditProductModal);
    manageTablesButton.addEventListener('click', openManageTablesModal);
    manageWaitersButton.addEventListener('click', openManageWaitersModal);

    closeAddProductToMenuModalButton.addEventListener('click', () => addProductToMenuModal.classList.remove('active'));
    saveNewProductButton.addEventListener('click', handleSaveNewProduct);
    closeEditProductModalButton.addEventListener('click', () => editProductModal.classList.remove('active'));
    saveEditedProductButton.addEventListener('click', handleSaveEditedProduct);
    closeManageTablesModalButton.addEventListener('click', closeManageTablesModal);
    addNewTableButton.addEventListener('click', handleAddNewTable);
    updateTableNameButton.addEventListener('click', handleUpdateTableName);
    deleteTableButton.addEventListener('click', handleDeleteTable);
    confirmDeleteTableYesButton.addEventListener('click', () => {
        const tableId = selectTableToDelete.value;
        if (tableId) {
            showLoading("Masa siliniyor...");
            sendMessageToServer('delete_table', { tableId: tableId });
        }
        confirmDeleteTableModal.classList.remove('active');
    });
    confirmDeleteTableNoButton.addEventListener('click', () => {
        confirmDeleteTableModal.classList.remove('active');
    });

    closeManageWaitersModalButton.addEventListener('click', closeManageWaitersModal);
    addNewWaiterButton.addEventListener('click', handleAddNewWaiter);
    updateWaiterPasswordButton.addEventListener('click', handleUpdateWaiterPassword);
    deleteWaiterButton.addEventListener('click', handleDeleteWaiter);
    confirmDeleteWaiterYesButton.addEventListener('click', () => {
        if (waiterIdToDelete) {
            showLoading("Garson siliniyor...");
            sendMessageToServer('delete_waiter', { userId: waiterIdToDelete });
            waiterIdToDelete = null;
        }
        confirmDeleteWaiterModal.classList.remove('active');
    });
    confirmDeleteWaiterNoButton.addEventListener('click', () => {
        waiterIdToDelete = null;
        confirmDeleteWaiterModal.classList.remove('active');
    });


    closeQuickSaleModalButton.addEventListener('click', () => {
        quickSaleModal.classList.remove('active');
        resetCurrentOrderDiscount();
        showTablesView();
    });
    completeQuickSaleButton.addEventListener('click', completeQuickSale);
    applyQuickSaleDiscountButton.addEventListener('click', handleApplyQuickSaleDiscount);

    backToTablesButton.addEventListener('click', showTablesView);
    addManualProductButton.addEventListener('click', addManualProduct);
    showReceiptButton.addEventListener('click', handleShowReceipt);
    finalizeAndCloseTableButton.addEventListener('click', handleFinalizeAndCloseTable);
    applyDiscountButton.addEventListener('click', handleApplyDiscount);

    printReceiptButton.addEventListener('click', handlePrintReceipt);
    closeReceiptModalOnlyButton.addEventListener('click', closeReceiptModalOnly);

    // Masa Kapatma Onay Modalı Butonları
    confirmCloseTableYesButton.addEventListener('click', () => {
        if (appState.currentTableId && appState.user && appState.user.role === 'cashier') {
            showLoading("Masa kapatılıyor ve hesap tamamlanıyor...");
            sendMessageToServer('close_table', { tableId: appState.currentTableId });
            resetCurrentOrderDiscount();
        }
        confirmCloseTableModal.classList.remove('active');
    });
    confirmCloseTableNoButton.addEventListener('click', () => {
        confirmCloseTableModal.classList.remove('active');
    });

    // Personel İndirimi Onay Modalı Butonları
    confirmDiscountYesButton.addEventListener('click', () => {
        let originalTotalForDiscount = 0;
        let targetDiscountInfoDiv = null;
        let targetTotalDisplayElement = null;
        let isQuickSaleContext = quickSaleModal.classList.contains('active');

        if (!isQuickSaleContext && orderPageContainer.classList.contains('active') && appState.currentTableId) {
            const table = appState.tables.find(t => t.id === appState.currentTableId);
            if (table && table.order.length > 0) {
                originalTotalForDiscount = table.total;
                targetDiscountInfoDiv = discountInfoDiv;
                targetTotalDisplayElement = orderPageCurrentOrderTotal;
            }
        } else if (isQuickSaleContext) {
            if (appState.currentQuickSaleOrder.length > 0) {
                originalTotalForDiscount = appState.currentQuickSaleOrder.reduce((sum, item) => sum + (item.priceAtOrder * item.quantity), 0);
                appState.currentOrderOriginalTotal = originalTotalForDiscount;
                targetDiscountInfoDiv = quickSaleDiscountInfo;
                targetTotalDisplayElement = quickSaleTotal;
            }
        }

        if (originalTotalForDiscount > 0 && targetTotalDisplayElement) {
            const discountAmount = originalTotalForDiscount * 0.30;
            appState.currentOrderDiscountAmount = discountAmount;

            const discountedTotal = originalTotalForDiscount - discountAmount;
            targetTotalDisplayElement.textContent = `Toplam: ${formatPrice(discountedTotal)} (İndirimli)`;
            if(targetDiscountInfoDiv) {
                targetDiscountInfoDiv.textContent = `İndirim Uygulandı: -${formatPrice(discountAmount)}`;
                targetDiscountInfoDiv.classList.remove('hidden');
            }
            console.log("Personel indirimi uygulandı. Yeni toplam:", discountedTotal);
        }
        confirmDiscountModal.classList.remove('active');
    });
    confirmDiscountNoButton.addEventListener('click', () => {
        confirmDiscountModal.classList.remove('active');
    });


    closeSalesReportModalButton.addEventListener('click', () => salesReportModal.classList.remove('active'));
    refreshSalesReportButton.addEventListener('click', () => {
        showLoading("Rapor güncelleniyor...");
        sendMessageToServer('get_sales_report', {});
    });
    printSalesReportButton.addEventListener('click', printSalesReport);


    // Başlangıç
    document.addEventListener('DOMContentLoaded', () => {
        connectWebSocket();
    });

</script>
</body>
</html>
