<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMET LEZZET GÜNLERİ ADİSYON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
        }
        .modal { display: none; animation: fadeIn 0.3s ease-out; }
        .modal.active { display: flex; }
        #orderPageContainer, #quickSaleModal, #addProductToMenuModal, #editProductModal, #manageTablesModal, #manageWaitersModal, #confirmDeleteTableModal, #confirmDeleteWaiterModal, #confirmExitAppModal, #receiptModal, #salesReportModal, #confirmCloseTableModal, #confirmDiscountModal {
            display: none;
        }
        #appContainer.active, /* Ana container için de active class'ı eklenebilir */
        #orderPageContainer.active, /* Bu block yerine flex ve ortalama daha iyi olabilir eğer tam sayfa modal ise */
        #quickSaleModal.active, #addProductToMenuModal.active, #editProductModal.active,
        #manageTablesModal.active, #manageWaitersModal.active, #confirmDeleteTableModal.active,
        #confirmDeleteWaiterModal.active, #confirmExitAppModal.active, #receiptModal.active,
        #salesReportModal.active, #confirmCloseTableModal.active, #confirmDiscountModal.active {
            display: flex; /* Çoğu modal için flex daha iyi */
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75);
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
            overflow-y: auto;
        }
        #appContainer.active { display: block; position: static; background-color: transparent; overflow-y: visible; padding: 0;} /* appContainer özel */
        #orderPageContainer.active { background-color: #f3f4f6; display:block; position: fixed; /* Sipariş sayfası için */ }


        /* Modal içeriklerinin ortalanması için (içerik kendi genişliğine sahip olacak) */
        #loginModal .bg-white, /* Login modalı zaten ortalı */
        #quickSaleModal > div,
        #addProductToMenuModal > div > div, /* .modal-content gibi bir sarmalayıcı varsa */
        #editProductModal > div > div,
        #manageTablesModal > div > div,
        #manageWaitersModal > div > div,
        #confirmDeleteTableModal > div > div,
        #confirmDeleteWaiterModal > div > div,
        #confirmExitAppModal > div > div,
        #receiptModal > #receiptModalContent,
        #salesReportModal > #salesReportModalContent,
        #confirmCloseTableModal > div,
        #confirmDiscountModal > div {
             background-color: white;
             padding: 1.5rem;
             border-radius: 0.5rem;
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
             max-height: 90vh;
             overflow-y: auto;
        }


        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        #loadingOverlay { display: none; }
        #loadingOverlay.active { display: flex; }

        .product-card-quantity input { width: 40px; text-align: center; border: 1px solid #d1d5db; padding-top: 0.1rem; padding-bottom: 0.1rem;}
        .product-card-quantity button { min-width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; }
        .category-section-bg-ET-TAVUK { background-color: #fee2e2; } .category-section-bg-ATIŞTIRMALIK { background-color: #ffedd5; }
        .category-section-bg-TATLI { background-color: #fce7f3; } .category-section-bg-İÇECEK { background-color: #eff6ff; }
        .category-section-bg-ÇORBA { background-color: #fef9c3; } .category-section-bg-DİĞER { background-color: #dcfce7; }
        .category-section-bg-default { background-color: #f3f4f6; }
        .product-card-bg-ET-TAVUK { background-color: #fecaca; } .product-card-bg-ATIŞTIRMALIK { background-color: #fed7aa; }
        .product-card-bg-TATLI { background-color: #fbcfe8; } .product-card-bg-İÇECEK { background-color: #dbeafe; }
        .product-card-bg-ÇORBA { background-color: #fef08a; } .product-card-bg-DİĞER { background-color: #bbf7d0; }
        .product-card-bg-default { background-color: #e5e7eb; }
        .product-card {
            border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 0.75rem; transition: transform 0.2s ease-in-out; display: flex; flex-direction: column;
            justify-content: space-between; min-height: 120px;
        }
        .product-card.quick-sale-card { min-height: 80px; padding: 0.5rem; justify-content: center; }
        .product-card:hover { transform: translateY(-2px); }
        .product-card h5 { font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; font-size: 0.875rem; }
        .product-card.quick-sale-card h5 {
            font-size: 0.9rem; text-align: center; margin-bottom: 0.5rem; line-height: 1.2; min-height: 2.4em;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis;
        }
        .product-card p.product-price { color: #4b5563; font-size: 0.8rem; margin-bottom: 0.5rem; }
        .product-card .description-input { margin-top: 0.5rem; margin-bottom: 0.5rem; background-color: #fff; }
        .product-card .add-item-from-card-btn { margin-top: auto; }
        .product-card.quick-sale-card .add-item-from-card-btn { padding-top: 0.75rem; padding-bottom: 0.75rem; font-size: 1rem; font-weight: bold; }

        @media print {
            body * { visibility: hidden; }
            #receiptModalContent, #receiptModalContent * { visibility: visible; }
            #receiptModalContent { position: absolute; left: 0; top: 0; width: 100mm !important; font-size: 9pt !important; padding: 4mm !important; box-sizing: border-box !important; border: 1px solid #ccc !important; }
            #salesReportModalContent, #salesReportModalContent * { visibility: visible; }
            #salesReportModalContent { position: absolute; left: 0; top: 0; width: 100% !important; font-size: 10pt !important; padding: 10mm !important; box-sizing: border-box !important; }
            #salesReportModalContent table { width: 100% !important; border-collapse: collapse !important; }
            #salesReportModalContent th, #salesReportModalContent td { border: 1px solid #ccc !important; padding: 2mm !important; text-align: left !important; }
            #salesReportModalContent th { background-color: #eee !important; }
            .no-print, #receiptModalContent button, #salesReportModalContent button:not(#printSalesReportButton), #quickSaleModal button:not(#printReceiptButton), #appContainer button#logoutButton, #appContainer #exportDataButton, #orderPageContainer button:not(#printReceiptButton):not(#closeReceiptModalOnlyButton):not(#finalizeAndCloseTableButton), #confirmCloseTableModal button, #confirmDiscountModal button, #addProductToMenuModal button, #editProductModal button, #manageTablesModal button, #manageWaitersModal button, #confirmDeleteTableModal button, #confirmDeleteWaiterModal button, #confirmExitAppModal button, #quickSaleButtonContainerTop, #salesReportButton, #addProductToMenuButton, #editProductMenuButton, #manageTablesButton, #manageWaitersButton { display: none !important; }
            #receiptModalContent h2 { font-size: 11pt !important; font-weight: bold !important; margin-bottom: 3mm !important; text-align: center !important; }
            #receiptModalContent p, #receiptModalContent div#receiptItems > div { line-height: 1.3 !important; margin-bottom: 1mm !important; }
            #receiptModalContent div#receiptItems > div { display: flex !important; justify-content: space-between !important; flex-wrap: wrap !important; }
            #receiptModalContent div#receiptItems span.item-details { flex-basis: 70% !important; }
            #receiptModalContent div#receiptItems span.item-price { flex-basis: 30% !important; text-align: right !important; }
            #receiptModalContent div#receiptItems span.item-description, #receiptModalContent div#receiptItems span.item-waiter { display: block !important; font-size: 7pt !important; padding-left: 5mm !important; color: #555 !important; flex-basis: 100% !important;}
            #receiptModalContent .discount-info { font-weight: bold !important; color: #dc2626 !important; }
            #receiptModalContent hr { margin-top: 2mm !important; margin-bottom: 2mm !important; border-top: 1px dashed #999 !important; }
            #receiptModalContent .text-right p#receiptTotalLine { font-size: 10pt !important; font-weight: bold !important; }
            #receiptModalContent p.thank-you-note { margin-top: 4mm !important; text-align: center !important; font-size: 8pt !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="loadingOverlay" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-[60]">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
        <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loadingMessage" class="text-lg font-medium text-gray-700">Bağlanılıyor...</p>
    </div>
</div>

<div id="loginModal" class="modal items-center justify-center z-50 active"> <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-2xl font-semibold mb-6 text-center text-blue-600">Kullanıcı Girişi</h2>
        <p class="text-sm text-gray-500 text-center mb-4">Garson veya Kasa olarak giriş yapın.</p>
        <input type="text" id="usernameInput" placeholder="Kullanıcı Adı" class="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <input type="password" id="passwordInput" placeholder="Şifre" class="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <button id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded-md transition duration-150">Giriş Yap</button>
        <p id="loginError" class="text-red-500 text-sm mt-2 text-center"></p>
    </div>
</div>

<div id="appContainer" class="container mx-auto p-4 md:p-8"> <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
        <div>
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700">EMET LEZZET GÜNLERİ ADİSYON</h1>
            <p class="text-gray-600 mt-1">Aktif Kullanıcı: <span id="activeUserName" class="font-semibold"></span> (<span id="activeUserRole" class="capitalize"></span>)</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <button id="manageWaitersButton" class="bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Garson Yönetimi</button>
            <button id="manageTablesButton" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Masalar Yönetimi</button>
            <button id="editProductMenuButton" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Ürün Düzenleme</button>
            <button id="addProductToMenuButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Menüye Ürün Ekle</button>
            <button id="salesReportButton" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Satış Raporlama</button>
            <button id="exportDataButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden no-print">
                Satışları İndir (JSON)
            </button>
            <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Uygulamadan Çık</button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <main class="md:col-span-2">
            <section id="tablesSection" class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Masalar</h2>
                </div>
                <div id="quickSaleButtonContainerTop" class="mb-6 hidden">
                    <button id="quickSaleEntryButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-6 rounded-xl shadow-lg text-2xl transition duration-150 transform hover:scale-105">
                        HIZLI SATIŞ
                    </button>
                </div>
                <div id="tablesGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </section>
        </main>
        <aside class="md:col-span-1">
            <section id="productsReferenceSection" class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Güncel Menü</h2>
                <div class="bg-white p-6 rounded-lg shadow max-h-[70vh] overflow-y-auto">
                    <div id="productsListRef"></div>
                </div>
            </section>
        </aside>
    </div>
</div>

<div id="orderPageContainer" class="p-4 md:p-8"> <header class="mb-6 flex flex-wrap justify-between items-center">
        <div class="w-full md:w-auto mb-2 md:mb-0">
            <h2 class="text-3xl font-semibold text-blue-700">Sipariş: <span id="orderPageTableName"></span></h2>
            <p id="orderPageWaiterInfo" class="text-sm text-gray-600 mt-1">Bu Masaya Henüz Sipariş Alınmadı</p>
        </div>
        <button id="backToTablesButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 no-print">Masalara Dön</button>
    </header>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <section class="lg:col-span-2 bg-white p-6 rounded-lg shadow">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Ürün Seçimi</h3>
            <div id="orderPageProductGrid" class="space-y-6 max-h-[calc(100vh-280px)] md:max-h-[calc(100vh-250px)] overflow-y-auto pr-2"></div>
            <div id="manualProductSection" class="mt-6 pt-6 border-t border-gray-200 hidden">
                <h3 class="text-lg font-semibold mb-3 text-orange-600">Manuel Ürün Ekle (Sadece Kasa)</h3>
                <div class="space-y-3">
                    <input type="text" id="manualProductName" placeholder="Ürün Adı" class="w-full p-2 border border-gray-300 rounded-md">
                    <div>
                        <label for="manualProductCategory" class="block text-sm font-medium text-gray-600 mb-1">Kategori:</label>
                        <select id="manualProductCategory" class="w-full p-2 border border-gray-300 rounded-md"><option value="">Kategori Seçin</option></select>
                    </div>
                    <input type="number" id="manualProductPrice" placeholder="Fiyat (₺)" step="0.01" min="0" class="w-full p-2 border border-gray-300 rounded-md">
                    <input type="number" id="manualProductQuantity" placeholder="Adet" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md">
                    <input type="text" id="manualProductDescription" placeholder="Açıklama (isteğe bağlı)" class="w-full p-2 border border-gray-300 rounded-md">
                    <button id="addManualProductButton" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold p-2 rounded-md">Manuel Ürünü Siparişe Ekle</button>
                </div>
            </div>
        </section>
        <section class="lg:col-span-1 bg-white p-6 rounded-lg shadow">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Mevcut Sipariş</h3>
            <div id="orderPageCurrentOrderItems" class="space-y-3 max-h-[calc(100vh-380px)] md:max-h-[calc(100vh-350px)] overflow-y-auto pr-2"></div>
            <div id="orderPageCurrentOrderTotal" class="text-right font-bold text-2xl mt-6 text-gray-800">Toplam: 0 ₺</div>
            <div id="discountInfo" class="text-right text-sm text-red-600 mt-1 hidden"></div>
            <div class="mt-6 space-y-3">
                <button id="applyDiscountButton" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold p-3 rounded-md hidden">Personel İndirimi (%30)</button>
                <button id="showReceiptButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md">Fiş Göster/Yazdır</button>
                <button id="finalizeAndCloseTableButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold p-3 rounded-md hidden">Masayı Kapat</button>
            </div>
        </section>
    </div>
</div>

<div id="quickSaleModal" class="modal">
    <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl w-full max-w-7xl max-h-[95vh] flex flex-col">
        <header class="mb-4 flex justify-between items-center">
            <h2 class="text-2xl font-semibold text-green-700">Hızlı Satış</h2>
            <button id="closeQuickSaleModalButton" class="text-gray-500 hover:text-gray-700 text-2xl no-print">&times;</button>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-grow overflow-hidden">
            <section class="md:col-span-2 bg-gray-50 p-3 rounded-lg shadow-inner overflow-y-auto max-h-[calc(95vh-200px)]">
                <h3 class="text-lg font-semibold mb-3 text-gray-700">Ürün Seçimi</h3>
                <div id="quickSaleProductGrid" class="space-y-4"></div>
            </section>
            <section class="md:col-span-1 bg-gray-50 p-3 rounded-lg shadow-inner flex flex-col max-h-[calc(95vh-200px)]">
                <h3 class="text-lg font-semibold mb-3 text-gray-700">Hızlı Satış Sepeti</h3>
                <div id="quickSaleCurrentItems" class="space-y-2 flex-grow overflow-y-auto">
                    <p class="text-gray-500 text-center py-4">Sepet boş.</p>
                </div>
                <div id="quickSaleTotal" class="text-right font-bold text-xl mt-4 pt-2 border-t">Toplam: 0 ₺</div>
                <div id="quickSaleDiscountInfo" class="text-right text-sm text-red-600 mt-1 hidden"></div>
                <div class="mt-4 space-y-2">
                    <button id="applyQuickSaleDiscountButton" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold p-2 rounded-md">Personel İndirimi (%30)</button>
                    <button id="completeQuickSaleButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold p-3 rounded-md">Satışı Tamamla</button>
                </div>
            </section>
        </div>
    </div>
</div>

<div id="receiptModal" class="modal">
    <div id="receiptModalContent" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
        <div class="flex-grow overflow-y-auto">
            <h2 class="text-2xl font-bold text-center mb-2 text-gray-800">EMET LEZZET GÜNLERİ</h2>
            <p class="text-center text-sm text-gray-600 mb-1">Fiş/Adisyon</p>
            <p class="text-center text-sm text-gray-600 mb-4">Tarih: <span id="receiptDate"></span></p>
            <div class="mb-2">
                <p class="text-sm"><span class="font-semibold">Masa:</span> <span id="receiptTableName"></span></p>
                <p class="text-sm"><span class="font-semibold">Garson/Kasa:</span> <span id="receiptWaiterName">Bilinmiyor</span></p>
            </div>
            <hr class="my-2 border-gray-300">
            <div id="receiptItems" class="text-sm space-y-1 mb-2"></div>
            <div id="receiptDiscountInfo" class="text-sm my-2 hidden">
                <hr class="my-1 border-gray-300">
                <div class="flex justify-between"><span>Ara Toplam:</span><span id="receiptSubtotal">0 ₺</span></div>
                <div class="flex justify-between text-red-600"><span>İndirim (%30):</span><span>-<span id="receiptDiscountAmount">0 ₺</span></span></div>
            </div>
            <hr class="my-2 border-dashed border-gray-400">
            <div class="text-right"><p id="receiptTotalLine" class="text-lg font-bold text-gray-800">GENEL TOPLAM: <span id="receiptGrandTotal"></span> ₺</p></div>
            <p class="thank-you-note text-center text-xs text-gray-500 mt-6">Teşekkür Ederiz!</p>
        </div>
        <div class="mt-auto pt-4 flex space-x-2 no-print">
            <button id="printReceiptButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md">Yazdır</button>
            <button id="closeReceiptModalOnlyButton" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold p-3 rounded-md">Kapat</button>
        </div>
    </div>
</div>

<div id="confirmCloseTableModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Masayı Kapat Onayı</h2>
        <p class="text-gray-600 mb-6">Masayı kapatmak ve hesabı tamamlamak istediğinizden emin misiniz?</p>
        <div class="flex justify-center gap-4">
            <button id="confirmCloseTableYesButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-md">Evet, Kapat</button>
            <button id="confirmCloseTableNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md">Hayır</button>
        </div>
    </div>
</div>

<div id="confirmDiscountModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-xl font-semibold mb-4 text-yellow-600">Personel İndirimi</h2>
        <p class="text-gray-600 mb-6">%30 personel indirimi uygulansın mı?</p>
        <div class="flex justify-center gap-4">
            <button id="confirmDiscountYesButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-md">Evet, Uygula</button>
            <button id="confirmDiscountNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md">Hayır</button>
        </div>
    </div>
</div>

<div id="addProductToMenuModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-indigo-600">Menüye Yeni Ürün Ekle</h2>
            <button id="closeAddProductToMenuModalButton" class="text-gray-500 hover:text-gray-700 text-2xl no-print">&times;</button>
        </div>
        <div class="space-y-4">
            <input type="text" id="newProductName" placeholder="Ürün Adı" class="w-full p-3 border border-gray-300 rounded-md">
            <input type="number" id="newProductPrice" placeholder="Fiyat (₺)" step="0.01" min="0" class="w-full p-3 border border-gray-300 rounded-md">
            <div>
                <label for="newProductCategory" class="block text-sm font-medium text-gray-600 mb-1">Kategori:</label>
                <select id="newProductCategory" class="w-full p-3 border border-gray-300 rounded-md"><option value="">Mevcut Seçin</option></select>
            </div>
            <input type="text" id="newProductCategoryInput" placeholder="Veya Yeni Kategori Adı" class="w-full p-3 border border-gray-300 rounded-md mt-2 hidden">
            <button id="saveNewProductButton" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold p-3 rounded-md">Kaydet</button>
        </div>
    </div>
</div>

<div id="editProductModal" class="modal">
     <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-purple-600">Ürün Düzenle</h2>
            <button id="closeEditProductModalButton" class="text-gray-500 hover:text-gray-700 text-2xl no-print">&times;</button>
        </div>
        <div id="editProductSelectionDiv" class="space-y-4">
            <label for="selectProductToEdit" class="block text-sm font-medium text-gray-700">Ürün Seçin:</label>
            <select id="selectProductToEdit" class="w-full p-3 border border-gray-300 rounded-md"><option value="">-- Seç --</option></select>
        </div>
        <div id="editProductFormDiv" class="space-y-4 mt-4 hidden">
            <input type="hidden" id="editingProductId">
            <div><label for="editProductName" class="block text-sm font-medium">Adı:</label><input type="text" id="editProductName" class="w-full p-3 border"></div>
            <div><label for="editProductPrice" class="block text-sm font-medium">Fiyat (₺):</label><input type="number" id="editProductPrice" step="0.01" min="0" class="w-full p-3 border"></div>
            <div><label for="editProductCategory" class="block text-sm font-medium">Kategori:</label><select id="editProductCategory" class="w-full p-3 border"><option value="">Mevcut Seçin</option></select></div>
            <input type="text" id="editProductCategoryInput" placeholder="Veya Yeni Kategori" class="w-full p-3 border mt-2 hidden">
            <button id="saveEditedProductButton" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold p-3 rounded-md">Kaydet</button>
        </div>
    </div>
</div>

<div id="manageTablesModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
        <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold text-orange-600">Masalar Yönetimi</h2><button id="closeManageTablesModalButton" class="text-gray-500 hover:text-gray-700 text-2xl no-print">&times;</button></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                <h3 class="text-lg font-medium">Yeni Masa Ekle</h3>
                <input type="text" id="newTableNameInput" placeholder="Yeni Masa Adı" class="w-full p-3 border">
                <button id="addNewTableButton" class="w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-md">Ekle</button>
            </div>
            <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                <h3 class="text-lg font-medium">Masa Adı Düzenle</h3>
                <select id="selectTableToEditName" class="w-full p-3 border"><option value="">Masa Seç</option></select>
                <input type="text" id="editTableNameInput" placeholder="Yeni Adı" class="w-full p-3 border">
                <button id="updateTableNameButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-md">Güncelle</button>
            </div>
            <div class="space-y-4">
                <h3 class="text-lg font-medium">Masa Sil</h3>
                <select id="selectTableToDelete" class="w-full p-3 border"><option value="">Masa Seç</option></select>
                <button id="deleteTableButton" class="w-full bg-red-500 hover:bg-red-600 text-white p-3 rounded-md">Sil</button>
            </div>
        </div>
    </div>
</div>
<div id="confirmDeleteTableModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-xl font-semibold mb-4 text-red-600">Masayı Sil Onayı</h2>
        <p class="text-gray-600 mb-6">"<span id="tableNameToDeleteSpan"></span>" silinsin mi?</p>
        <div class="flex justify-center gap-4">
            <button id="confirmDeleteTableYesButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-md">Evet</button>
            <button id="confirmDeleteTableNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md">Hayır</button>
        </div>
    </div>
</div>

<div id="manageWaitersModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl">
        <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold text-pink-600">Garson Yönetimi</h2><button id="closeManageWaitersModalButton" class="text-gray-500 hover:text-gray-700 text-2xl no-print">&times;</button></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                <h3 class="text-lg font-medium">Yeni Garson Ekle</h3>
                <input type="text" id="newWaiterUsernameInput" placeholder="Kullanıcı Adı" class="w-full p-3 border">
                <input type="password" id="newWaiterPasswordInput" placeholder="Şifre" class="w-full p-3 border">
                <button id="addNewWaiterButton" class="w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-md">Ekle</button>
            </div>
            <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                <h3 class="text-lg font-medium">Şifre Düzenle</h3>
                <select id="selectWaiterToEditPassword" class="w-full p-3 border"><option value="">Garson Seç</option></select>
                <input type="password" id="editWaiterPasswordInput" placeholder="Yeni Şifre" class="w-full p-3 border">
                <button id="updateWaiterPasswordButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-md">Güncelle</button>
            </div>
            <div class="space-y-4">
                <h3 class="text-lg font-medium">Garson Sil</h3>
                <select id="selectWaiterToDelete" class="w-full p-3 border"><option value="">Garson Seç</option></select>
                <button id="deleteWaiterButton" class="w-full bg-red-500 hover:bg-red-600 text-white p-3 rounded-md">Sil</button>
            </div>
        </div>
    </div>
</div>
<div id="confirmDeleteWaiterModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-xl font-semibold mb-4 text-red-600">Garsonu Sil Onayı</h2>
        <p class="text-gray-600 mb-6">"<span id="waiterNameToDeleteSpan"></span>" silinsin mi?</p>
        <div class="flex justify-center gap-4">
            <button id="confirmDeleteWaiterYesButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-md">Evet</button>
            <button id="confirmDeleteWaiterNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md">Hayır</button>
        </div>
    </div>
</div>

<div id="confirmExitAppModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-xl font-semibold mb-4 text-red-600">Uygulamadan Çık</h2>
        <p class="text-gray-600 mb-6">Çıkmak istediğinize emin misiniz?</p>
        <div class="flex justify-center gap-4">
            <button id="confirmExitAppYesButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-md">Evet</button>
            <button id="confirmExitAppNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md">Hayır</button>
        </div>
    </div>
</div>

<div id="salesReportModal" class="modal">
    <div id="salesReportModalContent" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 no-print">
            <h2 class="text-2xl font-semibold text-teal-700">Satış Raporu</h2>
            <button id="closeSalesReportModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="flex-grow overflow-y-auto mb-4">
            <div id="salesReportTableContainer">
                <p class="text-center text-gray-500">Rapor yükleniyor veya hiç satış yok...</p>
            </div>
        </div>
        <div id="salesReportSummary" class="mt-4 pt-4 border-t text-right no-print"> <p class="font-semibold">Toplam Satış Adedi (Kalem): <span id="totalItemsSoldInReport">0</span></p>
            <p class="font-bold text-xl">Rapor Genel Toplamı: <span id="grandTotalSalesInReport">0 ₺</span></p>
        </div>
        <div class="mt-auto pt-4 flex space-x-2 no-print">
            <button id="refreshSalesReportButton" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md">Yenile</button>
            <button id="printSalesReportButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md">Raporu Yazdır</button>
        </div>
    </div>
</div>

<script>
     const WEBSOCKET_URL = 'wss://emet-adisyon.onrender.com'; // VEYA DOĞRUDAN GİRİN

    let socket;

    const appState = {
        user: null,
        products: [], // Sunucudan login_success ile alınacak
        tables: [],   // Sunucudan login_success ile alınacak
        currentTableId: null,
        // salesReport: [], // Artık doğrudan render edilecek, appState'de tutmaya gerek yok
        currentQuickSaleOrder: [],
        currentOrderOriginalTotal: 0,
        currentOrderDiscountAmount: 0,
        waiters: []
    };

    // --- DOM Elementleri ---
    // Yüklediğiniz HTML (adisyon (1).html) dosyasındaki tüm const tanımlamaları buraya gelecek.
    // Örnek:
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingMessage = document.getElementById('loadingMessage');
    const loginModal = document.getElementById('loginModal');
    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginButton = document.getElementById('loginButton');
    const loginError = document.getElementById('loginError');
    const appContainer = document.getElementById('appContainer');
    const activeUserNameSpan = document.getElementById('activeUserName');
    const activeUserRoleSpan = document.getElementById('activeUserRole');
    const logoutButton = document.getElementById('logoutButton');
    const salesReportButton = document.getElementById('salesReportButton');
    const exportDataButton = document.getElementById('exportDataButton'); // HTML'de bu ID'li buton olmalı
    const quickSaleEntryButton = document.getElementById('quickSaleEntryButton');
    const quickSaleButtonContainerTop = document.getElementById('quickSaleButtonContainerTop');
    const addProductToMenuButton = document.getElementById('addProductToMenuButton');
    const editProductMenuButton = document.getElementById('editProductMenuButton');
    const manageTablesButton = document.getElementById('manageTablesButton');
    const manageWaitersButton = document.getElementById('manageWaitersButton');
    const tablesGrid = document.getElementById('tablesGrid');
    const productsListRef = document.getElementById('productsListRef');
    const orderPageContainer = document.getElementById('orderPageContainer');
    const orderPageTableName = document.getElementById('orderPageTableName');
    const orderPageWaiterInfo = document.getElementById('orderPageWaiterInfo');
    const backToTablesButton = document.getElementById('backToTablesButton');
    const orderPageProductGrid = document.getElementById('orderPageProductGrid');
    const orderPageCurrentOrderItems = document.getElementById('orderPageCurrentOrderItems');
    const orderPageCurrentOrderTotal = document.getElementById('orderPageCurrentOrderTotal');
    const discountInfoDiv = document.getElementById('discountInfo');
    const applyDiscountButton = document.getElementById('applyDiscountButton');
    const showReceiptButton = document.getElementById('showReceiptButton');
    const finalizeAndCloseTableButton = document.getElementById('finalizeAndCloseTableButton');
    const manualProductSection = document.getElementById('manualProductSection');
    const manualProductName = document.getElementById('manualProductName');
    const manualProductCategory = document.getElementById('manualProductCategory');
    const manualProductPrice = document.getElementById('manualProductPrice');
    const manualProductQuantity = document.getElementById('manualProductQuantity');
    const manualProductDescription = document.getElementById('manualProductDescription');
    const addManualProductButton = document.getElementById('addManualProductButton');
    const quickSaleModal = document.getElementById('quickSaleModal');
    const closeQuickSaleModalButton = document.getElementById('closeQuickSaleModalButton');
    const quickSaleProductGrid = document.getElementById('quickSaleProductGrid');
    const quickSaleCurrentItems = document.getElementById('quickSaleCurrentItems');
    const quickSaleTotal = document.getElementById('quickSaleTotal');
    const quickSaleDiscountInfo = document.getElementById('quickSaleDiscountInfo');
    const applyQuickSaleDiscountButton = document.getElementById('applyQuickSaleDiscountButton');
    const completeQuickSaleButton = document.getElementById('completeQuickSaleButton');
    const receiptModal = document.getElementById('receiptModal');
    const receiptDate = document.getElementById('receiptDate');
    const receiptTableName = document.getElementById('receiptTableName');
    const receiptWaiterName = document.getElementById('receiptWaiterName');
    const receiptItems = document.getElementById('receiptItems');
    const receiptDiscountInfo = document.getElementById('receiptDiscountInfo');
    const receiptSubtotal = document.getElementById('receiptSubtotal');
    const receiptDiscountAmount = document.getElementById('receiptDiscountAmount');
    const receiptGrandTotal = document.getElementById('receiptGrandTotal');
    const printReceiptButton = document.getElementById('printReceiptButton');
    const closeReceiptModalOnlyButton = document.getElementById('closeReceiptModalOnlyButton');
    const confirmCloseTableModal = document.getElementById('confirmCloseTableModal');
    const confirmCloseTableYesButton = document.getElementById('confirmCloseTableYesButton');
    const confirmCloseTableNoButton = document.getElementById('confirmCloseTableNoButton');
    const confirmDiscountModal = document.getElementById('confirmDiscountModal');
    const confirmDiscountYesButton = document.getElementById('confirmDiscountYesButton');
    const confirmDiscountNoButton = document.getElementById('confirmDiscountNoButton');
    const addProductToMenuModal = document.getElementById('addProductToMenuModal');
    const closeAddProductToMenuModalButton = document.getElementById('closeAddProductToMenuModalButton');
    const newProductNameInput = document.getElementById('newProductName');
    const newProductPriceInput = document.getElementById('newProductPrice');
    const newProductCategorySelect = document.getElementById('newProductCategory');
    const newProductCategoryInput = document.getElementById('newProductCategoryInput');
    const saveNewProductButton = document.getElementById('saveNewProductButton');
    const editProductModal = document.getElementById('editProductModal');
    const closeEditProductModalButton = document.getElementById('closeEditProductModalButton');
    const selectProductToEdit = document.getElementById('selectProductToEdit');
    const editProductFormDiv = document.getElementById('editProductFormDiv');
    const editingProductIdInput = document.getElementById('editingProductId');
    const editProductNameInput = document.getElementById('editProductName');
    const editProductPriceInput = document.getElementById('editProductPrice');
    const editProductCategorySelect = document.getElementById('editProductCategory');
    const editProductCategoryInput = document.getElementById('editProductCategoryInput');
    const saveEditedProductButton = document.getElementById('saveEditedProductButton');
    const manageTablesModal = document.getElementById('manageTablesModal');
    const closeManageTablesModalButton = document.getElementById('closeManageTablesModalButton');
    const newTableNameInput = document.getElementById('newTableNameInput');
    const addNewTableButton = document.getElementById('addNewTableButton');
    const selectTableToEditName = document.getElementById('selectTableToEditName');
    const editTableNameInput = document.getElementById('editTableNameInput');
    const updateTableNameButton = document.getElementById('updateTableNameButton');
    const selectTableToDelete = document.getElementById('selectTableToDelete');
    const deleteTableButton = document.getElementById('deleteTableButton');
    const confirmDeleteTableModal = document.getElementById('confirmDeleteTableModal');
    const tableNameToDeleteSpan = document.getElementById('tableNameToDeleteSpan');
    const confirmDeleteTableYesButton = document.getElementById('confirmDeleteTableYesButton');
    const confirmDeleteTableNoButton = document.getElementById('confirmDeleteTableNoButton');
    const manageWaitersModal = document.getElementById('manageWaitersModal');
    const closeManageWaitersModalButton = document.getElementById('closeManageWaitersModalButton');
    const newWaiterUsernameInput = document.getElementById('newWaiterUsernameInput');
    const newWaiterPasswordInput = document.getElementById('newWaiterPasswordInput');
    const addNewWaiterButton = document.getElementById('addNewWaiterButton');
    const selectWaiterToEditPassword = document.getElementById('selectWaiterToEditPassword');
    const editWaiterPasswordInput = document.getElementById('editWaiterPasswordInput');
    const updateWaiterPasswordButton = document.getElementById('updateWaiterPasswordButton');
    const selectWaiterToDelete = document.getElementById('selectWaiterToDelete');
    const deleteWaiterButton = document.getElementById('deleteWaiterButton');
    const confirmDeleteWaiterModal = document.getElementById('confirmDeleteWaiterModal');
    const waiterNameToDeleteSpan = document.getElementById('waiterNameToDeleteSpan');
    const confirmDeleteWaiterYesButton = document.getElementById('confirmDeleteWaiterYesButton');
    const confirmDeleteWaiterNoButton = document.getElementById('confirmDeleteWaiterNoButton');
    const confirmExitAppModal = document.getElementById('confirmExitAppModal');
    const confirmExitAppYesButton = document.getElementById('confirmExitAppYesButton');
    const confirmExitAppNoButton = document.getElementById('confirmExitAppNoButton');
    const salesReportModal = document.getElementById('salesReportModal');
    const salesReportTableContainer = document.getElementById('salesReportTableContainer'); // Bu zaten var
    const closeSalesReportModalButton = document.getElementById('closeSalesReportModalButton');
    const refreshSalesReportButton = document.getElementById('refreshSalesReportButton');
    const printSalesReportButton = document.getElementById('printSalesReportButton');
    const totalItemsSoldInReportSpan = document.getElementById('totalItemsSoldInReport'); // HTML'e bu ID ile span eklenmeli
    const grandTotalSalesInReportSpan = document.getElementById('grandTotalSalesInReport'); // HTML'e bu ID ile span eklenmeli

    // --- Yardımcı Fonksiyonlar ---
    function formatPrice(price) {
        if (typeof price !== 'number' || isNaN(price)) { return '0.00 ₺'; }
        return price.toFixed(2).replace('.', ',') + ' ₺';
    }

    function formatTimestamp(timestampString) {
        if (!timestampString) return '-';
        // Sunucudan gelen "YYYY-MM-DD HH24:MI:SS" formatını veya "DD.MM.YYYY HH24:MI:SS" formatını koruyalım
        // Eğer farklı bir format gerekiyorsa burada düzenleme yapılabilir.
        // Örnek: JavaScript Date objesine çevirip yeniden formatlama:
        // const date = new Date(timestampString.replace(' ', 'T') + (timestampString.includes('Z') ? '' : 'Z')); // ISO'ya yakınlaştırma
        // if (isNaN(date.getTime())) return timestampString; // Hatalıysa orijinali dön
        // const day = String(date.getDate()).padStart(2, '0');
        // const month = String(date.getMonth() + 1).padStart(2, '0');
        // const year = date.getFullYear();
        // const hours = String(date.getHours()).padStart(2, '0');
        // const minutes = String(date.getMinutes()).padStart(2, '0');
        // return `${day}.${month}.${year} ${hours}:${minutes}`;
        return timestampString; // Sunucudan gelen formatı doğrudan kullan
    }

    function getCurrentFormattedDate() { /* ... yüklediğiniz koddaki gibi ... */ }
    function showLoading(message = "İşleniyor...") { /* ... yüklediğiniz koddaki gibi ... */ }
    function hideLoading() { /* ... yüklediğiniz koddaki gibi ... */ }
    function sanitizeCategoryForCSS(categoryName) { /* ... yüklediğiniz koddaki gibi ... */ }

    // --- WebSocket Fonksiyonları ---
    function connectWebSocket() { /* ... yüklediğiniz koddaki gibi, loginModal.classList.add('active'); appContainer.classList.add('hidden'); satırları onopen içinde değilse dışarı alınmalı */ }

    function sendMessageToServer(type, payload) { /* ... yüklediğiniz koddaki gibi ... */ }

    function handleServerMessage(message) {
        hideLoading();
        console.log("İşlenen Mesaj:", message.type, message.payload);
        switch (message.type) {
            case 'login_success':
                // ... yüklediğiniz koddaki login_success mantığı ...
                // appState.products ve appState.tables sunucudan gelenle güncellenmeli
                appState.user = message.payload.user;
                appState.products = message.payload.products || [];
                appState.tables = message.payload.tables || [];
                localStorage.setItem('adisyonUser', JSON.stringify(appState.user));
                loginModal.classList.remove('active');
                appContainer.classList.remove('hidden'); // Ana container'ı göster
                appContainer.classList.add('active'); // Veya .active class'ı ile
                loginError.textContent = '';
                renderInitialData();
                updateUserInterfaceForRoles();
                break;
            case 'login_fail':
                // ... yüklediğiniz koddaki gibi ...
                break;
            case 'tables_update':
                // ... yüklediğiniz koddaki gibi ...
                break;
            case 'products_update':
                 // ... yüklediğiniz koddaki gibi ...
                break;
            case 'sales_report_data': // Sizin sağladığınız ve güncellenmiş render fonksiyonu
                renderSalesReportData(message.payload.sales);
                break;
            case 'exported_data': // Manuel dışa aktarma için
                console.log("Dışa Aktarılan Veri:", message.payload.completedOrders);
                if (message.payload.completedOrders && message.payload.completedOrders.length > 0) {
                    const dataStr = JSON.stringify(message.payload.completedOrders, null, 2);
                    const blob = new Blob([dataStr], {type : 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const date = new Date();
                    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    a.download = `emet_adisyon_satislar_${dateStr}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('Tüm satış verileri JSON olarak indirildi/indiriliyor.');
                } else {
                    alert('Dışa aktarılacak satış verisi bulunamadı.');
                }
                hideLoading();
                break;
            // ... Diğer tüm case'ler yüklediğiniz koddaki gibi kalacak ...
            // (main_menu_product_added, table_operation_success, waiter_operation_success, quick_sale_success vb.)
            case 'main_menu_product_added': // Örnek
                alert(message.payload.message || "Yeni ürün menüye eklendi!");
                // appState.products sunucudan güncellenmeli veya bu product appState'e eklenmeli
                // ve renderProductsUpdate() çağrılmalı. Şimdilik sunucudan gelen products_update bekleniyor.
                break;
            // ...
            case 'error':
                alert(`Sunucu Hatası: ${message.payload.message || 'Bilinmeyen bir sunucu hatası oluştu.'}`);
                break;
            default:
                console.warn("Bilinmeyen mesaj tipi alındı:", message.type, message.payload);
        }
    }

    function showLoginError(message) { /* ... yüklediğiniz koddaki gibi ... */ }
    function updateUserInterfaceForRoles() { /* ... yüklediğiniz koddaki gibi, exportDataButton'ı da içermeli ... */ }

    // --- Render Fonksiyonları ---
    function renderInitialData() { /* ... yüklediğiniz koddaki gibi ... */ }
    function renderTables() { /* ... yüklediğiniz koddaki gibi ... */ }
    function renderProductGrid(targetGridElement, forQuickSale = false) { /* ... yüklediğiniz koddaki gibi ... */ }
    function renderProductsForReference() { /* ... yüklediğiniz koddaki gibi ... */ }
    function renderOrderPageForTable(table) { /* ... yüklediğiniz koddaki gibi ... */ }
    function updateOrderPageTotalDisplay() { /* ... yüklediğiniz koddaki gibi ... */ }
    function renderQuickSaleOrder() { /* ... yüklediğiniz koddaki gibi ... */ }
    function updateQuickSaleTotalDisplay() { /* ... yüklediğiniz koddaki gibi ... */ }

    // Güncellenmiş Satış Raporu Render Fonksiyonu
    function renderSalesReportData(sales) {
        const container = document.getElementById('salesReportTableContainer'); // salesReportTableContainer globalde zaten tanımlı
        const summaryTotalItemsEl = totalItemsSoldInReportSpan; // globalde tanımlı
        const summaryGrandTotalEl = grandTotalSalesInReportSpan; // globalde tanımlı

        if (!sales || sales.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 py-6">Hiç satış kaydı bulunamadı.</p>';
            if (summaryTotalItemsEl) summaryTotalItemsEl.textContent = '0';
            if (summaryGrandTotalEl) summaryGrandTotalEl.textContent = formatPrice(0);
            return;
        }

        let html = `
            <table class="table-auto w-full border-collapse border border-gray-300 text-xs md:text-sm">
                <thead class="sticky top-0 bg-gray-100 z-10">
                    <tr class="text-left">
                        <th class="border px-2 py-1">Tarih</th>
                        <th class="border px-2 py-1">Masa</th>
                        <th class="border px-2 py-1">Ürün</th>
                        <th class="border px-2 py-1 text-center">Adet</th>
                        <th class="border px-2 py-1 text-right">Birim Fiyat</th>
                        <th class="border px-2 py-1 text-right">Toplam</th>
                        <th class="border px-2 py-1">Kategori</th>
                        <th class="border px-2 py-1">Garson</th>
                        </tr>
                </thead>
                <tbody>
        `;
        let reportGrandTotal = 0;
        let reportTotalItems = 0;

        // Sunucudan gelen sale_timestamp zaten formatlı ("DD.MM.YYYY HH24:MI:SS")
        // item_price ve total_item_price da string olarak "XXX ₺" formatında DEĞİL, sayısal gelmeli.
        // Formatlama istemci tarafında yapılmalı.
        for (const item of sales) {
            const itemPrice = parseFloat(item.item_price) || 0; // Sayıya çevir
            const quantity = parseInt(item.quantity) || 0;
            const totalItemPrice = parseFloat(item.total_item_price) || 0; // Sayıya çevir

            html += `
                <tr class="hover:bg-gray-50">
                    <td class="border px-2 py-1 whitespace-nowrap">${item.sale_timestamp}</td>
                    <td class="border px-2 py-1">${item.table_name || '-'}</td>
                    <td class="border px-2 py-1">${item.item_name || 'Bilinmeyen'}</td>
                    <td class="border px-2 py-1 text-center">${quantity}</td>
                    <td class="border px-2 py-1 text-right">${formatPrice(itemPrice)}</td>
                    <td class="border px-2 py-1 text-right font-semibold">${formatPrice(totalItemPrice)}</td>
                    <td class="border px-2 py-1">${item.category || '-'}</td>
                    <td class="border px-2 py-1">${item.waiter_username || '-'}</td>
                </tr>
            `;
            reportGrandTotal += totalItemPrice;
            reportTotalItems += quantity;
        }

        html += `</tbody>
                 <tfoot>
                    <tr class="bg-gray-200 font-bold">
                        <td colspan="3" class="border px-2 py-1 text-right">RAPOR GENEL TOPLAMI:</td>
                        <td class="border px-2 py-1 text-center">${reportTotalItems} adet</td>
                        <td class="border px-2 py-1"></td>
                        <td class="border px-2 py-1 text-right">${formatPrice(reportGrandTotal)}</td>
                        <td colspan="2" class="border px-2 py-1"></td>
                    </tr>
                 </tfoot>
                 </table>`;
        container.innerHTML = html;

        if (summaryTotalItemsEl) summaryTotalItemsEl.textContent = reportTotalItems;
        if (summaryGrandTotalEl) summaryGrandTotalEl.textContent = formatPrice(reportGrandTotal);
    }


    // --- Diğer İşlevler ---
    // handleLogin, performLogout, showTablesView, vb.
    // Yüklediğiniz adisyon (1).html dosyasındaki tüm bu fonksiyonlar buraya gelecek.
    // Örnek olarak birkaç tanesi:
    function handleLogin() { /* ... yüklediğiniz koddaki gibi ... */ }
    function performLogout() { /* ... yüklediğiniz koddaki gibi ... */ }
    function showTablesView() { /* ... yüklediğiniz koddaki gibi ... */ }
    // ... ve diğer tüm fonksiyonlarınız ...
    function openSalesReport() {
        if (appState.user && appState.user.role === 'cashier') {
            showLoading("Satış raporu yükleniyor...");
            sendMessageToServer('get_sales_report', {});
            if(salesReportModal) salesReportModal.classList.add('active');
        } else {
            alert("Bu özelliği kullanma yetkiniz yok.");
        }
    }
    function printSalesReport() { window.print(); }


    // --- Event Listeners ---
    // Yüklediğiniz adisyon (1).html dosyasındaki tüm event listener'lar buraya gelecek.
    // Örnek:
    if(loginButton) loginButton.addEventListener('click', handleLogin);
    if(passwordInput) passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
    if(logoutButton) logoutButton.addEventListener('click', () => { if(confirmExitAppModal) confirmExitAppModal.classList.add('active'); });
    if(confirmExitAppYesButton) confirmExitAppYesButton.addEventListener('click', () => { performLogout(); if(confirmExitAppModal) confirmExitAppModal.classList.remove('active'); });
    if(confirmExitAppNoButton) confirmExitAppNoButton.addEventListener('click', () => { if(confirmExitAppModal) confirmExitAppModal.classList.remove('active'); });

    if(salesReportButton) salesReportButton.addEventListener('click', openSalesReport);
    if(exportDataButton) {
        exportDataButton.addEventListener('click', () => {
            if (appState.user && appState.user.role === 'cashier') {
                showLoading("Veriler dışa aktarılıyor...");
                sendMessageToServer('export_completed_orders', {});
            } else {
                alert('Bu işlem için yetkiniz yok.');
            }
        });
    }
    // ... diğer event listener'larınız ...
    if(closeSalesReportModalButton) closeSalesReportModalButton.addEventListener('click', () => { if(salesReportModal) salesReportModal.classList.remove('active'); });
    if(refreshSalesReportButton) refreshSalesReportButton.addEventListener('click', () => { showLoading("Rapor güncelleniyor..."); sendMessageToServer('get_sales_report', {}); });
    if(printSalesReportButton) printSalesReportButton.addEventListener('click', printSalesReport);


    // Sayfa yüklendiğinde WebSocket bağlantısını kur
    document.addEventListener('DOMContentLoaded', () => {
        // Tüm DOM elementlerinin var olup olmadığını kontrol etmek iyi bir pratiktir
        if (!loginModal || !appContainer || !salesReportTableContainer /* vb. */) {
            console.error("HTML elementlerinden bazıları bulunamadı! Lütfen ID'leri kontrol edin.");
            alert("Uygulama başlatılırken bir sorun oluştu. Lütfen sayfayı yenileyin.");
            return;
        }
        connectWebSocket();
        updateUserInterfaceForRoles(); // Başlangıçta UI'ı ayarla
    });
</script>
</body>
</html>
