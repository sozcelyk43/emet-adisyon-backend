<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMET LEZZET GÜNLERİ ADİSYON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain; /* Sayfanın tamamının kaymasını engelle (özellikle mobil için) */
        }
        .modal {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        .modal.active {
            display: flex;
        }
        /* Ana sayfa ve sipariş sayfası için temel görünürlük */
        #appContainer,
        #orderPageContainer {
            display: none; /* Başlangıçta gizli */
        }
        #appContainer.active,
        #orderPageContainer.active {
            display: block; /* Aktif olduğunda göster */
        }

        /* Modal stilleri (merkezlenmiş ve overlay) */
        #loginModal.active, /* Login modalı da bu stili kullanacak */
        #quickSaleModal.active,
        #addProductToMenuModal.active,
        #editProductModal.active,
        #manageTablesModal.active,
        #manageWaitersModal.active,
        #confirmDeleteTableModal.active,
        #confirmDeleteWaiterModal.active,
        #confirmExitAppModal.active,
        #receiptModal.active,
        #confirmCloseTableModal.active,
        #confirmDiscountModal.active,
        #salesReportModal.active,
        #activityLogModal.active { /* Yeni eklenen aktivite log modalı */
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75);
            align-items: center;
            justify-content: center;
            z-index: 50; /* Diğer elementlerin üzerinde olması için */
            padding: 1rem; /* Kenarlardan boşluk */
            overscroll-behavior-y: contain; /* Modal içi kaydırmada sayfanın kaymasını engelle */
        }

        /* Modal içeriklerinin dikeyde ve yatayda ortalanması için (modalın kendisi flex olduğu için) */
        #loginModal .bg-white,
        #quickSaleModal .bg-white,
        #addProductToMenuModal .bg-white,
        #editProductModal .bg-white,
        #manageTablesModal .bg-white,
        #manageWaitersModal .bg-white,
        #confirmDeleteTableModal .bg-white,
        #confirmDeleteWaiterModal .bg-white,
        #confirmExitAppModal .bg-white,
        #receiptModal #receiptModalContent,
        #confirmCloseTableModal .bg-white,
        #confirmDiscountModal .bg-white,
        #salesReportModal #salesReportModalContent,
        #activityLogModal #activityLogModalContent { /* Yeni eklenen aktivite log modalı içeriği */
             /* Bu elementler zaten kendi genişlik ve yüksekliklerini yönetiyor,
                ancak modalın kendisi flex olduğu için align-items: center ve justify-content: center
                bu iç kutuları ortalayacaktır. */
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        #loadingOverlay {
            display: none; /* Başlangıçta gizli */
        }
        #loadingOverlay.active {
            display: flex; /* Aktif olduğunda göster (modal stiliyle aynı) */
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75);
            align-items: center;
            justify-content: center;
            z-index: 100; /* En üstte olması için */
        }
        /* Ürün Kartı Miktarı */
        .product-card-quantity input {
            width: 40px;
            text-align: center;
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
            padding-top: 0.1rem;
            padding-bottom: 0.1rem;
            border-radius: 0.25rem;
        }
         .product-card-quantity button {
             min-width: 24px; /* Tailwind w-6 */
             height: 24px;  /* Tailwind h-6 */
             display: inline-flex;
             align-items: center;
             justify-content: center;
             border-radius: 0.25rem;
         }

        /* Kategori Alanı Renkleri */
        .category-section-bg-ET-TAVUK { background-color: #fee2e2; } /* red-100 */
        .category-section-bg-ATIŞTIRMALIK { background-color: #ffedd5; } /* orange-100 */
        .category-section-bg-TATLI { background-color: #fce7f3; } /* pink-100 */
        .category-section-bg-İÇECEK { background-color: #eff6ff; } /* blue-100 */
        .category-section-bg-ÇORBA { background-color: #fef9c3; } /* yellow-100 */
        .category-section-bg-DİĞER { background-color: #dcfce7; } /* green-100 */
        .category-section-bg-default { background-color: #f3f4f6; } /* gray-100 */

        /* Ürün Kartı Renkleri (Kategorinin daha koyu tonu) */
        .product-card-bg-ET-TAVUK { background-color: #fecaca; } /* red-200 */
        .product-card-bg-ATIŞTIRMALIK { background-color: #fed7aa; } /* orange-200 */
        .product-card-bg-TATLI { background-color: #fbcfe8; } /* pink-200 */
        .product-card-bg-İÇECEK { background-color: #dbeafe; } /* blue-200 */
        .product-card-bg-ÇORBA { background-color: #fef08a; } /* yellow-200 */
        .product-card-bg-DİĞER { background-color: #bbf7d0; } /* green-200 */
        .product-card-bg-default { background-color: #e5e7eb; } /* gray-200 */


        /* Ürün Kartı Görünümü */
        .product-card {
            border-radius: 0.5rem; /* Tailwind rounded-lg */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* Tailwind shadow-md */
            padding: 0.75rem; /* Tailwind p-3 */
            transition: transform 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
        }
         .product-card.quick-sale-card { /* Hızlı satış için daha kompakt kart */
            min-height: 80px;
            padding: 0.5rem; /* Tailwind p-2 */
            justify-content: center; /* İçeriği ortala */
         }
        .product-card:hover {
            transform: translateY(-2px);
        }
        .product-card h5 { /* Ürün adı */
             font-weight: 600; /* Tailwind font-semibold */
             color: #1f2937; /* Tailwind text-gray-800 */
             margin-bottom: 0.25rem; /* Tailwind mb-1 */
             font-size: 0.875rem; /* Tailwind text-sm */
             line-height: 1.25; /* Daha iyi okunabilirlik için */
             min-height: 2.5em; /* İki satırlık alan, taşmayı engellemek için */
             display: -webkit-box;
            -webkit-line-clamp: 2; /* En fazla iki satır göster */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
         .product-card.quick-sale-card h5 { /* Hızlı satış kart ürün adı */
             font-size: 0.9rem; /* Biraz daha büyük */
             text-align: center;
             margin-bottom: 0.5rem; /* Tailwind mb-2 */
             line-height: 1.2;
             min-height: 2.4em; /* İki satırlık alan */
         }
         .product-card p.product-price { /* Ürün fiyatı */
             color: #4b5563; /* Tailwind text-gray-600 */
             font-size: 0.8rem; /* Biraz daha küçük */
             margin-bottom: 0.5rem; /* Tailwind mb-2 */
         }
         .product-card .description-input { /* Açıklama inputu */
             margin-top: 0.5rem; /* Tailwind mt-2 */
             margin-bottom: 0.5rem; /* Tailwind mb-2 */
             background-color: #fff; /* Tailwind bg-white */
             border-radius: 0.25rem; /* Tailwind rounded */
         }
         .product-card .add-item-from-card-btn { /* Ekle butonu */
             margin-top: auto; /* Kartın en altına iter */
         }
         .product-card.quick-sale-card .add-item-from-card-btn { /* Hızlı satış ekle butonu */
             padding-top: 0.75rem; /* Tailwind py-3 */
             padding-bottom: 0.75rem;
             font-size: 1rem; /* Tailwind text-base */
             font-weight: bold; /* Tailwind font-bold */
         }

        /* Yazdırma stilleri */
        @media print {
            body * {
                visibility: hidden; /* Önce her şeyi gizle */
            }
            /* Fiş yazdırma */
            #receiptModalContent, #receiptModalContent * {
                visibility: visible; /* Sadece fiş içeriğini görünür yap */
            }
            #receiptModalContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100mm; /* Termal yazıcı genişliği */
                font-size: 9pt;
                padding: 4mm;
                box-sizing: border-box;
                border: 1px solid #ccc; /* Kenarlık eklenebilir */
            }
             /* Satış Raporu yazdırma (A4 dikey) */
            #salesReportModalContent, #salesReportModalContent *,
            #activityLogModalContent, #activityLogModalContent * { /* Aktivite logları için eklendi */
                 visibility: visible;
            }
             #salesReportModalContent,
             #activityLogModalContent { /* Aktivite logları için eklendi */
                 position: absolute;
                 left: 0;
                 top: 0;
                 width: 100%; /* A4 genişliği */
                 font-size: 10pt;
                 padding: 10mm;
                 box-sizing: border-box;
             }
             #salesReportModalContent table,
             #activityLogModalContent table { /* Aktivite logları için eklendi */
                 width: 100%;
                 border-collapse: collapse;
             }
             #salesReportModalContent th, #salesReportModalContent td,
             #activityLogModalContent th, #activityLogModalContent td { /* Aktivite logları için eklendi */
                 border: 1px solid #ccc;
                 padding: 2mm;
                 text-align: left;
             }
             #salesReportModalContent th,
             #activityLogModalContent th { /* Aktivite logları için eklendi */
                 background-color: #eee;
             }

            /* Genel yazdırma gizlemeleri (Yazdırılmayacak butonlar vb.) */
            #receiptModalContent button,
            #salesReportModalContent button,
            #activityLogModalContent button, /* Aktivite logları için eklendi */
            #quickSaleModal button:not(#printReceiptButton), /* Hızlı satışta sadece fiş yazdır butonu kalabilir */
            #appContainer button#logoutButton,
            #orderPageContainer button:not(#printReceiptButton):not(#closeReceiptModalOnlyButton):not(#finalizeAndCloseTableButton),
            #confirmCloseTableModal button,
            #confirmDiscountModal button,
            #addProductToMenuModal button,
            #editProductModal button,
            #manageTablesModal button,
            #manageWaitersModal button,
            #confirmDeleteTableModal button,
            #confirmDeleteWaiterModal button,
            #confirmExitAppModal button,
            #appContainer header, /* Ana başlık gizlenebilir */
            #orderPageContainer header button, /* Masalara dön butonu */
            #quickSaleModal header button, /* Hızlı satış kapatma butonu */
            #salesReportModal header button, /* Satış raporu kapatma */
            #activityLogModal header button, /* Aktivite log kapatma */
            .no-print /* Genel yazdırmama sınıfı */
             {
                display: none !important;
            }

            /* Fiş içeriği için daha detaylı stiller */
            #receiptModalContent h2 {
                font-size: 11pt;
                font-weight: bold;
                margin-bottom: 3mm;
                text-align: center;
            }
             #receiptModalContent p, #receiptModalContent div#receiptItems > div {
                line-height: 1.3;
                margin-bottom: 1mm;
            }
            #receiptModalContent div#receiptItems > div { /* Her bir fiş kalemi */
                display: flex;
                justify-content: space-between;
                flex-wrap: wrap; /* Uzun açıklamalar için */
            }
             #receiptModalContent div#receiptItems span.item-details {
                flex-basis: 70%; /* Ürün adı ve açıklama için genişlik */
             }
             #receiptModalContent div#receiptItems span.item-price {
                 flex-basis: 30%; /* Fiyat için genişlik */
                 text-align: right;
             }
            #receiptModalContent div#receiptItems span.item-description,
            #receiptModalContent div#receiptItems span.item-waiter {
                display: block; /* Alt satıra geç */
                font-size: 7pt; /* Daha küçük font */
                padding-left: 5mm; /* Biraz içeriden başla */
                color: #555;
                flex-basis: 100%; /* Tam genişlik */
            }
             #receiptModalContent .discount-info { /* İndirim bilgisi */
                 font-weight: bold;
                 color: #dc2626; /* Tailwind red-600 */
             }
            #receiptModalContent hr {
                margin-top: 2mm;
                margin-bottom: 2mm;
                border-top: 1px dashed #999; /* Kesik çizgi */
            }
            #receiptModalContent .text-right p#receiptTotalLine {
                font-size: 10pt;
                font-weight: bold;
            }
            #receiptModalContent p.thank-you-note {
                 margin-top: 4mm;
                 text-align: center;
                 font-size: 8pt;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="loadingOverlay" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-[100]">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
        <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loadingMessage" class="text-lg font-medium text-gray-700">Bağlanılıyor...</p>
    </div>
</div>

<div id="loginModal" class="modal active"> <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-2xl font-semibold mb-6 text-center text-blue-600">Kullanıcı Girişi</h2>
        <p class="text-sm text-gray-500 text-center mb-4">Garson veya Kasa olarak giriş yapın.</p>
        <input type="text" id="usernameInput" placeholder="Kullanıcı Adı" class="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <input type="password" id="passwordInput" placeholder="Şifre" class="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <button id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded-md transition duration-150">Giriş Yap</button>
        <p id="loginError" class="text-red-500 text-sm mt-2 text-center"></p>
    </div>
</div>

<div id="appContainer" class="container mx-auto p-4 md:p-8"> <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
        <div>
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700">EMET LEZZET GÜNLERİ ADİSYON</h1>
            <p class="text-gray-600 mt-1">Aktif Kullanıcı: <span id="activeUserName" class="font-semibold"></span> (<span id="activeUserRole" class="capitalize"></span>)</p>
        </div>
        <div class="flex flex-wrap gap-2 no-print"> <button id="manageWaitersButton" class="bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Garson Yönetimi</button>
            <button id="manageTablesButton" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Masalar Yönetimi</button>
            <button id="editProductMenuButton" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Ürün Düzenleme</button>
            <button id="addProductToMenuButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Menüye Ürün Ekle</button>
            <button id="salesReportButton" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Satış Raporlama</button>
            <button id="activityLogButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Aktivite Logları</button>
            <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Uygulamadan Çık</button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <main class="md:col-span-2">
            <section id="tablesSection" class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Masalar</h2>
                </div>
                <div id="quickSaleButtonContainerTop" class="mb-6 hidden no-print"> <button id="quickSaleEntryButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-6 rounded-xl shadow-lg text-2xl transition duration-150 transform hover:scale-105">
                        HIZLI SATIŞ
                    </button>
                </div>
                <div id="tablesGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    </div>
            </section>
        </main>
        <aside class="md:col-span-1 no-print"> <section id="productsReferenceSection" class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Güncel Menü</h2>
                <div class="bg-white p-6 rounded-lg shadow max-h-[70vh] overflow-y-auto">
                    <div id="productsListRef">
                        </div>
                </div>
            </section>
        </aside>
    </div>
</div>

<div id="orderPageContainer" class="container mx-auto p-4 md:p-8"> <header class="mb-6 flex flex-wrap justify-between items-center no-print"> <div class="w-full md:w-auto mb-2 md:mb-0">
            <h2 class="text-3xl font-semibold text-blue-700">Sipariş: <span id="orderPageTableName"></span></h2>
            <p id="orderPageWaiterInfo" class="text-sm text-gray-600 mt-1">Bu Masaya Henüz Sipariş Alınmadı</p>
        </div>
        <button id="backToTablesButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Masalara Dön</button>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <section class="lg:col-span-2 bg-white p-6 rounded-lg shadow no-print"> <h3 class="text-xl font-semibold mb-4 text-gray-700">Ürün Seçimi</h3>
            <div id="orderPageProductGrid" class="space-y-6 max-h-[75vh] overflow-y-auto pr-2">
                </div>

            <div id="manualProductSection" class="mt-6 pt-6 border-t border-gray-200 hidden">
                <h3 class="text-lg font-semibold mb-3 text-orange-600">Manuel Ürün Ekle (Sadece Kasa - Bu siparişe özel)</h3>
                <div class="space-y-3">
                    <input type="text" id="manualProductName" placeholder="Ürün Adı" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <div>
                        <label for="manualProductCategory" class="block text-sm font-medium text-gray-600 mb-1">Kategori:</label>
                        <select id="manualProductCategory" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                            <option value="">Kategori Seçin</option>
                            </select>
                    </div>
                    <input type="number" id="manualProductPrice" placeholder="Fiyat (₺)" step="0.01" min="0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <input type="number" id="manualProductQuantity" placeholder="Adet" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <input type="text" id="manualProductDescription" placeholder="Açıklama (isteğe bağlı)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <button id="addManualProductButton" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold p-2 rounded-md transition duration-150">Manuel Ürünü Siparişe Ekle</button>
                </div>
            </div>
        </section>

        <section class="lg:col-span-1 bg-white p-6 rounded-lg shadow"> <h3 class="text-xl font-semibold mb-4 text-gray-700 no-print">Mevcut Sipariş</h3> <div id="orderPageCurrentOrderItems" class="space-y-3 max-h-[calc(75vh-150px)] overflow-y-auto pr-2">
                </div>
            <div id="orderPageCurrentOrderTotal" class="text-right font-bold text-2xl mt-6 text-gray-800">
                Toplam: 0 ₺
            </div>
            <div id="discountInfo" class="text-right text-sm text-red-600 mt-1 hidden"></div> <div class="mt-6 space-y-3 no-print"> <button id="applyDiscountButton" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold p-3 rounded-md transition duration-150 hidden">Personel İndirimi (%30)</button>
                <button id="showReceiptButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md transition duration-150">Fiş Göster/Yazdır</button>
                <button id="finalizeAndCloseTableButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold p-3 rounded-md transition duration-150 hidden">Masayı Kapat ve Hesabı Tamamla</button>
            </div>
        </section>
    </div>
</div>

<div id="quickSaleModal" class="modal">
    <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl w-full max-w-7xl max-h-[95vh] flex flex-col">
        <header class="mb-4 flex justify-between items-center no-print">
            <h2 class="text-2xl font-semibold text-green-700">Hızlı Satış</h2>
            <button id="closeQuickSaleModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-grow overflow-hidden">
            <section class="md:col-span-2 bg-gray-50 p-3 rounded-lg shadow-inner overflow-y-auto max-h-[calc(95vh-200px)] no-print">
                <h3 class="text-lg font-semibold mb-3 text-gray-700">Ürün Seçimi</h3>
                <div id="quickSaleProductGrid" class="space-y-4">
                    </div>
            </section>
            <section class="md:col-span-1 bg-gray-50 p-3 rounded-lg shadow-inner flex flex-col max-h-[calc(95vh-200px)]">
                <h3 class="text-lg font-semibold mb-3 text-gray-700 no-print">Hızlı Satış Sepeti</h3>
                <div id="quickSaleCurrentItems" class="space-y-2 flex-grow overflow-y-auto">
                    <p class="text-gray-500 text-center py-4">Sepet boş.</p>
                </div>
                <div id="quickSaleTotal" class="text-right font-bold text-xl mt-4 pt-2 border-t">
                    Toplam: 0 ₺
                </div>
                <div id="quickSaleDiscountInfo" class="text-right text-sm text-red-600 mt-1 hidden"></div>
                <div class="mt-4 space-y-2 no-print">
                    <button id="applyQuickSaleDiscountButton" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold p-2 rounded-md transition duration-150">Personel İndirimi (%30)</button>
                    <button id="completeQuickSaleButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold p-3 rounded-md transition duration-150">Satışı Tamamla ve Fiş Kes</button>
                </div>
            </section>
        </div>
    </div>
</div>

<div id="receiptModal" class="modal">
    <div id="receiptModalContent" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
        <div class="flex-grow overflow-y-auto"> <h2 class="text-2xl font-bold text-center mb-2 text-gray-800">EMET LEZZET GÜNLERİ</h2>
            <p class="text-center text-sm text-gray-600 mb-1">Fiş/Adisyon</p>
            <p class="text-center text-sm text-gray-600 mb-4">Tarih: <span id="receiptDate"></span></p>
            <div class="mb-2">
                <p class="text-sm"><span class="font-semibold">Masa:</span> <span id="receiptTableName"></span></p>
                <p class="text-sm"><span class="font-semibold">Garson/Kasa:</span> <span id="receiptWaiterName">Bilinmiyor</span></p>
            </div>
            <hr class="my-2 border-gray-300">
            <div id="receiptItems" class="text-sm space-y-1 mb-2">
                </div>
            <div id="receiptDiscountInfo" class="text-sm my-2 hidden"> <hr class="my-1 border-gray-300">
                <div class="flex justify-between">
                    <span>Ara Toplam:</span>
                    <span id="receiptSubtotal">0 ₺</span>
                </div>
                <div class="flex justify-between text-red-600">
                    <span>Personel İndirimi (%30):</span>
                    <span>-<span id="receiptDiscountAmount">0 ₺</span></span>
                </div>
            </div>
            <hr class="my-2 border-dashed border-gray-400">
            <div class="text-right">
                <p id="receiptTotalLine" class="text-lg font-bold text-gray-800">GENEL TOPLAM: <span id="receiptGrandTotal"></span> ₺</p>
            </div>
            <p class="thank-you-note text-center text-xs text-gray-500 mt-6">Teşekkür Ederiz!</p>
        </div>
        <div class="mt-auto pt-4 flex space-x-2 no-print"> <button id="printReceiptButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md transition duration-150">Yazdır</button>
            <button id="closeReceiptModalOnlyButton" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold p-3 rounded-md transition duration-150">Kapat</button>
        </div>
    </div>
</div>

<div id="confirmCloseTableModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Masayı Kapat Onayı</h2>
        <p class="text-gray-600 mb-6">Masayı kapatmak ve hesabı tamamlamak istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
        <div class="flex justify-center gap-4">
            <button id="confirmCloseTableYesButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-md transition duration-150">Evet, Kapat</button>
            <button id="confirmCloseTableNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md transition duration-150">Hayır, Vazgeç</button>
        </div>
    </div>
</div>

<div id="confirmDiscountModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
        <h2 class="text-xl font-semibold mb-4 text-yellow-600">Personel İndirimi</h2>
        <p class="text-gray-600 mb-6">%30 personel indirimi uygulansın mı?</p>
        <div class="flex justify-center gap-4">
            <button id="confirmDiscountYesButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-md transition duration-150">Evet, Uygula</button>
            <button id="confirmDiscountNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md transition duration-150">Hayır, Vazgeç</button>
        </div>
    </div>
</div>

<div id="addProductToMenuModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-indigo-600">Menüye Yeni Ürün Ekle</h2>
            <button id="closeAddProductToMenuModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="space-y-4">
            <input type="text" id="newProductName" placeholder="Ürün Adı (örn: Zerde KG)" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
            <input type="number" id="newProductPrice" placeholder="Fiyat (₺)" step="0.01" min="0" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
            <div>
                <label for="newProductCategory" class="block text-sm font-medium text-gray-600 mb-1">Kategori:</label>
                <select id="newProductCategory" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
                    <option value="">Mevcut Kategori Seçin</option>
                    {/* Kategoriler JavaScript ile doldurulacak */}
                </select>
            </div>
            <input type="text" id="newProductCategoryInput" placeholder="Veya Yeni Kategori Adı Girin" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 mt-2 hidden">
            <button id="saveNewProductButton" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold p-3 rounded-md transition duration-150">Menüye Kaydet</button>
        </div>
    </div>
</div>

<div id="editProductModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-purple-600">Ürün Düzenle</h2>
            <button id="closeEditProductModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="editProductSelectionDiv" class="space-y-4">
            <label for="selectProductToEdit" class="block text-sm font-medium text-gray-700">Düzenlenecek Ürünü Seçin:</label>
            <select id="selectProductToEdit" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                <option value="">-- Ürün Seçin --</option>
                {/* Ürünler JavaScript ile doldurulacak */}
            </select>
        </div>
        <div id="editProductFormDiv" class="space-y-4 mt-4 hidden">
            <input type="hidden" id="editingProductId">
            <div>
                <label for="editProductName" class="block text-sm font-medium text-gray-700">Ürün Adı:</label>
                <input type="text" id="editProductName" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
                <label for="editProductPrice" class="block text-sm font-medium text-gray-700">Fiyat (₺):</label>
                <input type="number" id="editProductPrice" step="0.01" min="0" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
                <label for="editProductCategory" class="block text-sm font-medium text-gray-700">Kategori:</label>
                <select id="editProductCategory" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                    <option value="">Mevcut Kategori Seçin</option>
                    {/* Kategoriler JavaScript ile doldurulacak */}
                </select>
            </div>
            <input type="text" id="editProductCategoryInput" placeholder="Veya Yeni Kategori Adı Girin" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 mt-2 hidden">
            <button id="saveEditedProductButton" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold p-3 rounded-md transition duration-150">Değişiklikleri Kaydet</button>
        </div>
    </div>
</div>

<div id="manageTablesModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-orange-600">Masalar Yönetimi</h2>
            <button id="closeManageTablesModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                <h3 class="text-lg font-medium text-gray-700">Yeni Masa Ekle</h3>
                <input type="text" id="newTableNameInput" placeholder="Yeni Masa Adı (örn: Bahçe 1)" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                <button id="addNewTableButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md transition duration-150">Yeni Masa Ekle</button>
            </div>
            <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                <h3 class="text-lg font-medium text-gray-700">Masa Adı Düzenle</h3>
                <select id="selectTableToEditName" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <option value="">Düzenlenecek Masayı Seçin</option>
                </select>
                <input type="text" id="editTableNameInput" placeholder="Yeni Masa Adı" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                <button id="updateTableNameButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md transition duration-150">Adı Güncelle</button>
            </div>
            <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-700">Masa Sil</h3>
                <select id="selectTableToDelete" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                    <option value="">Silinecek Masayı Seçin</option>
                </select>
                <button id="deleteTableButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold p-3 rounded-md transition duration-150">Masayı Sil</button>
            </div>
        </div>
    </div>
</div>

<div id="confirmDeleteTableModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
        <h2 class="text-xl font-semibold mb-4 text-red-600">Masayı Sil Onayı</h2>
        <p class="text-gray-600 mb-6">"<span id="tableNameToDeleteSpan"></span>" adlı masayı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz ve masadaki aktif siparişler (eğer varsa) kaybolacaktır.</p>
        <div class="flex justify-center gap-4">
            <button id="confirmDeleteTableYesButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-md transition duration-150">Evet, Sil</button>
            <button id="confirmDeleteTableNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md transition duration-150">Hayır, Vazgeç</button>
        </div>
    </div>
</div>

<div id="manageWaitersModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-pink-600">Garson Yönetimi</h2>
            <button id="closeManageWaitersModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                <h3 class="text-lg font-medium text-gray-700">Yeni Garson Ekle</h3>
                <input type="text" id="newWaiterUsernameInput" placeholder="Garson Kullanıcı Adı" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500">
                <input type="password" id="newWaiterPasswordInput" placeholder="Garson Şifresi" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500">
                <button id="addNewWaiterButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md transition duration-150">Yeni Garson Ekle</button>
            </div>
            <div class="space-y-4 border-b md:border-b-0 md:border-r md:pb-0 pb-6 md:pr-6">
                <h3 class="text-lg font-medium text-gray-700">Garson Şifresi Düzenle</h3>
                <select id="selectWaiterToEditPassword" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500">
                    <option value="">Düzenlenecek Garsonu Seçin</option>
                </select>
                <input type="password" id="editWaiterPasswordInput" placeholder="Yeni Şifre" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500">
                <button id="updateWaiterPasswordButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md transition duration-150">Şifreyi Güncelle</button>
            </div>
            <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-700">Garson Sil</h3>
                <select id="selectWaiterToDelete" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500">
                    <option value="">Silinecek Garsonu Seçin</option>
                </select>
                <button id="deleteWaiterButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold p-3 rounded-md transition duration-150">Garsonu Sil</button>
            </div>
        </div>
    </div>
</div>

<div id="confirmDeleteWaiterModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
        <h2 class="text-xl font-semibold mb-4 text-red-600">Garsonu Sil Onayı</h2>
        <p class="text-gray-600 mb-6">"<span id="waiterNameToDeleteSpan"></span>" adlı garsonu silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
        <div class="flex justify-center gap-4">
            <button id="confirmDeleteWaiterYesButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-md transition duration-150">Evet, Sil</button>
            <button id="confirmDeleteWaiterNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md transition duration-150">Hayır, Vazgeç</button>
        </div>
    </div>
</div>

<div id="confirmExitAppModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
        <h2 class="text-xl font-semibold mb-4 text-red-600">Uygulamadan Çık</h2>
        <p class="text-gray-600 mb-6">Uygulamadan çıkmak istediğinize emin misiniz?</p>
        <div class="flex justify-center gap-4">
            <button id="confirmExitAppYesButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-md transition duration-150">Evet, Çık</button>
            <button id="confirmExitAppNoButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md transition duration-150">Hayır, Kal</button>
        </div>
    </div>
</div>

<div id="salesReportModal" class="modal">
    <div id="salesReportModalContent" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 no-print">
            <h2 class="text-2xl font-semibold text-teal-700">Satış Raporu</h2>
            <button id="closeSalesReportModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="flex-grow overflow-y-auto mb-4">
            <div id="salesReportTableContainer">
                <p class="text-center text-gray-500">Rapor yükleniyor veya hiç satış yok...</p>
            </div>
            <div id="salesReportSummary" class="mt-4 pt-4 border-t text-right">
                <p class="font-semibold">Toplam Satış Adedi: <span id="totalItemsSold">0</span></p>
                <p class="font-bold text-xl">Genel Toplam: <span id="grandTotalSales">0 ₺</span></p>
            </div>
        </div>
        <div class="mt-auto pt-4 flex space-x-2 no-print">
            <button id="refreshSalesReportButton" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md transition duration-150">Yenile</button>
            <button id="printSalesReportButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md transition duration-150">Raporu Yazdır</button>
        </div>
    </div>
</div>

<div id="activityLogModal" class="modal">
    <div id="activityLogModalContent" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 no-print">
            <h2 class="text-2xl font-semibold text-cyan-700">Aktivite Logları</h2>
            <button id="closeActivityLogModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="flex-grow overflow-y-auto mb-4">
            <div id="activityLogTableContainer">
                <p class="text-center text-gray-500">Loglar yükleniyor veya hiç kayıt yok...</p>
            </div>
        </div>
        <div class="mt-auto pt-4 flex space-x-2 no-print">
            <button id="refreshActivityLogButton" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md transition duration-150">Yenile</button>
            </div>
    </div>
</div>






<script>



const WEBSOCKET_URL = 'wss://emet-adisyon.onrender.com'; 

    // Global WebSocket değişkeni
// Global WebSocket değişkeni
let socket;

// Uygulama genelindeki durumu tutacak obje

// Örnek sabit ürün listesi (sunucudaki products_in_memory_fallback gibi)
const staticProducts = [
    { id: 1001, name: "İSKENDER - 120 GR", price: 275.00, category: "ET - TAVUK" },
    { id: 1002, name: "ET DÖNER EKMEK ARASI", price: 150.00, category: "ET - TAVUK" },
    { id: 1003, name: "ET DÖNER PORSİYON", price: 175.00, category: "ET - TAVUK" },
    { id: 1004, name: "TAVUK DÖNER EKMEK ARASI", price: 130.00, category: "ET - TAVUK" },
    { id: 1005, name: "TAVUK DÖNER PORSİYON", price: 150.00, category: "ET - TAVUK" },
    { id: 1006, name: "KÖFTE EKMEK", price: 130.00, category: "ET - TAVUK" },
    { id: 1007, name: "KÖFTE PORSİYON", price: 150.00, category: "ET - TAVUK" },
    { id: 1008, name: "KUZU ŞİŞ", price: 150.00, category: "ET - TAVUK" },
    { id: 1009, name: "ADANA ŞİŞ", price: 150.00, category: "ET - TAVUK" },
    { id: 1010, name: "PİRZOLA - 4 ADET", price: 250.00, category: "ET - TAVUK" },
    { id: 1011, name: "TAVUK FAJİTA", price: 200.00, category: "ET - TAVUK" },
    { id: 1012, name: "TAVUK (PİLİÇ) ÇEVİRME", price: 250.00, category: "ET - TAVUK" },
    { id: 1013, name: "ET DÖNER - KG", price: 1300.00, category: "ET - TAVUK" },
    { id: 1014, name: "ET DÖNER - 500 GR", price: 650.00, category: "ET - TAVUK" },
    { id: 1015, name: "TAVUK DÖNER - KG", price: 800.00, category: "ET - TAVUK" },
    { id: 1016, name: "TAVUK DÖNER - 500 GR", price: 400.00, category: "ET - TAVUK" },
    { id: 2001, name: "PİZZA KARIŞIK (ORTA BOY)", price: 150.00, category: "ATIŞTIRMALIK" },
    { id: 2002, name: "PİZZA KARIŞIK (BÜYÜK BOY)", price: 200.00, category: "ATIŞTIRMALIK" },
    { id: 2003, name: "LAHMACUN", price: 75.00, category: "ATIŞTIRMALIK" },
    { id: 2004, name: "PİDE ÇEŞİTLERİ", price: 100.00, category: "ATIŞTIRMALIK" },
    { id: 2005, name: "AYVALIK TOSTU", price: 100.00, category: "ATIŞTIRMALIK" },
    { id: 2006, name: "HAMBURGER", price: 120.00, category: "ATIŞTIRMALIK" },
    { id: 2007, name: "ÇİĞ KÖFTE KG (MARUL-LİMON)", price: 300.00, category: "ATIŞTIRMALIK" },
    { id: 3001, name: "OSMANLI ŞERBETİ - 1 LİTRE", price: 75.00, category: "İÇECEK" },
    { id: 3002, name: "LİMONATA", price: 75.00, category: "İÇECEK" },
    { id: 3003, name: "SU", price: 10.00, category: "İÇECEK" },
    { id: 3004, name: "AYRAN", price: 15.00, category: "İÇECEK" },
    { id: 3005, name: "ÇAY", price: 10.00, category: "İÇECEK" },
    { id: 3006, name: "GAZOZ", price: 25.00, category: "İÇECEK" },
    { id: 4001, name: "EV BAKLAVASI - KG", price: 400.00, category: "TATLI" },
    { id: 4002, name: "EV BAKLAVASI - 500 GRAM", price: 200.00, category: "TATLI" },
    { id: 4003, name: "EV BAKLAVASI - PORSİYON", price: 75.00, category: "TATLI" },
    { id: 4004, name: "AŞURE - 500 GRAM", price: 100.00, category: "TATLI" },
    { id: 4005, name: "HÖŞMERİM - 500 GRAM", price: 100.00, category: "TATLI" },
    { id: 4006, name: "DİĞER PASTA ÇEŞİTLERİ", price: 50.00, category: "TATLI" },
    { id: 4007, name: "YAĞLI GÖZLEME", price: 50.00, category: "TATLI" },
    { id: 4008, name: "İÇLİ GÖZLEME", price: 60.00, category: "TATLI" },
    { id: 5001, name: "KELLE PAÇA ÇORBA", price: 60.00, category: "ÇORBA" },
    { id: 5002, name: "TARHANA ÇORBA", price: 60.00, category: "ÇORBA" }
];

// İstemci tarafında masaları oluşturan fonksiyon
let clientNextTableIdCounter = 1; // Masa ID'lerinin benzersiz olması için
function initializeClientTables() {
    const clientTables = [];
    let currentId = 1;
    for (let i = 1; i <= 5; i++) {
        clientTables.push({ id: `masa-${currentId++}`, name: `Kamelya ${i}`, type: 'kamelya', status: "boş", order: [], total: 0, waiterId: null, waiterUsername: null });
    }
    for (let i = 1; i <= 16; i++) {
        clientTables.push({ id: `masa-${currentId++}`, name: `Bahçe ${i}`, type: 'bahce', status: "boş", order: [], total: 0, waiterId: null, waiterUsername: null });
    }
    clientNextTableIdCounter = currentId;
    console.log(`${clientTables.length} masa istemci tarafında oluşturuldu.`);
    return clientTables;
}

const appState = {
    user: null,
    products: staticProducts, // Ürünleri doğrudan ata
    tables: initializeClientTables(), // Masaları doğrudan oluştur ve ata
    currentTableId: null,
    salesReport: [],
    activityLog: [],
    currentQuickSaleOrder: [],
    currentOrderOriginalTotal: 0,
    currentOrderDiscountAmount: 0,
    waiters: [] // Garsonlar sunucudan gelmeye devam edebilir veya sabit kodlanabilir
};

// DOM Elementleri (Global olarak erişilebilir)
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingMessage = document.getElementById('loadingMessage');
const loginModal = document.getElementById('loginModal');
const usernameInput = document.getElementById('usernameInput');
const passwordInput = document.getElementById('passwordInput');
const loginButton = document.getElementById('loginButton');
const loginError = document.getElementById('loginError');
const appContainer = document.getElementById('appContainer');
const activeUserNameSpan = document.getElementById('activeUserName');
const activeUserRoleSpan = document.getElementById('activeUserRole');
const logoutButton = document.getElementById('logoutButton');

const salesReportButton = document.getElementById('salesReportButton');
const activityLogButton = document.getElementById('activityLogButton');
const quickSaleEntryButton = document.getElementById('quickSaleEntryButton');
const quickSaleButtonContainerTop = document.getElementById('quickSaleButtonContainerTop');
const addProductToMenuButton = document.getElementById('addProductToMenuButton');
const editProductMenuButton = document.getElementById('editProductMenuButton');
const manageTablesButton = document.getElementById('manageTablesButton');
const manageWaitersButton = document.getElementById('manageWaitersButton');

const tablesGrid = document.getElementById('tablesGrid');
const productsListRef = document.getElementById('productsListRef');

// Sipariş Sayfası Elementleri
const orderPageContainer = document.getElementById('orderPageContainer');
const orderPageTableName = document.getElementById('orderPageTableName');
const orderPageWaiterInfo = document.getElementById('orderPageWaiterInfo');
const backToTablesButton = document.getElementById('backToTablesButton');
const orderPageProductGrid = document.getElementById('orderPageProductGrid');
const orderPageCurrentOrderItems = document.getElementById('orderPageCurrentOrderItems');
const orderPageCurrentOrderTotal = document.getElementById('orderPageCurrentOrderTotal');
const discountInfoDiv = document.getElementById('discountInfo');
const applyDiscountButton = document.getElementById('applyDiscountButton');
const showReceiptButton = document.getElementById('showReceiptButton');
const finalizeAndCloseTableButton = document.getElementById('finalizeAndCloseTableButton');

// Manuel Ürün Ekleme Elementleri (Sipariş Sayfası)
const manualProductSection = document.getElementById('manualProductSection');
const manualProductName = document.getElementById('manualProductName');
const manualProductCategory = document.getElementById('manualProductCategory');
const manualProductPrice = document.getElementById('manualProductPrice');
const manualProductQuantity = document.getElementById('manualProductQuantity');
const manualProductDescription = document.getElementById('manualProductDescription');
const addManualProductButton = document.getElementById('addManualProductButton');

// Hızlı Satış Modalı Elementleri
const quickSaleModal = document.getElementById('quickSaleModal');
const closeQuickSaleModalButton = document.getElementById('closeQuickSaleModalButton');
const quickSaleProductGrid = document.getElementById('quickSaleProductGrid');
const quickSaleCurrentItems = document.getElementById('quickSaleCurrentItems');
const quickSaleTotal = document.getElementById('quickSaleTotal');
const quickSaleDiscountInfo = document.getElementById('quickSaleDiscountInfo');
const applyQuickSaleDiscountButton = document.getElementById('applyQuickSaleDiscountButton');
const completeQuickSaleButton = document.getElementById('completeQuickSaleButton');

// Fiş Modalı Elementleri
const receiptModal = document.getElementById('receiptModal');
const receiptModalContent = document.getElementById('receiptModalContent');
const receiptDate = document.getElementById('receiptDate');
const receiptTableName = document.getElementById('receiptTableName');
const receiptWaiterName = document.getElementById('receiptWaiterName');
const receiptItems = document.getElementById('receiptItems');
const receiptDiscountInfo = document.getElementById('receiptDiscountInfo');
const receiptSubtotal = document.getElementById('receiptSubtotal');
const receiptDiscountAmount = document.getElementById('receiptDiscountAmount');
const receiptGrandTotal = document.getElementById('receiptGrandTotal');
const printReceiptButton = document.getElementById('printReceiptButton');
const closeReceiptModalOnlyButton = document.getElementById('closeReceiptModalOnlyButton');

// Onay Modalları Elementleri
const confirmCloseTableModal = document.getElementById('confirmCloseTableModal');
const confirmCloseTableYesButton = document.getElementById('confirmCloseTableYesButton');
const confirmCloseTableNoButton = document.getElementById('confirmCloseTableNoButton');
const confirmDiscountModal = document.getElementById('confirmDiscountModal');
const confirmDiscountYesButton = document.getElementById('confirmDiscountYesButton');
const confirmDiscountNoButton = document.getElementById('confirmDiscountNoButton');
const confirmExitAppModal = document.getElementById('confirmExitAppModal');
const confirmExitAppYesButton = document.getElementById('confirmExitAppYesButton');
const confirmExitAppNoButton = document.getElementById('confirmExitAppNoButton');

// Menüye Ürün Ekleme Modalı Elementleri
const addProductToMenuModal = document.getElementById('addProductToMenuModal');
const closeAddProductToMenuModalButton = document.getElementById('closeAddProductToMenuModalButton');
const newProductNameInput = document.getElementById('newProductName');
const newProductPriceInput = document.getElementById('newProductPrice');
const newProductCategorySelect = document.getElementById('newProductCategory');
const newProductCategoryInput = document.getElementById('newProductCategoryInput');
const saveNewProductButton = document.getElementById('saveNewProductButton');

// Ürün Düzenleme Modalı Elementleri
const editProductModal = document.getElementById('editProductModal');
const closeEditProductModalButton = document.getElementById('closeEditProductModalButton');
const selectProductToEdit = document.getElementById('selectProductToEdit');
const editProductFormDiv = document.getElementById('editProductFormDiv');
const editingProductIdInput = document.getElementById('editingProductId');
const editProductNameInput = document.getElementById('editProductName');
const editProductPriceInput = document.getElementById('editProductPrice');
const editProductCategorySelect = document.getElementById('editProductCategory');
const editProductCategoryInput = document.getElementById('editProductCategoryInput');
const saveEditedProductButton = document.getElementById('saveEditedProductButton');

// Masa Yönetimi Modalı Elementleri
const manageTablesModal = document.getElementById('manageTablesModal');
const closeManageTablesModalButton = document.getElementById('closeManageTablesModalButton');
const newTableNameInput = document.getElementById('newTableNameInput');
const addNewTableButton = document.getElementById('addNewTableButton');
const selectTableToEditName = document.getElementById('selectTableToEditName');
const editTableNameInput = document.getElementById('editTableNameInput');
const updateTableNameButton = document.getElementById('updateTableNameButton');
const selectTableToDelete = document.getElementById('selectTableToDelete');
const deleteTableButton = document.getElementById('deleteTableButton');
const confirmDeleteTableModal = document.getElementById('confirmDeleteTableModal');
const tableNameToDeleteSpan = document.getElementById('tableNameToDeleteSpan');
const confirmDeleteTableYesButton = document.getElementById('confirmDeleteTableYesButton');
const confirmDeleteTableNoButton = document.getElementById('confirmDeleteTableNoButton');

// Garson Yönetimi Modalı Elementleri
const manageWaitersModal = document.getElementById('manageWaitersModal');
const closeManageWaitersModalButton = document.getElementById('closeManageWaitersModalButton');
const newWaiterUsernameInput = document.getElementById('newWaiterUsernameInput');
const newWaiterPasswordInput = document.getElementById('newWaiterPasswordInput');
const addNewWaiterButton = document.getElementById('addNewWaiterButton');
const selectWaiterToEditPassword = document.getElementById('selectWaiterToEditPassword');
const editWaiterPasswordInput = document.getElementById('editWaiterPasswordInput');
const updateWaiterPasswordButton = document.getElementById('updateWaiterPasswordButton');
const selectWaiterToDelete = document.getElementById('selectWaiterToDelete');
const deleteWaiterButton = document.getElementById('deleteWaiterButton');
const confirmDeleteWaiterModal = document.getElementById('confirmDeleteWaiterModal');
const waiterNameToDeleteSpan = document.getElementById('waiterNameToDeleteSpan');
const confirmDeleteWaiterYesButton = document.getElementById('confirmDeleteWaiterYesButton');
const confirmDeleteWaiterNoButton = document.getElementById('confirmDeleteWaiterNoButton');

// Satış Raporu Modalı Elementleri
const salesReportModal = document.getElementById('salesReportModal');
const salesReportModalContent = document.getElementById('salesReportModalContent');
const closeSalesReportModalButton = document.getElementById('closeSalesReportModalButton');
const salesReportTableContainer = document.getElementById('salesReportTableContainer');
const totalItemsSoldSpan = document.getElementById('totalItemsSold');
const grandTotalSalesSpan = document.getElementById('grandTotalSales');
const refreshSalesReportButton = document.getElementById('refreshSalesReportButton');
const printSalesReportButton = document.getElementById('printSalesReportButton');

// Aktivite Logları Modalı Elementleri
const activityLogModal = document.getElementById('activityLogModal');
const activityLogModalContent = document.getElementById('activityLogModalContent');
const closeActivityLogModalButton = document.getElementById('closeActivityLogModalButton');
const activityLogTableContainer = document.getElementById('activityLogTableContainer');
const refreshActivityLogButton = document.getElementById('refreshActivityLogButton');

// --- Yardımcı Fonksiyonlar ---
function formatPrice(price) {
    if (typeof price !== 'number' || isNaN(price)) {
        return '0 ₺';
    }
    const formatted = price.toFixed(2).replace('.', ',');
    if (formatted.endsWith(',00')) {
        return formatted.substring(0, formatted.length - 3) + ' ₺';
    }
    return formatted + ' ₺';
}

function formatTimestamp(timestampInput) {
    if (!timestampInput) {
        return '-';
    }
    let initialDate;
    if (typeof timestampInput === 'number') {
        initialDate = new Date(timestampInput);
    } else if (timestampInput instanceof Date) {
        initialDate = timestampInput;
    } else if (typeof timestampInput === 'string') {
        const parts = timestampInput.match(/^(\d{2})\.(\d{2})\.(\d{4}) (\d{2}):(\d{2}):(\d{2})$/);
        if (parts) {
            const year = parseInt(parts[3], 10);
            const monthIndex = parseInt(parts[2], 10) - 1;
            const day = parseInt(parts[1], 10);
            const hour = parseInt(parts[4], 10);
            const minute = parseInt(parts[5], 10);
            const second = parseInt(parts[6], 10);
            const utcTimestamp = Date.UTC(year, monthIndex, day, hour, minute, second);
            initialDate = new Date(utcTimestamp);
        } else {
            initialDate = new Date(timestampInput);
        }
    } else {
        console.warn("formatTimestamp: Bilinmeyen zaman damgası türü:", timestampInput);
        return '-';
    }

    if (!initialDate || isNaN(initialDate.getTime())) {
        console.warn("formatTimestamp: Geçersiz tarih oluşturuldu. Giriş:", timestampInput);
        return '-';
    }

    try {
        const options = {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit',
            timeZone: 'Europe/Istanbul', hour12: false
        };
        let formattedDate = new Intl.DateTimeFormat('tr-TR', options).format(initialDate);
        return formattedDate.replace(',', '');
    } catch (e) {
        console.error("Intl.DateTimeFormat ile tarih formatlama hatası:", e);
        const day = String(initialDate.getDate()).padStart(2, '0');
        const month = String(initialDate.getMonth() + 1).padStart(2, '0');
        const year = initialDate.getFullYear();
        const hours = String(initialDate.getHours()).padStart(2, '0');
        const minutes = String(initialDate.getMinutes()).padStart(2, '0');
        return `${day}.${month}.${year} ${hours}:${minutes}`;
    }
}

function getCurrentFormattedDate() {
    const now = new Date();
    return formatTimestamp(now);
}

function showLoading(message = "İşleniyor...") {
    loadingMessage.textContent = message;
    loadingOverlay.classList.add('active');
}

function hideLoading() {
    loadingOverlay.classList.remove('active');
}

function sanitizeCategoryForCSS(categoryName) {
    if (!categoryName) return 'default';
    const turkishMap = { 'İ': 'I', 'ı': 'i', 'Ö': 'O', 'ö': 'o', 'Ü': 'U', 'ü': 'u', 'Ş': 'S', 'ş': 's', 'Ğ': 'G', 'ğ': 'g', 'Ç': 'C', 'ç': 'c' };
    return categoryName
        .replace(/[İıÖöÜüŞşĞğÇç]/g, match => turkishMap[match] || match)
        .replace(/&/g, 'AND')
        .replace(/\s+/g, '-')
        .replace(/[^a-zA-Z0-9-]/g, '')
        .toUpperCase();
}

const WEBSOCKET_URL = (() => {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const host = window.location.hostname;
    const port = window.location.port;
    if (host === "localhost" || host === "127.0.0.1") {
        return `ws://${host}:8080`; // Yerel sunucu portunuz
    }
    return `${protocol}//${host}${port ? ':' + port : ''}`;
})();

function connectWebSocket() {
    showLoading("Sunucuya bağlanılıyor...");
    console.log("WebSocket bağlantısı kuruluyor:", WEBSOCKET_URL);
    socket = new WebSocket(WEBSOCKET_URL);

    socket.onopen = () => {
        console.log("WebSocket bağlantısı kuruldu.");
        hideLoading();
        const storedUser = localStorage.getItem('adisyonUser');
        if (storedUser) {
            try {
                appState.user = JSON.parse(storedUser);
                console.log("Oturum bulundu:", appState.user.username);
                // Oturum bulunduğunda, UI'ı hemen sabit kodlu verilerle render et
                activeUserNameSpan.textContent = appState.user.username;
                activeUserRoleSpan.textContent = appState.user.role;
                loginModal.classList.remove('active');
                appContainer.classList.remove('hidden');
                renderInitialDataIfNeeded();
                renderTables();
                updateUIForRole();
                // Sunucuya reauthenticate gönder, sunucu daha sonra güncel product/table gönderirse onlar da işlenir.
                sendMessageToServer('reauthenticate', { user: appState.user });
            } catch (e) {
                console.error("localStorage'dan kullanıcı verisi okunamadı:", e);
                localStorage.removeItem('adisyonUser');
                showLoginScreen();
            }
        } else {
            // Sabit kodlu products ve tables zaten appState'de var, login ekranını göster.
            // UI render fonksiyonları login sonrası çağrılacak.
            renderInitialDataIfNeeded(); // Kategori select'leri vb. doldurmak için
            showLoginScreen();
        }
    };

    socket.onmessage = (event) => {
        let message;
        try {
            message = JSON.parse(event.data);
        } catch (error) {
            console.error("JSON.parse BAŞARISIZ!", "Hata:", error, "Alınan Veri:", event.data);
            return;
        }
        handleServerMessage(message);
    };

    socket.onerror = (error) => {
        console.error("WebSocket hatası:", error);
        showLoginError("Sunucu bağlantı hatası. Lütfen daha sonra tekrar deneyin veya sayfayı yenileyin.");
        hideLoading();
    };

    socket.onclose = (event) => {
        console.log("WebSocket bağlantısı kapandı. Kod:", event.code, "Neden:", event.reason);
        showLoginError("Sunucu bağlantısı kesildi. Yeniden bağlanmak için sayfayı yenileyin.");
        showLoginScreen();
        hideLoading();
    };
}

function sendMessageToServer(type, payload) {
    if (socket && socket.readyState === WebSocket.OPEN) {
        const message = JSON.stringify({ type, payload });
        socket.send(message);
    } else {
        console.error("WebSocket bağlantısı açık değil veya henüz kurulmadı.");
        if (!appState.user) {
            showLoginError("Lütfen önce giriş yapın.");
            showLoginScreen();
        } else {
            showLoginError("Sunucuya mesaj gönderilemedi. Bağlantı sorunu. Sayfayı yenilemeyi deneyin.");
        }
    }
}

function handleServerMessage(message) {
    hideLoading();
    switch (message.type) {
        case 'login_success':
            const userDataFromServer = message.payload.user || message.payload.waiter;
            if (message.payload && typeof message.payload === 'object' && userDataFromServer && typeof userDataFromServer === 'object') {
                appState.user = userDataFromServer;
                // Sunucudan gelen products ve tables ile appState'i GÜNCELLE (ezme)
                // Eğer sunucu bu bilgileri gönderiyorsa ve sabit kodlanmıştan farklıysa, bunlar kullanılır.
                if (message.payload.tables && Array.isArray(message.payload.tables)) {
                    appState.tables = message.payload.tables; // Sunucudan gelen masaları kullan
                }
                if (message.payload.products && Array.isArray(message.payload.products)) {
                    appState.products = message.payload.products; // Sunucudan gelen ürünleri kullan
                    initialDataRendered = false; // Ürünler değişti, yeniden render et
                }
                localStorage.setItem('adisyonUser', JSON.stringify(appState.user));
                activeUserNameSpan.textContent = appState.user.username;
                activeUserRoleSpan.textContent = appState.user.role;
                loginModal.classList.remove('active');
                appContainer.classList.remove('hidden');
                orderPageContainer.classList.remove('active');
                loginError.textContent = '';
                renderInitialDataIfNeeded();
                renderTables();
                updateUIForRole();
                console.log("Giriş başarılı ve UI güncellendi (sunucu verileriyle):", appState.user.username);
            } else {
                showLoginError("Sunucudan eksik veya hatalı giriş yanıtı alındı.");
                appState.user = null;
                localStorage.removeItem('adisyonUser');
                showLoginScreen();
            }
            break;

        case 'login_fail':
            showLoginError(message.payload.error || "Kullanıcı adı veya şifre hatalı.");
            localStorage.removeItem('adisyonUser');
            break;

        case 'error':
            alert(`Sunucu Hatası: ${message.payload.message || 'Bilinmeyen bir sunucu hatası oluştu.'}`);
            console.error("Sunucudan hata mesajı alındı:", message.payload);
            break;

        case 'tables_update':
            if (message.payload && Array.isArray(message.payload.tables)) {
                appState.tables = message.payload.tables; // Sunucudan gelen masalarla güncelle
                renderTables();
                console.log("Masalar sunucudan güncellendi.");
                if (orderPageContainer.classList.contains('active') && appState.currentTableId) {
                    const updatedTable = appState.tables.find(t => t.id === appState.currentTableId);
                    if (updatedTable) {
                        renderOrderPageForTable(updatedTable);
                    } else {
                        showTablesView();
                    }
                }
                if (manageTablesModal.classList.contains('active')) {
                    populateTableSelectsForManagement();
                }
            } else {
                console.warn("'tables_update' mesajı alındı ancak payload.tables eksik veya array değil.", message.payload);
            }
            break;

        case 'products_list':
        case 'products_update':
            if (message.payload && Array.isArray(message.payload.products)) {
                appState.products = message.payload.products; // Sunucudan gelen ürünlerle güncelle
                console.log(`Ana ürün listesi sunucudan güncellendi (tip: ${message.type}).`);
                initialDataRendered = false;
                renderInitialDataIfNeeded();
                if (orderPageContainer.classList.contains('active') && appState.currentTableId) {
                    const currentTable = appState.tables.find(t => t.id === appState.currentTableId);
                    if (currentTable) {
                       renderOrderPageForTable(currentTable);
                    }
                }
                if (quickSaleModal.classList.contains('active')) {
                    renderProductGrid(quickSaleProductGrid, true);
                }
                if (editProductModal.classList.contains('active')) {
                    populateSelectProductToEdit();
                }
            } else {
                console.warn(`'${message.type}' mesajı alındı ancak payload.products eksik veya array değil.`, message.payload);
            }
            break;

        case 'main_menu_product_added':
            alert(message.payload.message || "Yeni ürün menüye eklendi!");
            // Sunucu bu işlemden sonra 'products_update' göndermeli
            break;

         case 'main_menu_product_updated':
            alert(message.payload.message || "Ürün menüde güncellendi!");
            // Sunucu bu işlemden sonra 'products_update' göndermeli
            break;

        case 'table_operation_success':
            alert(message.payload.message || "Masa işlemi başarılı.");
            // Sunucu bu işlemden sonra 'tables_update' göndermeli
            break;

        case 'table_operation_fail':
            alert(message.payload.error || "Masa işlemi başarısız oldu.");
            break;

        case 'waiters_list':
            if (message.payload && Array.isArray(message.payload.waiters)) {
                appState.waiters = message.payload.waiters;
                populateWaiterSelectsForManagement();
            }
            break;

        case 'waiter_operation_success':
            alert(message.payload.message || "Garson işlemi başarılı.");
            sendMessageToServer('get_waiters_list', {});
            break;

        case 'waiter_operation_fail':
            alert(message.payload.error || "Garson işlemi başarısız oldu.");
            break;

        case 'sales_report_data':
            appState.salesReport = message.payload.sales || [];
            renderSalesReport();
            break;

        case 'activity_log_data':
            appState.activityLog = message.payload.logs || [];
            renderActivityLog();
            break;

        case 'order_update_fail':
            alert(`Sipariş güncellenemedi: ${message.payload.error}`);
            break;

        case 'manual_order_update_fail':
            alert(`Manuel ürün eklenemedi: ${message.payload.error}`);
            break;

        case 'quick_sale_success':
            console.log("Hızlı satış sunucuda tamamlandı.");
            break;

        case 'quick_sale_fail':
            alert(`Hızlı satış tamamlanamadı: ${message.payload.error}`);
            break;

        default:
            console.warn("handleServerMessage: Bilinmeyen mesaj tipi:", message.type, "Payload:", message.payload);
            break;
    }
}

function showLoginError(message) {
    loginError.textContent = message;
    passwordInput.value = '';
}

function showLoginScreen() {
    loginModal.classList.add('active');
    appContainer.classList.add('hidden');
    [orderPageContainer, quickSaleModal, addProductToMenuModal, editProductModal,
     manageTablesModal, manageWaitersModal, salesReportModal, activityLogModal,
     receiptModal, confirmCloseTableModal, confirmDiscountModal, confirmExitAppModal,
     confirmDeleteTableModal, confirmDeleteWaiterModal].forEach(el => el.classList.remove('active'));
}

window.handleAndroidBackButton = function() {
    const isActive = (element) => element && (element.classList.contains('active') || (element.style.display !== 'none' && getComputedStyle(element).display !== 'none'));
    const activeModals = [
        confirmExitAppModal, confirmCloseTableModal, confirmDiscountModal,
        confirmDeleteTableModal, confirmDeleteWaiterModal, receiptModal,
        salesReportModal, activityLogModal, manageWaitersModal, manageTablesModal,
        editProductModal, addProductToMenuModal, quickSaleModal
    ];
    for (const modal of activeModals) {
        if (isActive(modal)) {
            if (modal === receiptModal) closeReceiptModalOnly();
            else if (modal === quickSaleModal) {
                quickSaleModal.classList.remove('active'); showTablesView();
            }
            else modal.classList.remove('active');
            console.log("Geri tuşu: Modal kapatıldı -", modal.id); return;
        }
    }
    if (isActive(orderPageContainer)) { console.log("Geri tuşu: Sipariş sayfasından ana ekrana dönülüyor."); showTablesView(); return; }
    if (isActive(appContainer) && !isActive(loginModal)) { console.log("Geri tuşu: Ana ekranda, çıkış onayı gösteriliyor."); confirmExitAppModal.classList.add('active'); return; }
    if (isActive(loginModal)) {
        console.log("Geri tuşu: Login ekranında, uygulama kapanabilir.");
        if (window.Android && typeof window.Android.closeApp === 'function') window.Android.closeApp();
        else console.warn("Login ekranında geri tuşuna basıldı, ancak 'window.Android.closeApp' bulunamadı.");
        return;
    }
    console.log("Geri tuşu: Tanımlanmayan durum, varsayılan çıkış.");
    if (window.Android && typeof window.Android.closeApp === 'function') window.Android.closeApp();
};

function updateUIForRole() {
    if (!appState.user) return;
    console.log("UI güncelleniyor. Kullanıcı rolü:", appState.user.role);
    const isCashier = appState.user.role === 'cashier';
    [manualProductSection, salesReportButton, quickSaleButtonContainerTop,
     addProductToMenuButton, editProductMenuButton, manageTablesButton,
     manageWaitersButton, finalizeAndCloseTableButton, applyDiscountButton,
     applyQuickSaleDiscountButton, activityLogButton].forEach(el => {
        if (el) el.classList.toggle('hidden', !isCashier);
     });
    logoutButton.textContent = "Uygulamadan Çık";
}

let initialDataRendered = false;
function renderInitialDataIfNeeded() {
    // Sabit kodlu products ve tables zaten appState'de var.
    // Bu fonksiyon artık sadece UI elemanlarını (gridler, selectler) render etmeli.
    if (!initialDataRendered || appState.products.length > 0) {
        renderProductGrid(orderPageProductGrid, false);
        renderProductGrid(quickSaleProductGrid, true);
        renderProductsForReference();
        populateManualCategorySelect();
        populateNewProductCategorySelect();
        populateEditProductCategorySelect();
        initialDataRendered = true;
        console.log("İlk UI render edildi (ürün gridleri, referans menü, kategori selectleri).");
    }
}

function renderTables() {
    console.log("[renderTables] Fonksiyon çağrıldı. Masa sayısı:", appState.tables ? appState.tables.length : 0);
    tablesGrid.innerHTML = '';
    if (!appState.tables || appState.tables.length === 0) {
         tablesGrid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">Masa bilgisi bekleniyor veya hiç masa tanımlanmamış...</p>';
         return;
    }
    appState.tables.forEach(table => {
        const tableCard = document.createElement('div');
        const isDolu = table.status === 'dolu' && table.order && table.order.length > 0;
        let baseColorClass = 'bg-gray-400 hover:bg-gray-500';
        if (table.type === 'kamelya') baseColorClass = 'bg-yellow-500 hover:bg-yellow-600';
        else if (table.type === 'bahce') baseColorClass = 'bg-green-500 hover:bg-green-600';
        tableCard.className = `p-4 rounded-lg shadow-md cursor-pointer transition-all duration-200 ease-in-out transform hover:scale-105 ${isDolu ? 'bg-red-500 hover:bg-red-600' : baseColorClass}`;
        let waiterInfoHtml = isDolu && table.waiterUsername ? `<p class="text-xs text-white text-center mt-1">Garson: ${table.waiterUsername}</p>` : '';
        tableCard.innerHTML = `
            <h3 class="text-xl font-semibold text-white text-center">${table.name}</h3>
            <p class="text-sm text-white text-center capitalize">${isDolu ? 'Dolu' : 'Boş'}</p>
            ${isDolu ? `<p class="text-xs text-white text-center mt-1">Toplam: ${formatPrice(table.total)}</p>` : ''}
            ${waiterInfoHtml}
        `;
        tableCard.addEventListener('click', () => selectTableForOrder(table.id));
        tablesGrid.appendChild(tableCard);
    });
}

function renderProductGrid(targetGridElement, forQuickSale = false) {
    targetGridElement.innerHTML = '';
    if (!appState.products || appState.products.length === 0) {
        targetGridElement.innerHTML = '<p class="text-gray-500 text-center py-4">Ürün listesi boş veya yüklenemedi.</p>';
        return;
    }
    const categories = {};
    const categorySectionColors = { "ET-TAVUK": "category-section-bg-ET-TAVUK", "ATIŞTIRMALIK": "category-section-bg-ATIŞTIRMALIK", "TATLI": "category-section-bg-TATLI", "İÇECEK": "category-section-bg-İÇECEK", "ÇORBA": "category-section-bg-ÇORBA", "DİĞER": "category-section-bg-DİĞER" };
    const productCardColors = { "ET-TAVUK": "product-card-bg-ET-TAVUK", "ATIŞTIRMALIK": "product-card-bg-ATIŞTIRMALIK", "TATLI": "product-card-bg-TATLI", "İÇECEK": "product-card-bg-İÇECEK", "ÇORBA": "product-card-bg-ÇORBA", "DİĞER": "product-card-bg-DİĞER" };
    const defaultSectionColor = "category-section-bg-default";
    const defaultCardColor = "product-card-bg-default";

    appState.products.forEach(product => {
        const categoryKey = product.category || 'DİĞER';
        if (!categories[categoryKey]) categories[categoryKey] = [];
        categories[categoryKey].push(product);
    });
    const categoryOrder = ["ÇORBA", "ET - TAVUK", "ATIŞTIRMALIK", "İÇECEK", "TATLI", "DİĞER"];
    const sortedCategoryNames = Object.keys(categories).sort((a, b) => {
        const indexA = categoryOrder.indexOf(a); const indexB = categoryOrder.indexOf(b);
        if (indexA !== -1 && indexB !== -1) return indexA - indexB;
        if (indexA !== -1) return -1; if (indexB !== -1) return 1;
        return a.localeCompare(b, 'tr');
    });

    sortedCategoryNames.forEach(category => {
        const categorySection = document.createElement('div');
        const sanitizedCatName = sanitizeCategoryForCSS(category);
        const sectionBgColorClass = categorySectionColors[sanitizedCatName] || defaultSectionColor;
        categorySection.className = `mb-6 p-4 rounded-lg ${sectionBgColorClass}`;
        const categoryTitle = document.createElement('h4');
        categoryTitle.className = 'text-lg font-semibold mb-3 text-gray-700 border-b border-gray-400 pb-1';
        categoryTitle.textContent = category;
        categorySection.appendChild(categoryTitle);
        const productGridDiv = document.createElement('div');
        productGridDiv.className = forQuickSale ? 'grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2' : 'grid grid-cols-2 md:grid-cols-3 gap-3';
        categories[category].sort((a, b) => a.name.localeCompare(b.name, 'tr')).forEach(product => {
            const card = document.createElement('div');
            const cardBgColorClass = productCardColors[sanitizedCatName] || defaultCardColor;
            card.className = `product-card ${cardBgColorClass} ${forQuickSale ? 'quick-sale-card' : ''}`;
            card.dataset.productId = product.id;
            if (forQuickSale) {
                card.innerHTML = `<h5>${product.name}</h5><button data-product-id="${product.id}" class="add-item-from-card-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-2 rounded w-full mt-auto">Ekle</button>`;
            } else {
                card.innerHTML = `<div><h5>${product.name}</h5><p class="product-price">${formatPrice(product.price)}</p></div><div class="mt-2"><input type="text" placeholder="Açıklama..." class="description-input border border-gray-300 rounded text-xs p-1 w-full mb-2"><div class="product-card-quantity flex items-center justify-center space-x-1"><button class="quantity-decrease bg-red-200 hover:bg-red-300 text-red-700 font-bold rounded">-</button><input type="number" value="1" min="1" class="quantity-input border border-gray-300 rounded text-xs p-1"><button class="quantity-increase bg-green-200 hover:bg-green-300 text-green-700 font-bold rounded">+</button></div></div><button data-product-id="${product.id}" class="add-item-from-card-btn bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1 px-2 rounded w-full mt-2">Siparişe Ekle</button>`;
            }
            productGridDiv.appendChild(card);
        });
        categorySection.appendChild(productGridDiv);
        targetGridElement.appendChild(categorySection);
    });
    addProductCardEventListeners(targetGridElement, forQuickSale);
}

function addProductCardEventListeners(targetGridElement, forQuickSale) {
    targetGridElement.querySelectorAll('.add-item-from-card-btn').forEach(addBtn => {
        addBtn.addEventListener('click', () => {
            const card = addBtn.closest('.product-card');
            const productId = card.dataset.productId;
            if (forQuickSale) {
                addProductToQuickSale(productId, 1, '');
            } else {
                const quantityInput = card.querySelector('.quantity-input');
                const descriptionInput = card.querySelector('.description-input');
                const quantity = parseInt(quantityInput.value) || 1;
                const description = descriptionInput ? descriptionInput.value.trim() : '';
                addProductToOrder(productId, quantity, description);
                quantityInput.value = 1;
                if (descriptionInput) descriptionInput.value = '';
            }
        });
    });
    if (!forQuickSale) {
        targetGridElement.querySelectorAll('.quantity-decrease').forEach(btn => {
            btn.addEventListener('click', () => { const input = btn.nextElementSibling; let val = parseInt(input.value); if (val > 1) input.value = val - 1; });
        });
        targetGridElement.querySelectorAll('.quantity-increase').forEach(btn => {
            btn.addEventListener('click', () => { const input = btn.previousElementSibling; input.value = parseInt(input.value) + 1; });
        });
    }
}

function addProductToOrder(productId, quantity, description) {
    const product = appState.products.find(p => String(p.id) === String(productId));
    if (!product || quantity <= 0 || !appState.currentTableId) { alert("Ürün siparişe eklenirken bir hata oluştu."); return; }
    showLoading("Sipariş ekleniyor...");
    sendMessageToServer('add_order_item', { tableId: appState.currentTableId, productId: parseInt(productId), quantity: quantity, description: description });
    resetCurrentOrderDiscount();
}

function addProductToQuickSale(productId, quantity, description) {
    const product = appState.products.find(p => String(p.id) === String(productId));
    if (!product || quantity <= 0) { alert("Ürün hızlı satış sepetine eklenirken bir hata oluştu."); return; }
    const existingItem = appState.currentQuickSaleOrder.find(item => item.productId === parseInt(productId) && item.description === description);
    if (existingItem) { existingItem.quantity += quantity; }
    else { appState.currentQuickSaleOrder.push({ productId: parseInt(productId), name: product.name, priceAtOrder: product.price, quantity: quantity, description: description, waiterUsername: appState.user.username, timestamp: Date.now() }); }
    resetCurrentOrderDiscount();
    renderQuickSaleOrder();
}

function renderQuickSaleOrder() {
    quickSaleCurrentItems.innerHTML = '';
    let originalTotal = 0;
    if (appState.currentQuickSaleOrder.length === 0) { quickSaleCurrentItems.innerHTML = '<p class="text-gray-500 text-center py-4">Sepet boş.</p>'; }
    else {
        appState.currentQuickSaleOrder.forEach((item, index) => {
            const itemTotal = item.priceAtOrder * item.quantity; originalTotal += itemTotal;
            const itemDiv = document.createElement('div'); itemDiv.className = 'flex justify-between items-start p-2 bg-white rounded-md text-sm shadow';
            let descriptionHTML = item.description ? `<p class="text-xs text-gray-500 italic ml-2">(${item.description})</p>` : '';
            itemDiv.innerHTML = `<div class="flex-grow"><span class="font-medium">${item.name}</span><span class="text-xs text-gray-600"> (${item.quantity} x ${formatPrice(item.priceAtOrder)})</span>${descriptionHTML}</div><div class="flex items-center"><span class="font-semibold mr-2">${formatPrice(itemTotal)}</span><button data-index="${index}" class="remove-item-quick-sale-btn text-red-500 hover:text-red-700 font-bold p-1 rounded-full hover:bg-red-100 transition-colors">&times;</button></div>`;
            quickSaleCurrentItems.appendChild(itemDiv);
        });
    }
    appState.currentOrderOriginalTotal = originalTotal;
    if (appState.currentOrderDiscountAmount > 0 && originalTotal > 0) {
        const discountedTotal = originalTotal - appState.currentOrderDiscountAmount;
        quickSaleTotal.textContent = `Toplam: ${formatPrice(discountedTotal)} (İndirimli)`;
        quickSaleDiscountInfo.textContent = `İndirim Uygulandı: -${formatPrice(appState.currentOrderDiscountAmount)}`;
        quickSaleDiscountInfo.classList.remove('hidden');
    } else {
        quickSaleTotal.textContent = `Toplam: ${formatPrice(originalTotal)}`;
        quickSaleDiscountInfo.classList.add('hidden');
    }
    quickSaleCurrentItems.querySelectorAll('.remove-item-quick-sale-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const itemIndex = parseInt(e.target.closest('button').dataset.index);
            appState.currentQuickSaleOrder.splice(itemIndex, 1);
            resetCurrentOrderDiscount(); renderQuickSaleOrder();
        });
    });
}

function populateCategorySelect(selectElement) {
    selectElement.innerHTML = '<option value="">Mevcut Kategori Seçin</option>';
    const uniqueCategories = [...new Set(appState.products.map(p => p.category || "DİĞER"))].sort((a,b) => a.localeCompare(b, 'tr'));
    uniqueCategories.forEach(category => { const option = document.createElement('option'); option.value = category; option.textContent = category; selectElement.appendChild(option); });
}
function populateManualCategorySelect() { populateCategorySelect(manualProductCategory); }
function populateNewProductCategorySelect() {
    populateCategorySelect(newProductCategorySelect);
    newProductCategorySelect.innerHTML += '<option value="YENI">** YENİ KATEGORİ **</option>';
    newProductCategorySelect.addEventListener('change', () => { newProductCategoryInput.classList.toggle('hidden', newProductCategorySelect.value !== 'YENI'); if(newProductCategorySelect.value === 'YENI') newProductCategoryInput.focus(); else newProductCategoryInput.value = ''; });
}
function populateEditProductCategorySelect() {
    populateCategorySelect(editProductCategorySelect);
    editProductCategorySelect.innerHTML += '<option value="YENI_EDIT">** YENİ KATEGORİ **</option>';
    editProductCategorySelect.addEventListener('change', () => { editProductCategoryInput.classList.toggle('hidden', editProductCategorySelect.value !== 'YENI_EDIT'); if(editProductCategorySelect.value === 'YENI_EDIT') editProductCategoryInput.focus(); else editProductCategoryInput.value = ''; });
}

function renderProductsForReference() {
    productsListRef.innerHTML = '';
    if (!appState.products || appState.products.length === 0) { productsListRef.innerHTML = '<p class="text-gray-500 text-center py-4">Ürün listesi boş.</p>'; return; }
    const categories = {};
    appState.products.forEach(product => { const categoryKey = product.category || 'DİĞER'; if (!categories[categoryKey]) categories[categoryKey] = []; categories[categoryKey].push(product); });
    const categoryOrder = ["ÇORBA", "ET - TAVUK", "ATIŞTIRMALIK", "İÇECEK", "TATLI", "DİĞER"];
    const sortedCategoryNames = Object.keys(categories).sort((a, b) => { const indexA = categoryOrder.indexOf(a); const indexB = categoryOrder.indexOf(b); if (indexA !== -1 && indexB !== -1) return indexA - indexB; if (indexA !== -1) return -1; if (indexB !== -1) return 1; return a.localeCompare(b, 'tr'); });
    sortedCategoryNames.forEach(category => {
        const categoryTitle = document.createElement('h3'); categoryTitle.className = 'text-lg font-semibold mt-4 mb-2 text-blue-700'; categoryTitle.textContent = category; productsListRef.appendChild(categoryTitle);
        const ul = document.createElement('ul'); ul.className = 'space-y-1 text-sm';
        categories[category].sort((a,b) => a.name.localeCompare(b.name, 'tr')).forEach(product => { const li = document.createElement('li'); li.className = 'text-gray-800 flex justify-between'; li.innerHTML = `<span>${product.name}</span> <span class="font-medium">${formatPrice(product.price)}</span>`; ul.appendChild(li); });
        productsListRef.appendChild(ul);
    });
}

function renderOrderPageForTable(table) {
    orderPageCurrentOrderItems.innerHTML = '';
    appState.currentOrderOriginalTotal = 0;
    if (table.status === 'dolu' && table.waiterUsername) { orderPageWaiterInfo.textContent = `Bu Siparişi Alan Garson: ${table.waiterUsername}`; }
    else if (table.status === 'dolu' && !table.waiterUsername && appState.user && appState.user.role === 'cashier') { orderPageWaiterInfo.textContent = `Sipariş Alındı (Garson Belirsiz)`; }
    else { orderPageWaiterInfo.textContent = 'Bu Masaya Henüz Sipariş Alınmadı'; }

    if (!table || !table.order || table.order.length === 0) { orderPageCurrentOrderItems.innerHTML = '<p class="text-gray-500 py-4 text-center">Sipariş boş.</p>'; }
    else {
        let currentTotal = 0;
        table.order.forEach((item) => {
            const price = parseFloat(item.priceAtOrder); const qty = parseInt(item.quantity, 10);
            let itemCalculatedTotal = 0; if (!isNaN(price) && !isNaN(qty)) itemCalculatedTotal = price * qty;
            currentTotal += itemCalculatedTotal;
            const orderItemDiv = document.createElement('div'); orderItemDiv.className = 'flex justify-between items-start p-3 bg-gray-50 rounded-md shadow';
            let itemName = item.name || 'Bilinmeyen Ürün';
            const productDetails = appState.products.find(p => String(p.id) === String(item.productId));
            if(productDetails && !item.name) itemName = productDetails.name;
            const displayPrice = !isNaN(price) ? price : 0; const displayQty = !isNaN(qty) ? qty : 0;
            const currentItemDisplayTotal = displayPrice * displayQty;
            let descriptionHTML = item.description ? `<p class="text-xs text-gray-500 italic ml-2 mt-1">(${item.description})</p>` : '';
            let waiterNameHTML = item.waiterUsername ? `<p class="text-xs text-blue-600 ml-2 mt-1">Ekleyen: ${item.waiterUsername} (${formatTimestamp(item.timestamp)})</p>` : '';
            orderItemDiv.innerHTML = `<div class="flex-grow"><span class="font-medium">${itemName}</span><span class="text-sm text-gray-600"> (${displayQty} x ${formatPrice(displayPrice)})</span>${descriptionHTML}${waiterNameHTML}</div><div class="flex items-center ml-2"><span class="font-semibold mr-3">${formatPrice(currentItemDisplayTotal)}</span><button data-product-id="${item.productId || 'manual'}" data-item-name="${itemName}" data-item-description="${item.description || ''}" class="remove-item-btn-orderpage text-red-500 hover:text-red-700 text-lg font-bold p-1 rounded-full hover:bg-red-100 transition-colors">&times;</button></div>`;
            orderPageCurrentOrderItems.appendChild(orderItemDiv);
        });
        appState.currentOrderOriginalTotal = currentTotal;
    }
    if (appState.currentOrderDiscountAmount > 0 && appState.currentOrderOriginalTotal > 0) {
        const discounted = appState.currentOrderOriginalTotal - appState.currentOrderDiscountAmount;
        orderPageCurrentOrderTotal.textContent = `Toplam: ${formatPrice(discounted)} (İndirimli)`;
        discountInfoDiv.textContent = `İndirim Uygulandı: -${formatPrice(appState.currentOrderDiscountAmount)}`;
        discountInfoDiv.classList.remove('hidden');
    } else {
        orderPageCurrentOrderTotal.textContent = `Toplam: ${formatPrice(appState.currentOrderOriginalTotal)}`;
        discountInfoDiv.classList.add('hidden');
    }
    const isCashier = appState.user && appState.user.role === 'cashier';
    showReceiptButton.classList.toggle('hidden', !isCashier && (!table || !table.order || table.order.length === 0));
    finalizeAndCloseTableButton.classList.toggle('hidden', !isCashier);
    applyDiscountButton.classList.toggle('hidden', !isCashier);
    orderPageCurrentOrderItems.querySelectorAll('.remove-item-btn-orderpage').forEach(button => {
        button.addEventListener('click', (e) => {
            const btnElement = e.target.closest('button');
            const productIdToRemove = btnElement.dataset.productId; const descriptionToRemove = btnElement.dataset.description; const nameToRemove = btnElement.dataset.itemName;
            removeItemFromOrderPage(productIdToRemove, descriptionToRemove, nameToRemove);
        });
    });
}

function renderSalesReport() {
    salesReportTableContainer.innerHTML = ''; let totalItems = 0; let grandTotal = 0;
    if (!appState.salesReport || appState.salesReport.length === 0) { salesReportTableContainer.innerHTML = '<p class="text-center text-gray-500 py-6">Henüz tamamlanmış satış yok veya rapor yüklenemedi.</p>'; totalItemsSoldSpan.textContent = '0'; grandTotalSalesSpan.textContent = formatPrice(0); return; }
    const table = document.createElement('table'); table.className = 'w-full text-sm border-collapse border border-gray-300';
    table.innerHTML = `<thead class="bg-gray-100"><tr><th class="border p-2">Kapanış Zamanı</th><th class="border p-2">Masa/Satış Tipi</th><th class="border p-2">Ürün</th><th class="border p-2 text-center">Adet</th><th class="border p-2 text-right">Birim Fiyat</th><th class="border p-2 text-right">Toplam</th><th class="border p-2">Garson/Kasa</th><th class="border p-2">Açıklama</th><th class="border p-2">Ekleme Zamanı</th></tr></thead><tbody></tbody>`;
    const tbody = table.querySelector('tbody');
    appState.salesReport.forEach(item => {
        const itemPrice = parseFloat(item.item_price) || 0; const quantity = parseInt(item.quantity, 10) || 0;
        const itemTotal = parseFloat(item.total_item_price) || (itemPrice * quantity);
        totalItems += quantity; grandTotal += itemTotal;
        const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-gray-50';
        tr.innerHTML = `<td class="border p-2 whitespace-nowrap">${item.sale_timestamp}</td><td class="border p-2">${item.table_name || 'Hızlı Satış'}</td><td class="border p-2">${item.item_name || 'Bilinmeyen'}</td><td class="border p-2 text-center">${quantity}</td><td class="border p-2 text-right">${formatPrice(itemPrice)}</td><td class="border p-2 text-right">${formatPrice(itemTotal)}</td><td class="border p-2">${item.waiter_username || '-'}</td><td class="border p-2">${item.description || '-'}</td><td class="border p-2 whitespace-nowrap">${item.sale_timestamp}</td>`;
        tbody.appendChild(tr);
    });
    salesReportTableContainer.appendChild(table); totalItemsSoldSpan.textContent = totalItems; grandTotalSalesSpan.textContent = formatPrice(grandTotal);
}

function renderActivityLog() {
    activityLogTableContainer.innerHTML = '';
    if (!appState.activityLog || appState.activityLog.length === 0) { activityLogTableContainer.innerHTML = '<p class="text-center text-gray-500 py-6">Gösterilecek aktivite logu bulunmuyor.</p>'; return; }
    const table = document.createElement('table'); table.className = 'w-full text-sm border-collapse border border-gray-300';
    table.innerHTML = `<thead class="bg-gray-100"><tr><th class="border p-2">Zaman Damgası</th><th class="border p-2">Kullanıcı</th><th class="border p-2">İşlem Türü</th><th class="border p-2">Detaylar</th></tr></thead><tbody></tbody>`;
    const tbody = table.querySelector('tbody');
    appState.activityLog.forEach(log => {
        const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-gray-50';
        let detailsFormatted = log.log_details || '-';
        if (typeof log.log_details === 'string') { try { const parsed = JSON.parse(log.log_details); detailsFormatted = Object.entries(parsed).map(([key, value]) => `${key}: ${typeof value === 'object' ? JSON.stringify(value) : value}`).join('<br>'); } catch (e) {} }
        else if (typeof log.log_details === 'object' && log.log_details !== null) { detailsFormatted = Object.entries(log.log_details).map(([key, value]) => `${key}: ${typeof value === 'object' ? JSON.stringify(value) : value}`).join('<br>'); }
        tr.innerHTML = `<td class="border p-2 whitespace-nowrap">${log.log_timestamp}</td><td class="border p-2">${log.user_username || '-'}</td><td class="border p-2">${log.action_type || '-'}</td><td class="border p-2" style="word-break: break-all; max-width: 300px; overflow-wrap: break-word;">${detailsFormatted}</td>`;
        tbody.appendChild(tr);
    });
    activityLogTableContainer.appendChild(table);
}

function handleLogin() {
    const username = usernameInput.value.trim(); const password = passwordInput.value.trim();
    if (!username || !password) { showLoginError("Kullanıcı adı ve şifre boş bırakılamaz."); return; }
    loginError.textContent = ''; showLoading("Giriş yapılıyor..."); sendMessageToServer('login', { username, password });
}
function handleLogout() { confirmExitAppModal.classList.add('active'); }
function performLogout() {
    localStorage.removeItem('adisyonUser'); sendMessageToServer('logout', {});
    appState.user = null; appState.tables = initializeClientTables(); appState.products = staticProducts; // Sabit kodluya dön
    appState.currentTableId = null; initialDataRendered = false; showLoginScreen();
    renderInitialDataIfNeeded(); renderTables(); // UI'ı sıfırlanmış/sabit kodlu verilerle güncelle
    console.log("Çıkış yapıldı ve oturum temizlendi.");
    if (window.Android && typeof window.Android.closeApp === 'function') window.Android.closeApp();
    else console.log("Uygulama kapatma simüle edildi (tarayıcı ortamı).");
}
function showTablesView() {
    [orderPageContainer, quickSaleModal, addProductToMenuModal, editProductModal, manageTablesModal, manageWaitersModal, receiptModal, confirmCloseTableModal, confirmDiscountModal, salesReportModal, activityLogModal, confirmDeleteTableModal, confirmDeleteWaiterModal, confirmExitAppModal].forEach(el => el.classList.remove('active'));
    appContainer.classList.remove('hidden'); appContainer.classList.add('block');
    appState.currentTableId = null; resetCurrentOrderDiscount(); console.log("Masalar ekranına dönüldü.");
}
function selectTableForOrder(tableId) {
    appState.currentTableId = tableId; const table = appState.tables.find(t => t.id === tableId);
    if (table) {
        orderPageTableName.textContent = table.name; resetCurrentOrderDiscount(); renderOrderPageForTable(table);
        updateUIForRole(); appContainer.classList.add('hidden'); orderPageContainer.classList.add('active');
    } else { console.error("Seçilen masa bulunamadı:", tableId); showTablesView(); }
}
function addManualProduct() {
    const name = manualProductName.value.trim(); const category = manualProductCategory.value; const price = parseFloat(manualProductPrice.value); const quantity = parseInt(manualProductQuantity.value); const description = manualProductDescription.value.trim();
    if (!name || !category || isNaN(price) || price < 0 || isNaN(quantity) || quantity <= 0 || !appState.currentTableId) { alert("Lütfen geçerli bir ürün adı, kategori, fiyat ve adet girin."); return; }
    if (appState.user && appState.user.role !== 'cashier') { alert("Manuel ürün ekleme yetkiniz yok."); return; }
    showLoading("Manuel ürün ekleniyor..."); sendMessageToServer('add_manual_order_item', { tableId: appState.currentTableId, name: name, category: category, price: price, quantity: quantity, description: description });
    resetCurrentOrderDiscount(); [manualProductName, manualProductCategory, manualProductPrice, manualProductDescription].forEach(el => el.value = ''); manualProductQuantity.value = '1';
}
function removeItemFromOrderPage(productIdToRemove, descriptionToRemove, nameToRemove) {
    if (!appState.currentTableId) return; showLoading("Ürün siparişten siliniyor...");
    sendMessageToServer('remove_order_item', { tableId: appState.currentTableId, productId: productIdToRemove === 'manual' ? null : parseInt(productIdToRemove), name: productIdToRemove === 'manual' ? nameToRemove : null, description: descriptionToRemove });
    resetCurrentOrderDiscount();
}
function handleShowReceipt() {
    const table = appState.tables.find(t => t.id === appState.currentTableId);
    if (!table || !table.order || table.order.length === 0) { alert("Masada fiş kesilecek sipariş bulunmuyor."); return; }
    const finalTotal = appState.currentOrderDiscountAmount > 0 ? (appState.currentOrderOriginalTotal - appState.currentOrderDiscountAmount) : appState.currentOrderOriginalTotal;
    prepareAndShowReceipt(table.order, table.name, table.waiterUsername, appState.currentOrderOriginalTotal, finalTotal);
}
function handleFinalizeAndCloseTable() {
    if (appState.currentTableId && appState.user && appState.user.role === 'cashier') {
        const table = appState.tables.find(t => t.id === appState.currentTableId);
        if (table && table.order && table.order.length > 0) { confirmCloseTableModal.classList.add('active'); }
        else { alert("Masada kapatılacak sipariş bulunmuyor. Önce sipariş ekleyin."); }
    } else { alert("Masayı kapatma yetkiniz yok veya masa seçili değil."); }
}
function handleApplyDiscount(isForQuickSale = false) {
    if (appState.user && appState.user.role === 'cashier') {
        let orderLength = 0;
        if (isForQuickSale) orderLength = appState.currentQuickSaleOrder.length;
        else if (appState.currentTableId) { const table = appState.tables.find(t => t.id === appState.currentTableId); if (table && table.order) orderLength = table.order.length; }
        if (orderLength > 0) { confirmDiscountModal.classList.add('active'); }
        else { alert("İndirim uygulanacak sipariş/sepet bulunmuyor."); }
    } else { alert("İndirim uygulama yetkiniz yok."); }
}
function resetCurrentOrderDiscount() {
    appState.currentOrderDiscountAmount = 0;
    if (discountInfoDiv) { discountInfoDiv.classList.add('hidden'); discountInfoDiv.textContent = ''; }
    if (quickSaleDiscountInfo) { quickSaleDiscountInfo.classList.add('hidden'); quickSaleDiscountInfo.textContent = ''; }
    if (orderPageContainer.classList.contains('active') && appState.currentTableId) { const table = appState.tables.find(t => t.id === appState.currentTableId); if (table) renderOrderPageForTable(table); }
    if (quickSaleModal.classList.contains('active')) renderQuickSaleOrder();
}
function openQuickSaleModal() {
    if (appState.user && appState.user.role === 'cashier') {
        appState.currentQuickSaleOrder = []; resetCurrentOrderDiscount(); renderQuickSaleOrder(); renderProductGrid(quickSaleProductGrid, true);
        quickSaleModal.classList.add('active'); appContainer.classList.add('hidden'); orderPageContainer.classList.remove('active');
    } else { alert("Bu özelliği kullanma yetkiniz yok."); }
}
function completeQuickSale() {
    if (appState.currentQuickSaleOrder.length === 0) { alert("Hızlı satış sepeti boş."); return; }
    showLoading("Hızlı satış tamamlanıyor...");
    const finalTotal = appState.currentOrderDiscountAmount > 0 ? (appState.currentOrderOriginalTotal - appState.currentOrderDiscountAmount) : appState.currentOrderOriginalTotal;
    sendMessageToServer('complete_quick_sale', { items: appState.currentQuickSaleOrder, cashierUsername: appState.user.username, originalTotal: appState.currentOrderOriginalTotal, discountAmount: appState.currentOrderDiscountAmount, finalTotal: finalTotal });
    prepareAndShowReceipt(appState.currentQuickSaleOrder, "Hızlı Satış", appState.user.username, appState.currentOrderOriginalTotal, finalTotal);
}
function prepareAndShowReceipt(orderItems, tableName, waiterName, originalTotal, finalTotalWithDiscount) {
    receiptDate.textContent = getCurrentFormattedDate(); receiptTableName.textContent = tableName; receiptWaiterName.textContent = waiterName || (appState.user ? appState.user.username : "Bilinmiyor");
    receiptItems.innerHTML = '';
    orderItems.forEach(item => {
        let itemName = item.name || 'Bilinmeyen Ürün'; let itemPrice = parseFloat(item.priceAtOrder) || 0;
        const productDetails = appState.products.find(p => String(p.id) === String(item.productId)); if(productDetails && !item.name) itemName = productDetails.name;
        let descriptionHTML = item.description ? `<span class="item-description">(${item.description})</span>` : '';
        let itemWaiterHTML = item.waiterUsername && tableName !== "Hızlı Satış" ? `<span class="item-waiter">Ekleyen: ${item.waiterUsername} (${formatTimestamp(item.timestamp)})</span>` : '';
        const itemDiv = document.createElement('div'); itemDiv.innerHTML = `<span class="item-details">${item.quantity}x ${itemName} ${descriptionHTML} ${itemWaiterHTML}</span><span class="item-price">${formatPrice(item.quantity * itemPrice)}</span>`;
        receiptItems.appendChild(itemDiv);
    });
    if (finalTotalWithDiscount < originalTotal && originalTotal > 0) {
        receiptSubtotal.textContent = formatPrice(originalTotal); receiptDiscountAmount.textContent = formatPrice(originalTotal - finalTotalWithDiscount); receiptGrandTotal.textContent = formatPrice(finalTotalWithDiscount); receiptDiscountInfo.classList.remove('hidden');
    } else { receiptGrandTotal.textContent = formatPrice(originalTotal); receiptDiscountInfo.classList.add('hidden'); }
    receiptModal.classList.add('active');
}
function handlePrintReceipt() { window.print(); }
function openSalesReport() { if (appState.user && appState.user.role === 'cashier') { showLoading("Satış raporu yükleniyor..."); sendMessageToServer('get_sales_report', {}); salesReportModal.classList.add('active'); } else { alert("Bu özelliği kullanma yetkiniz yok."); } }
function printSalesReport() { window.print(); }
function openActivityLogModal() { if (appState.user && appState.user.role === 'cashier') { showLoading("Aktivite logları yükleniyor..."); sendMessageToServer('get_activity_log', {}); activityLogModal.classList.add('active'); } else { alert("Bu özelliği kullanma yetkiniz yok."); } }
function closeReceiptModalOnly() {
    receiptModal.classList.remove('active'); const isQuickSaleReceipt = receiptTableName.textContent === "Hızlı Satış";
    const currentTable = appState.tables.find(t => t.id === appState.currentTableId);
    if (isQuickSaleReceipt) { appState.currentQuickSaleOrder = []; resetCurrentOrderDiscount(); quickSaleModal.classList.remove('active'); showTablesView(); }
    else if (currentTable && currentTable.status === 'boş') { resetCurrentOrderDiscount(); showTablesView(); }
}
function openAddProductToMenuModal() { if (appState.user && appState.user.role === 'cashier') { addProductToMenuModal.classList.add('active'); populateNewProductCategorySelect(); [newProductNameInput, newProductPriceInput, newProductCategoryInput].forEach(el => el.value = ''); newProductCategorySelect.value = ''; newProductCategoryInput.classList.add('hidden'); } else { alert("Bu özelliği kullanma yetkiniz yok."); } }
function handleSaveNewProduct() {
    const name = newProductNameInput.value.trim(); const price = parseFloat(newProductPriceInput.value); let category = newProductCategorySelect.value; const newCategoryName = newProductCategoryInput.value.trim().toUpperCase();
    if (category === 'YENI') { if (!newCategoryName) { alert("Lütfen yeni kategori adını girin."); return; } category = newCategoryName; }
    if (!name || isNaN(price) || price < 0 || !category) { alert("Lütfen geçerli ürün adı, fiyat ve kategori girin/seçin."); return; }
    showLoading("Yeni ürün menüye ekleniyor..."); sendMessageToServer('add_product_to_main_menu', { name: name, price: price, category: category }); addProductToMenuModal.classList.remove('active');
}
function openEditProductModal() { if (appState.user && appState.user.role === 'cashier') { populateSelectProductToEdit(); editProductFormDiv.classList.add('hidden'); editProductModal.classList.add('active'); } else { alert("Bu özelliği kullanma yetkiniz yok."); } }
function populateSelectProductToEdit() {
    selectProductToEdit.innerHTML = '<option value="">-- Düzenlenecek Ürünü Seçin --</option>';
    appState.products.sort((a,b) => a.name.localeCompare(b.name, 'tr')).forEach(product => { const option = document.createElement('option'); option.value = product.id; option.textContent = `${product.name} (${product.category || 'Kategorisiz'}) - ${formatPrice(product.price)}`; selectProductToEdit.appendChild(option); });
}
selectProductToEdit.addEventListener('change', () => {
    const productId = parseInt(selectProductToEdit.value);
    if (productId) {
        const product = appState.products.find(p => p.id === productId);
        if (product) {
            editingProductIdInput.value = product.id; editProductNameInput.value = product.name; editProductPriceInput.value = product.price.toFixed(2);
            populateEditProductCategorySelect(); editProductCategorySelect.value = product.category || '';
            editProductCategoryInput.classList.toggle('hidden', product.category && editProductCategorySelect.querySelector(`option[value="${product.category}"]`));
            if (!editProductCategorySelect.value && product.category) { editProductCategorySelect.value = "YENI_EDIT"; editProductCategoryInput.value = product.category; editProductCategoryInput.classList.remove('hidden'); }
            else { editProductCategoryInput.value = ''; editProductCategoryInput.classList.add('hidden'); }
            editProductFormDiv.classList.remove('hidden');
        }
    } else { editProductFormDiv.classList.add('hidden'); }
});
function handleSaveEditedProduct() {
    const productId = parseInt(editingProductIdInput.value); const name = editProductNameInput.value.trim(); const price = parseFloat(editProductPriceInput.value); let category = editProductCategorySelect.value; const newCategoryName = editProductCategoryInput.value.trim().toUpperCase();
    if (category === 'YENI_EDIT') { if (!newCategoryName) { alert("Lütfen yeni kategori adını girin."); return; } category = newCategoryName; }
    if (!productId || !name || isNaN(price) || price < 0 || !category) { alert("Lütfen tüm alanları doğru bir şekilde doldurun."); return; }
    showLoading("Ürün güncelleniyor..."); sendMessageToServer('update_main_menu_product', { id: productId, name: name, price: price, category: category }); editProductModal.classList.remove('active');
}
function openManageTablesModal() { if (appState.user && appState.user.role === 'cashier') { populateTableSelectsForManagement(); manageTablesModal.classList.add('active'); } else { alert("Bu özelliği kullanma yetkiniz yok."); } }
function populateTableSelectsForManagement() {
    [selectTableToEditName, selectTableToDelete].forEach(select => { select.innerHTML = `<option value="">-- ${select === selectTableToEditName ? 'Düzenlenecek' : 'Silinecek'} Masayı Seçin --</option>`; appState.tables.sort((a,b)=> a.name.localeCompare(b.name, 'tr')).forEach(table => { const option = document.createElement('option'); option.value = table.id; option.textContent = table.name; select.appendChild(option.cloneNode(true)); }); });
    editTableNameInput.value = ''; newTableNameInput.value = '';
}
function handleAddNewTable() { const newName = newTableNameInput.value.trim(); if (!newName) { alert("Lütfen yeni masa adı girin."); return; } showLoading("Yeni masa ekleniyor..."); sendMessageToServer('add_table', { name: newName }); newTableNameInput.value = ''; }
function handleUpdateTableName() { const tableId = selectTableToEditName.value; const newName = editTableNameInput.value.trim(); if (!tableId) { alert("Lütfen düzenlenecek masayı seçin."); return; } if (!newName) { alert("Lütfen yeni masa adını girin."); return; } showLoading("Masa adı güncelleniyor..."); sendMessageToServer('edit_table_name', { tableId: tableId, newName: newName }); }
function handleDeleteTable() { const tableId = selectTableToDelete.value; if (!tableId) { alert("Lütfen silinecek masayı seçin."); return; } const table = appState.tables.find(t => t.id === tableId); if (table) { tableNameToDeleteSpan.textContent = table.name; confirmDeleteTableModal.classList.add('active'); } }
function openManageWaitersModal() { if (appState.user && appState.user.role === 'cashier') { sendMessageToServer('get_waiters_list', {}); manageWaitersModal.classList.add('active'); } else { alert("Bu özelliği kullanma yetkiniz yok."); } }
function populateWaiterSelectsForManagement() {
    [selectWaiterToEditPassword, selectWaiterToDelete].forEach(select => { select.innerHTML = `<option value="">-- ${select === selectWaiterToEditPassword ? 'Düzenlenecek' : 'Silinecek'} Garsonu Seçin --</option>`; appState.waiters.sort((a,b)=> a.username.localeCompare(b.username, 'tr')).forEach(waiter => { const option = document.createElement('option'); option.value = waiter.id; option.textContent = waiter.username; select.appendChild(option.cloneNode(true)); }); });
    [newWaiterUsernameInput, newWaiterPasswordInput, editWaiterPasswordInput].forEach(el => el.value = '');
}
function handleAddNewWaiter() { const username = newWaiterUsernameInput.value.trim(); const password = newWaiterPasswordInput.value.trim(); if (!username || !password) { alert("Lütfen garson kullanıcı adı ve şifresini girin."); return; } showLoading("Yeni garson ekleniyor..."); sendMessageToServer('add_waiter', { username, password }); }
function handleUpdateWaiterPassword() { const waiterId = selectWaiterToEditPassword.value; const newPassword = editWaiterPasswordInput.value.trim(); if (!waiterId) { alert("Lütfen şifresi düzenlenecek garsonu seçin."); return; } if (!newPassword) { alert("Lütfen yeni şifreyi girin."); return; } showLoading("Garson şifresi güncelleniyor..."); sendMessageToServer('edit_waiter_password', { userId: parseInt(waiterId), newPassword: newPassword }); }
let waiterIdToDelete = null;
function handleDeleteWaiter() { const selectedWaiterId = selectWaiterToDelete.value; if (!selectedWaiterId) { alert("Lütfen silinecek garsonu seçin."); return; } const waiter = appState.waiters.find(w => String(w.id) === String(selectedWaiterId)); if (waiter) { waiterIdToDelete = waiter.id; waiterNameToDeleteSpan.textContent = waiter.username; confirmDeleteWaiterModal.classList.add('active'); } }

loginButton.addEventListener('click', handleLogin);
passwordInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleLogin(); });
logoutButton.addEventListener('click', handleLogout);
confirmExitAppYesButton.addEventListener('click', () => { performLogout(); confirmExitAppModal.classList.remove('active'); });
confirmExitAppNoButton.addEventListener('click', () => confirmExitAppModal.classList.remove('active'));
salesReportButton.addEventListener('click', openSalesReport);
activityLogButton.addEventListener('click', openActivityLogModal);
quickSaleEntryButton.addEventListener('click', openQuickSaleModal);
addProductToMenuButton.addEventListener('click', openAddProductToMenuModal);
editProductMenuButton.addEventListener('click', openEditProductModal);
manageTablesButton.addEventListener('click', openManageTablesModal);
manageWaitersButton.addEventListener('click', openManageWaitersModal);
closeAddProductToMenuModalButton.addEventListener('click', () => addProductToMenuModal.classList.remove('active'));
saveNewProductButton.addEventListener('click', handleSaveNewProduct);
closeEditProductModalButton.addEventListener('click', () => editProductModal.classList.remove('active'));
saveEditedProductButton.addEventListener('click', handleSaveEditedProduct);
closeManageTablesModalButton.addEventListener('click', () => manageTablesModal.classList.remove('active'));
addNewTableButton.addEventListener('click', handleAddNewTable);
updateTableNameButton.addEventListener('click', handleUpdateTableName);
deleteTableButton.addEventListener('click', handleDeleteTable);
confirmDeleteTableYesButton.addEventListener('click', () => { const tableId = selectTableToDelete.value; if (tableId) { showLoading("Masa siliniyor..."); sendMessageToServer('delete_table', { tableId: tableId }); } confirmDeleteTableModal.classList.remove('active'); });
confirmDeleteTableNoButton.addEventListener('click', () => confirmDeleteTableModal.classList.remove('active'));
closeManageWaitersModalButton.addEventListener('click', () => manageWaitersModal.classList.remove('active'));
addNewWaiterButton.addEventListener('click', handleAddNewWaiter);
updateWaiterPasswordButton.addEventListener('click', handleUpdateWaiterPassword);
deleteWaiterButton.addEventListener('click', handleDeleteWaiter);
confirmDeleteWaiterYesButton.addEventListener('click', () => { if (waiterIdToDelete) { showLoading("Garson siliniyor..."); sendMessageToServer('delete_waiter', { userId: waiterIdToDelete }); waiterIdToDelete = null; } confirmDeleteWaiterModal.classList.remove('active'); });
confirmDeleteWaiterNoButton.addEventListener('click', () => { waiterIdToDelete = null; confirmDeleteWaiterModal.classList.remove('active'); });
closeQuickSaleModalButton.addEventListener('click', () => { quickSaleModal.classList.remove('active'); resetCurrentOrderDiscount(); showTablesView(); });
completeQuickSaleButton.addEventListener('click', completeQuickSale);
applyQuickSaleDiscountButton.addEventListener('click', () => handleApplyDiscount(true));
backToTablesButton.addEventListener('click', showTablesView);
addManualProductButton.addEventListener('click', addManualProduct);
showReceiptButton.addEventListener('click', handleShowReceipt);
finalizeAndCloseTableButton.addEventListener('click', handleFinalizeAndCloseTable);
applyDiscountButton.addEventListener('click', () => handleApplyDiscount(false));
printReceiptButton.addEventListener('click', handlePrintReceipt);
closeReceiptModalOnlyButton.addEventListener('click', closeReceiptModalOnly);
confirmCloseTableYesButton.addEventListener('click', () => { if (appState.currentTableId && appState.user && appState.user.role === 'cashier') { showLoading("Masa kapatılıyor ve hesap tamamlanıyor..."); sendMessageToServer('close_table', { tableId: appState.currentTableId }); resetCurrentOrderDiscount(); } confirmCloseTableModal.classList.remove('active'); });
confirmCloseTableNoButton.addEventListener('click', () => confirmCloseTableModal.classList.remove('active'));
confirmDiscountYesButton.addEventListener('click', () => {
    let originalTotalForDiscount = appState.currentOrderOriginalTotal;
    let targetDiscountInfoDiv = quickSaleModal.classList.contains('active') ? quickSaleDiscountInfo : discountInfoDiv;
    let targetTotalDisplayElement = quickSaleModal.classList.contains('active') ? quickSaleTotal : orderPageCurrentOrderTotal;
    if (originalTotalForDiscount > 0 && targetTotalDisplayElement) {
        const discountAmount = originalTotalForDiscount * 0.30; appState.currentOrderDiscountAmount = discountAmount;
        const discountedTotal = originalTotalForDiscount - discountAmount;
        targetTotalDisplayElement.textContent = `Toplam: ${formatPrice(discountedTotal)} (İndirimli)`;
        if(targetDiscountInfoDiv) { targetDiscountInfoDiv.textContent = `İndirim Uygulandı: -${formatPrice(discountAmount)}`; targetDiscountInfoDiv.classList.remove('hidden'); }
        console.log("Personel indirimi uygulandı. Yeni toplam:", discountedTotal);
    }
    confirmDiscountModal.classList.remove('active');
});
confirmDiscountNoButton.addEventListener('click', () => confirmDiscountModal.classList.remove('active'));
closeSalesReportModalButton.addEventListener('click', () => salesReportModal.classList.remove('active'));
refreshSalesReportButton.addEventListener('click', () => { showLoading("Satış raporu güncelleniyor..."); sendMessageToServer('get_sales_report', {}); });
printSalesReportButton.addEventListener('click', printSalesReport);
closeActivityLogModalButton.addEventListener('click', () => activityLogModal.classList.remove('active'));
refreshActivityLogButton.addEventListener('click', () => { showLoading("Aktivite logları güncelleniyor..."); sendMessageToServer('get_activity_log', {}); });

document.addEventListener('DOMContentLoaded', () => {
    connectWebSocket();
    // Sabit kodlu verilerle ilk render'ı DOMContentLoaded içinde yapabiliriz,
    // WebSocket bağlantısı kurulmasını beklemeden temel UI'ı göstermek için.
    renderInitialDataIfNeeded();
    renderTables();
});

</script>
</body>
</html>
